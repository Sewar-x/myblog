# VueCliæºç åˆ†æž

## **æ˜¯ä»€ä¹ˆ**

Vue CLIï¼ˆVue Command Line Interfaceï¼‰æ˜¯ä¸€ä¸ªå®˜æ–¹æä¾›çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºŽå¿«é€Ÿæ­å»ºå’Œç®¡ç†Vue.jsé¡¹ç›®ã€‚

å®ƒæä¾›äº†ä¸€æ•´å¥—å®Œæ•´çš„å¼€å‘è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ä»£ç æž„å»ºã€çƒ­æ›´æ–°ã€ä»£ç åˆ†å‰²ã€ä»£ç åŽ‹ç¼©ã€ç‰ˆæœ¬æŽ§åˆ¶ç­‰åŠŸèƒ½ï¼Œå¤§å¤§ç®€åŒ–äº†Vue.jsé¡¹ç›®çš„å¼€å‘è¿‡ç¨‹ã€‚

## **ä¸ºä»€ä¹ˆ**

åœ¨å¼€å‘Vue.jsé¡¹ç›®æ—¶ï¼Œå¦‚æžœæ²¡æœ‰ä¸€ä¸ªç»Ÿä¸€çš„æž„å»ºå·¥å…·ï¼Œå¼€å‘äººå‘˜éœ€è¦æ‰‹åŠ¨é…ç½®å„ç§å·¥å…·å’Œæ’ä»¶ï¼Œè¿™ä¸ä»…æµªè´¹æ—¶é—´ï¼Œè¿˜å®¹æ˜“å‡ºé”™ã€‚

è€ŒVue CLIä½œä¸ºå®˜æ–¹çš„æž„å»ºå·¥å…·ï¼Œæä¾›äº†é¢„å…ˆé…ç½®å¥½çš„æœ€ä½³å®žè·µï¼Œä½¿å¾—å¼€å‘äººå‘˜å¯ä»¥ä¸“æ³¨äºŽç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸æ˜¯èŠ±è´¹å¤§é‡æ—¶é—´åœ¨é…ç½®ä¸Šã€‚

Vue CLIè¿˜å¯ä»¥è‡ªåŠ¨åŒ–å¤„ç†è®¸å¤šç¹ççš„ä»»åŠ¡ï¼Œå¦‚ä»£ç åŽ‹ç¼©ã€çƒ­æ›´æ–°ç­‰ï¼Œä»Žè€Œæé«˜å¼€å‘æ•ˆçŽ‡ã€‚





## **Vue-cli é›†æˆæ’ä»¶/åº“**

| æŠ€æœ¯           | ä½œç”¨                                                         |
| :------------- | :----------------------------------------------------------- |
| Vue.js         | ç”¨äºŽæž„å»ºç”¨æˆ·ç•Œé¢çš„æµè¡ŒJavaScriptå‰ç«¯æ¡†æž¶                     |
| Webpack        | é™æ€æ¨¡å—æ‰“åŒ…å·¥å…·ï¼Œå¤„ç†é¡¹ç›®ä¸­çš„èµ„æºæ–‡ä»¶å¹¶æ‰“åŒ…æˆå¯ç”¨çš„æ–‡ä»¶     |
| Babel          | JavaScript ç¼–è¯‘å™¨ï¼Œå°†ES6+ä»£ç è½¬æ¢ä¸ºå‘åŽå…¼å®¹çš„JavaScriptç‰ˆæœ¬  |
| ESLint         | å¯æ’æ‹”çš„JavaScriptä»£ç æ£€æŸ¥å·¥å…·ï¼Œå¸®åŠ©ä¿æŒä¸€è‡´çš„ä»£ç é£Žæ ¼å’Œå‘çŽ°æ½œåœ¨é—®é¢˜ |
| Vue Router     | Vue.jså®˜æ–¹æä¾›çš„è·¯ç”±ç®¡ç†å™¨ï¼Œç”¨äºŽæž„å»ºå•é¡µåº”ç”¨ç¨‹åºçš„è·¯ç”±ç³»ç»Ÿ   |
| Vuex           | Vue.jså®˜æ–¹æä¾›çš„çŠ¶æ€ç®¡ç†åº“ï¼Œç”¨äºŽç®¡ç†åº”ç”¨ç¨‹åºçš„å…¨å±€çŠ¶æ€       |
| Axios          | ç”¨äºŽå‘èµ· GET ã€æˆ– POST ç­‰ httpè¯·æ±‚ï¼ŒåŸºäºŽ Promise è®¾è®¡        |
| Jest           | å•å…ƒæµ‹è¯•æ¡†æž¶ï¼Œç”¨äºŽç¼–å†™å’Œè¿è¡Œå•å…ƒæµ‹è¯•                         |
| Cypress        | ç«¯åˆ°ç«¯æµ‹è¯•æ¡†æž¶ï¼Œç”¨äºŽç¼–å†™å’Œè¿è¡Œæ•´ä¸ªåº”ç”¨ç¨‹åºçš„ç«¯åˆ°ç«¯æµ‹è¯•       |
| Sass           | CSSé¢„å¤„ç†å™¨ï¼Œå¢žå¼ºCSSçš„ç¼–ç¨‹èƒ½åŠ›å’Œå¯ç»´æŠ¤æ€§                     |
| Less           | CSSé¢„å¤„ç†å™¨ï¼Œå¢žå¼ºCSSçš„ç¼–ç¨‹èƒ½åŠ›å’Œå¯ç»´æŠ¤æ€§                     |
| Prettier       | ä»£ç æ ¼å¼åŒ–å·¥å…·ï¼Œç”¨äºŽè‡ªåŠ¨æ ¼å¼åŒ–ä»£ç                            |
| ä»£ç åˆ†å‰²       | å°†ä»£ç æ‹†åˆ†æˆå¤šä¸ªå°å—ï¼Œå®žçŽ°æŒ‰éœ€åŠ è½½å’Œæé«˜åº”ç”¨ç¨‹åºæ€§èƒ½         |
| æ‡’åŠ è½½         | å»¶è¿ŸåŠ è½½é¡µé¢ä¸­çš„èµ„æºï¼Œæé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½                     |
| `emit.js` æ–‡ä»¶ | ç”¨äºŽ vue äº‹ä»¶æœºåˆ¶çš„ç®¡ç†                                      |





## åˆ›å»ºé¡¹ç›®è¿‡ç¨‹åˆ†æž

### **å®‰è£… Vue-Cli**

å¯ä»¥ä½¿ç”¨ä¸‹åˆ—ä»»ä¸€å‘½ä»¤å®‰è£…è¿™ä¸ªæ–°çš„åŒ…ï¼š

```shell
npm install -g @vue/cli
# OR
yarn global add @vue/cli
```

å®‰è£…ä¹‹åŽï¼Œä½ å°±å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­è®¿é—® `vue` å‘½ä»¤ã€‚

ä»¥ä¸Šé€šè¿‡å…¨å±€å®‰è£… `vue-cli`ï¼Œé»˜è®¤æƒ…å†µä¸‹ windows ä¼šå®‰è£…åˆ° `C:\Users\{{YourUserName}}\AppData\Roaming\npm\node_modules\@vue\cli` ç›®å½•ä¸­;

### **å‘½ä»¤è§£æž**

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ï¼š(è¯¦ç»†å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š[åˆ›å»ºä¸€ä¸ªé¡¹ç›® | Vue CLI (vuejs.org)](https://cli.vuejs.org/zh/guide/creating-a-project.html#vue-create))

```shell
vue create hello-world
```

> `vue create` å‘½ä»¤åœ¨ Windows ä¸‹çš„è§£æžæµç¨‹å¸¸åœ¨ç”¨æˆ·æ‰§è¡Œå‘½ä»¤æ—¶è‡ªåŠ¨è¿›è¡Œï¼š
>
> 1. **å‘½ä»¤è¡Œè¾“å…¥**ï¼šå½“ä½ åœ¨å‘½ä»¤æç¤ºç¬¦ï¼ˆCommand Promptï¼‰æˆ– PowerShell ä¸­è¾“å…¥ `vue create` å‘½ä»¤æ—¶ï¼Œé¦–å…ˆä¼šæ£€æŸ¥ç³»ç»ŸçŽ¯å¢ƒå˜é‡ä¸­å®šä¹‰çš„å…¨å±€å®‰è£…åŒ…ç›®å½•ã€‚
> 2. **çŽ¯å¢ƒå˜é‡æŸ¥æ‰¾**ï¼šWindows ä¼šæ£€æŸ¥ç³»ç»Ÿçš„ `PATH` çŽ¯å¢ƒå˜é‡ä¸­åˆ—å‡ºçš„ç›®å½•ï¼Œå¯»æ‰¾ `@vue/cli` çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚åœ¨å…¨å±€å®‰è£… npm åŒ…æ—¶ï¼Œé€šå¸¸ä¼šå°†åŒ…çš„ bin ç›®å½•æ·»åŠ åˆ°ç³»ç»Ÿçš„ PATH ä¸­ã€‚
> 3. **å…¨å±€å®‰è£…åŒ…ç›®å½•**ï¼šæ‰¾åˆ° `@vue/cli` çš„å®‰è£…ä½ç½®åŽï¼Œç³»ç»Ÿä¼šåœ¨è¯¥ç›®å½•ä¸‹çš„ `bin` å­ç›®å½•ä¸­æŸ¥æ‰¾åä¸º `vue` çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚
> 4. **æ‰§è¡Œæ–‡ä»¶å…³è”**ï¼šä¸€æ—¦æ‰¾åˆ° `vue` å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç³»ç»Ÿä¼šå°†å…¶ä¸Ž `vue create` å‘½ä»¤å…³è”èµ·æ¥ã€‚è¿™æ„å‘³ç€å½“ä½ è¾“å…¥ `vue create` æ—¶ï¼Œå®žé™…ä¸Šæ˜¯åœ¨æ‰§è¡Œè¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚
> 5. **å‘½ä»¤æ‰§è¡Œ**ï¼š`vue` å¯æ‰§è¡Œæ–‡ä»¶ä¼šæŽ¥æ”¶åˆ° `create` å‘½ä»¤åŠå…¶åŽç»­å‚æ•°ï¼ˆä¾‹å¦‚ `hello-world`ï¼‰ï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚è¿™é€šå¸¸æ¶‰åŠå¯åŠ¨ä¸€ä¸ªè„šæœ¬æ¥åˆ›å»ºæ–°çš„ Vue é¡¹ç›®ã€‚
> 6. **å­è¿›ç¨‹è°ƒç”¨**ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œ`vue create` å‘½ä»¤å¯èƒ½ä¼šé€šè¿‡å­è¿›ç¨‹è°ƒç”¨å…¶ä»–å·¥å…·æˆ–è„šæœ¬ï¼Œå¦‚ `yarn` æˆ– `npm`ï¼Œæ¥å®‰è£…é¡¹ç›®çš„ä¾èµ–é¡¹æˆ–æ‰§è¡Œå…¶ä»–åˆå§‹åŒ–ä»»åŠ¡ã€‚
> 7. **è¾“å‡ºä¸Žåé¦ˆ**ï¼šå‘½ä»¤çš„æ‰§è¡Œç»“æžœï¼ˆå¦‚æˆåŠŸåˆ›å»ºé¡¹ç›®æˆ–é‡åˆ°é”™è¯¯ï¼‰ä¼šæ˜¾ç¤ºåœ¨å‘½ä»¤è¡Œç•Œé¢ä¸Šï¼Œä¸ºç”¨æˆ·æä¾›åé¦ˆã€‚

å½“è¿è¡Œ `vue create` å‘½ä»¤æ—¶ï¼Œé»˜è®¤ä¼šæ‰§è¡Œå®‰è£…çš„ `vue-cli` é¡¹ç›®ä¸‹çš„ `/bin/vue.js` æ–‡ä»¶ï¼ˆä»¥ä¸‹æ˜¯å…¨å±€å®‰è£…çš„ `vue-cli` é¡¹ç›®ç›®å½•ï¼‰ï¼š

![image-20240131164539288](../images/vue-cli.png)

> `/bin/vue.js` æ–‡ä»¶æ‰§è¡Œæµç¨‹ï¼š
>
> 1. æ£€æŸ¥ Node.js ç‰ˆæœ¬ï¼›
>
> 2. å®šä¹‰æ‰€æœ‰ vue å‘½ä»¤;
>
>    * vue ä½¿ç”¨ commander åº“å®šä¹‰å‘½ä»¤çš„é…ç½®é¡¹ï¼Œå¹¶åœ¨é…ç½®ä¸­æŒ‡æ˜Žå‘½ä»¤çš„æ‰§è¡Œæ–‡ä»¶ï¼›
>
>    * `vue create` å‘½ä»¤åœ¨æ–‡ä»¶ä¸­çš„å®šä¹‰å’Œæ‰§è¡Œè·¯å¾„å¦‚ä¸‹ï¼š
>
>      ![image-20240131170240448](../images/vue-createæ–‡ä»¶æ‰§è¡Œ.png)
>
> 3. è§£æž shell å‘½ä»¤ï¼Œå¹¶æ ¹æ®å‘½ä»¤æ‰§è¡Œè·¯å¾„æ‰§è¡Œå‘½ä»¤ï¼›

### **`vue create` å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹**

1. ç»ˆç«¯è¾“å…¥`vue create vue-test-app`;
2. ç»ˆç«¯è§£æžå‡º`vue`ä¸»å‘½ä»¤;
3. ç»ˆç«¯åœ¨çŽ¯å¢ƒå˜é‡ä¸­æ‰¾åˆ°`vue`å‘½ä»¤;
4. ç»ˆç«¯æ ¹æ®`vue`å‘½ä»¤é“¾æŽ¥åˆ°å®žé™…å¯æ‰§è¡Œæ–‡ä»¶vue.js;
5. ç»ˆç«¯åˆ©ç”¨ node æ‰§è¡Œ vue.js;
6. vue.js è§£æž command å’Œ option;
7. vue.js æ‰§è¡Œ command;
8. æ‰§è¡Œå®Œæ¯•ï¼Œé€€å‡ºæ‰§è¡Œ;

### **`vue create` å‘½ä»¤è§£æž**

æ‰§è¡Œ `vue create` å‘½ä»¤æ—¶ï¼Œæœ€ç»ˆæ˜¯è§£æž `./@vue/cli/lib/create.js` æ–‡ä»¶ï¼š

![image-20240131171951445](../images/vue-createæ–‡ä»¶åˆ†æž.png)

> `vue create` å‘½ä»¤ä¸»è¦æ‰§è¡Œä»¥ä¸‹é€»è¾‘ï¼š
>
> 1. æ£€æŸ¥è¾“å…¥çš„ projectName æ˜¯å¦ç¬¦åˆè§„èŒƒï¼›å¿…é¡»æŒ‡å®šä¸€ä¸ª `app-name `ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼›
> 2. åˆ¤æ–­ target  ç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œç„¶åŽé€šè¿‡äº¤äº’è¯¢é—®ç”¨æˆ·æ˜¯å¦è¦†ç›–ï¼ˆå¯¹åº”çš„æ˜¯æ“ä½œæ˜¯åˆ é™¤åŽŸç›®å½•;
> 3. åˆ›å»º Creator ç±»,å¹¶æ‰§è¡Œ`creator.create(options)`;

###  **Creator åˆ›å»ºé¡¹ç›®**

Creator ç±»æ˜¯ä¸»è¦åˆ›å»ºè„šæ‰‹æž¶çš„ç±»ï¼Œè¯¥ç±»å®šä¹‰å¦‚ä¸‹ï¼š

![image-20240131190642601](../images/creatorç±».png)

ç”±ä»¥ä¸Š Creator ç±»çš„å®šä¹‰ï¼Œåˆ›å»ºé¡¹ç›®çš„æ ¸å¿ƒæ–¹æ³•åœ¨ `Creator.create()` ä¸­ï¼š

```js
  // æ ¹æ®ç”¨æˆ·äº¤äº’æç¤ºåˆ›å»ºé¡¹ç›®
  async create(cliOptions = {}, preset = null) {
    // åˆ¤æ–­æ˜¯å¦æ˜¯æµ‹è¯•æˆ–è°ƒè¯•çŽ¯å¢ƒ
    const isTestOrDebug = process.env.VUE_CLI_TEST || process.env.VUE_CLI_DEBUG
    // èŽ·å– runã€nameã€contextã€afterInvokeCbsã€afterAnyInvokeCbs äº”ä¸ªå±žæ€§
    const { run, name, context, afterInvokeCbs, afterAnyInvokeCbs } = this

    // å¦‚æžœæ²¡æœ‰æä¾›presetï¼Œåˆ™æ ¹æ®cliOptionsçš„å‚æ•°æ¥å†³å®šä½¿ç”¨å“ªä¸ªpreset
    if (!preset) {
      if (cliOptions.preset) {
        // vue create foo --preset bar
        preset = await this.resolvePreset(cliOptions.preset, cliOptions.clone)
      } else if (cliOptions.default) {
        // vue create foo --default
        preset = defaults.presets.default
      } else if (cliOptions.inlinePreset) {
        // vue create foo --inlinePreset {...}
        try {
          preset = JSON.parse(cliOptions.inlinePreset)
        } catch (e) {
          error(`CLI inline preset is not valid JSON: ${cliOptions.inlinePreset}`)
          exit(1)
        }
      } else {
        // ç”¨æˆ·æ²¡æœ‰æä¾›ä»»ä½•presetï¼Œå› æ­¤å¼¹å‡ºä¸€ä¸ªæç¤ºï¼Œè®©ç”¨æˆ·é€‰æ‹©
        preset = await this.promptAndResolvePreset()
      }
    }

    // clone before mutating
    // å…‹éš†ä¸€ä»½presetï¼Œå› ä¸ºåŽé¢ä¼šä¿®æ”¹å®ƒ
    preset = cloneDeep(preset)
    // inject core service
    // æ³¨å…¥æ ¸å¿ƒæœåŠ¡
    preset.plugins['@vue/cli-service'] = Object.assign({
      projectName: name
    }, preset)

    // åˆ¤æ–­cliOptions.bareæ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™å°†preset.plugins['@vue/cli-service'].bareè®¾ç½®ä¸ºtrue
    if (cliOptions.bare) {
      preset.plugins['@vue/cli-service'].bare = true
    }

    // legacy support for router
    // åˆ¤æ–­preset.routeræ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™å°†preset.plugins['@vue/cli-plugin-router']è®¾ç½®ä¸ºç©ºå¯¹è±¡
    if (preset.router) {
      preset.plugins['@vue/cli-plugin-router'] = {}

      // åˆ¤æ–­preset.routerHistoryModeæ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™å°†preset.plugins['@vue/cli-plugin-router'].historyModeè®¾ç½®ä¸ºtrue
      if (preset.routerHistoryMode) {
        preset.plugins['@vue/cli-plugin-router'].historyMode = true
      }
    }

    // Introducing this hack because typescript plugin must be invoked after router.
    // Currently we rely on the `plugins` object enumeration order,
    // which depends on the order of the field initialization.
    // FIXME: Remove this ugly hack after the plugin ordering API settled down
    // å¦‚æžœpreset.pluginsä¸­åŒ…å«@vue/cli-plugin-routerå’Œ@vue/cli-plugin-typescriptï¼Œåˆ™åˆ é™¤@vue/cli-plugin-typescriptï¼Œå¹¶å°†@vue/cli-plugin-typescriptè®¾ç½®ä¸ºpreset.plugins['@vue/cli-plugin-typescript']
    if (preset.plugins['@vue/cli-plugin-router'] && preset.plugins['@vue/cli-plugin-typescript']) {
      const tmp = preset.plugins['@vue/cli-plugin-typescript']
      delete preset.plugins['@vue/cli-plugin-typescript']
      preset.plugins['@vue/cli-plugin-typescript'] = tmp
    }

    // legacy support for vuex
    // å¦‚æžœpreset.vuexå­˜åœ¨ï¼Œåˆ™å°†preset.plugins['@vue/cli-plugin-vuex']è®¾ç½®ä¸ºç©ºå¯¹è±¡
    if (preset.vuex) {
      preset.plugins['@vue/cli-plugin-vuex'] = {}
    }

    // åŠ è½½cliOptionsä¸­çš„packageManagerå±žæ€§ï¼Œå¦‚æžœæ²¡æœ‰åˆ™åŠ è½½optionsä¸­çš„packageManagerå±žæ€§ï¼Œ
    // å¦‚æžœæ²¡æœ‰åˆ™æ ¹æ®æ˜¯å¦æœ‰yarnï¼Œpnpm3æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œè¿”å›žå¯¹åº”çš„packageManager
    const packageManager = (
      cliOptions.packageManager ||
      loadOptions().packageManager ||
      (hasYarn() ? 'yarn' : null) ||
      (hasPnpm3OrLater() ? 'pnpm' : 'npm')
    )

    await clearConsole()
    const pm = new PackageManager({ context, forcePackageManager: packageManager })

    log(`âœ¨  Creating project in ${chalk.yellow(context)}.`)
    this.emit('creation', { event: 'creating' })

    // get latest CLI plugin version
    const { latestMinor } = await getVersions()

    // generate package.json with plugin dependencies
    const pkg = {
      name,
      version: '0.1.0',
      private: true,
      devDependencies: {},
      ...resolvePkg(context)
    }
    const deps = Object.keys(preset.plugins)
    deps.forEach(dep => {
      // è¿‡æ»¤æŽ‰ preset æ’ä»¶
      if (preset.plugins[dep]._isPreset) {
        return
      }

      let { version } = preset.plugins[dep]

      // å¦‚æžœæ²¡æœ‰æŒ‡å®šç‰ˆæœ¬ï¼Œåˆ™æ ¹æ®ä¸åŒçš„æ’ä»¶ç±»åž‹ï¼Œä½¿ç”¨ä¸åŒçš„é»˜è®¤ç‰ˆæœ¬
      if (!version) {
        if (isOfficialPlugin(dep) || dep === '@vue/cli-service' || dep === '@vue/babel-preset-env') {
          version = isTestOrDebug ? `file:${path.resolve(__dirname, '../../../', dep)}` : `~${latestMinor}`
        } else {
          version = 'latest'
        }
      }

      // æ·»åŠ åˆ°ä¾èµ–ä¸­
      pkg.devDependencies[dep] = version
    })

    // write package.json
    // å†™å…¥æ–‡ä»¶æ ‘ï¼Œcontextä¸ºä¸Šä¸‹æ–‡ï¼Œpkgä¸ºåŒ…ä¿¡æ¯
    await writeFileTree(context, {
      'package.json': JSON.stringify(pkg, null, 2)
    })

    // generate a .npmrc file for pnpm, to persist the `shamefully-flatten` flag
    if (packageManager === 'pnpm') {
      const pnpmConfig = hasPnpmVersionOrLater('4.0.0')
        ? 'shamefully-hoist=true\n'
        : 'shamefully-flatten=true\n'

      await writeFileTree(context, {
        '.npmrc': pnpmConfig
      })
    }

    if (packageManager === 'yarn' && semver.satisfies(process.version, '8.x')) {
      // Vue CLI 4.x should support Node 8.x,
      // but some dependenices already bumped `engines` field to Node 10
      // and Yarn treats `engines` field too strictly
      await writeFileTree(context, {
        '.yarnrc': '# Hotfix for Node 8.x\n--install.ignore-engines true\n'
      })
    }

    // intilaize git repository before installing deps
    // so that vue-cli-service can setup git hooks.
    // åˆ¤æ–­æ˜¯å¦åˆå§‹åŒ–gitä»“åº“
    const shouldInitGit = this.shouldInitGit(cliOptions)
    if (shouldInitGit) {
      log(`ðŸ—ƒ  Initializing git repository...`)
      this.emit('creation', { event: 'git-init' })
      await run('git init')//åˆå§‹åŒ–gitä»“åº“
    }

    // install plugins
    log(`âš™\u{fe0f}  Installing CLI plugins. This might take a while...`)
    log()
    this.emit('creation', { event: 'plugins-install' })

    // å¦‚æžœisTestOrDebugä¸ºtrueï¼Œä¸”process.env.VUE_CLI_TEST_DO_INSTALL_PLUGINä¸ºfalseï¼Œåˆ™æ‰§è¡ŒsetupDevProjectå‡½æ•°ï¼Œå¦åˆ™æ‰§è¡Œinstallå‡½æ•°
    if (isTestOrDebug && !process.env.VUE_CLI_TEST_DO_INSTALL_PLUGIN) {
      // in development, avoid installation process
      await require('./util/setupDevProject')(context)
    } else {
      await pm.install()
    }

    // run generator
    this.emit('creation', { event: 'invoking-generators' })
    // è§£æžæ’ä»¶
    const plugins = await this.resolvePlugins(preset.plugins, pkg)
    // åˆ›å»ºç”Ÿæˆå™¨
    const generator = new Generator(context, {
      pkg,
      plugins,
      afterInvokeCbs,
      afterAnyInvokeCbs
    })
    // ç”Ÿæˆæ–‡ä»¶
    await generator.generate({
      extractConfigFiles: preset.useConfigFiles
    })

    // install additional deps (injected by generators)
    log(`ðŸ“¦  Installing additional dependencies...`)
    this.emit('creation', { event: 'deps-install' })
    log()
    // åˆ¤æ–­æ˜¯å¦æ˜¯æµ‹è¯•æˆ–è€…è°ƒè¯•çŽ¯å¢ƒï¼Œæˆ–è€…VUE_CLI_TEST_DO_INSTALL_PLUGINçŽ¯å¢ƒå˜é‡æ˜¯å¦ä¸ºtrue
    if (!isTestOrDebug || process.env.VUE_CLI_TEST_DO_INSTALL_PLUGIN) {
      // å®‰è£…æ’ä»¶
      await pm.install()
    }

    // run complete cbs if any (injected by generators)
    log(`âš“  Running completion hooks...`)
    // è§¦å‘åˆ›å»ºäº‹ä»¶
    this.emit('creation', { event: 'completion-hooks' })
    // æ‰§è¡ŒafterInvokeCbsä¸­çš„å›žè°ƒå‡½æ•°
    for (const cb of afterInvokeCbs) {
      await cb()
    }
    // æ‰§è¡ŒafterAnyInvokeCbsä¸­çš„å›žè°ƒå‡½æ•°
    for (const cb of afterAnyInvokeCbs) {
      await cb()
    }
    // ç”Ÿæˆ  README.md
    if (!generator.files['README.md']) {
      // generate README.md
      log()
      log('ðŸ“„  Generating README.md...')
      await writeFileTree(context, {
        'README.md': generateReadme(generator.pkg, packageManager)
      })
    }

    // commit initial state
    let gitCommitFailed = false
    if (shouldInitGit) {
      // æ·»åŠ æ‰€æœ‰æ–‡ä»¶åˆ° git
      await run('git add -A')
      if (isTestOrDebug) {
        // è®¾ç½®æµ‹è¯•é…ç½®
        await run('git', ['config', 'user.name', 'test'])
        await run('git', ['config', 'user.email', 'test@test.com'])
        await run('git', ['config', 'commit.gpgSign', 'false'])
      }
      const msg = typeof cliOptions.git === 'string' ? cliOptions.git : 'init'
      try {
        // æäº¤
        await run('git', ['commit', '-m', msg, '--no-verify'])
      } catch (e) {
        // å¦‚æžœæäº¤å¤±è´¥ï¼Œåˆ™è®¾ç½®gitCommitFailedä¸ºtrue
        gitCommitFailed = true
      }
    }

    // log instructions
    log()
    log(`ðŸŽ‰  Successfully created project ${chalk.yellow(name)}.`)
    if (!cliOptions.skipGetStarted) {
      log(
        `ðŸ‘‰  Get started with the following commands:\n\n` +
        (this.context === process.cwd() ? `` : chalk.cyan(` ${chalk.gray('$')} cd ${name}\n`)) +
        chalk.cyan(` ${chalk.gray('$')} ${packageManager === 'yarn' ? 'yarn serve' : packageManager === 'pnpm' ? 'pnpm run serve' : 'npm run serve'}`)
      )
    }
    log()
    this.emit('creation', { event: 'done' })

    if (gitCommitFailed) {
      warn(
        `Skipped git commit due to missing username and email in git config, or failed to sign commit.\n` +
        `You will need to perform the initial commit yourself.\n`
      )
    }

    generator.printExitLogs()
  }
```

> `Creator.create()` æ–¹æ³•ä¸»è¦é€»è¾‘ï¼š
>
> 1. preset å‚æ•°åˆå§‹åŒ–ï¼›
>
> 2. åŒ…ç®¡ç†å™¨å®žä¾‹åˆå§‹åŒ–ï¼›
>
> 3. æ ¹æ®æ’ä»¶ä¾èµ–ç”Ÿæˆ package.json æ–‡ä»¶ï¼›
>
> 4. æ ¹æ®åŒ…ç®¡ç†å™¨ç”Ÿæˆå¯¹åº”ç®¡ç†å™¨çš„ xxxrc æ–‡ä»¶ï¼›
>
> 5. åˆ¤æ–­æ˜¯å¦åˆå§‹åŒ–gitä»“åº“ï¼Œå¹¶åˆå§‹åŒ–gitä»“åº“ï¼›
>
> 6. åˆ¤æ–­æ˜¯å¦ä¸ºæ˜¯æµ‹è¯•æˆ–è°ƒè¯•çŽ¯å¢ƒï¼š
>
>    * æ˜¯ï¼Œåˆ™è°ƒç”¨`setupDevProject` å¯åŠ¨å¼€å‘æœåŠ¡ï¼›åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œé¿å…å®‰è£…è¿‡ç¨‹ï¼›
>    * å¦ï¼Œæ ¹æ® package.json æ–‡ä»¶å®‰è£…é¡¹ç›®ä¾èµ–ï¼›
>
> 7. ç”Ÿæˆé¡¹ç›®æ–‡ä»¶ï¼š è§£æžæ’ä»¶å¯¹è±¡ï¼Œå¹¶åˆ›å»ºç”Ÿæˆå™¨å®žä¾‹ç”Ÿæˆé¡¹ç›®æ–‡ä»¶ï¼›
>
>    ```js
>        // è§£æžæ’ä»¶
>        const plugins = await this.resolvePlugins(preset.plugins, pkg)
>        // åˆ›å»ºç”Ÿæˆå™¨
>        const generator = new Generator(context, {
>          pkg,
>          plugins,
>          afterInvokeCbs,
>          afterAnyInvokeCbs
>        })
>        // ç”Ÿæˆæ–‡ä»¶
>        await generator.generate({
>          extractConfigFiles: preset.useConfigFiles
>        })
>    ```
>
> 8. å®‰è£…ç”±ç”Ÿæˆå™¨å®žä¾‹æ³¨å…¥çš„ä¾èµ–ï¼›
>
> 9. è¿è¡Œåˆå§‹åŒ–åŽçš„å›žè°ƒï¼›
>
> 10. ç”Ÿæˆ  README.mdï¼›
>
> 11. æš‚å­˜ git ï¼›
>
> 12. æ‰“å°åˆ›å»ºç»“æžœï¼›

`Creator.create()` æ–¹æ³•ä¸»è¦æ‰§è¡Œé¡¹ç›®çš„å‚æ•°åˆå§‹åŒ–ã€åŒ…ç®¡ç†åˆå§‹åŒ–ã€npm åˆå§‹åŒ–ã€ä»“åº“åˆå§‹åŒ–ï¼Œé€šè¿‡Generatorç”Ÿæˆé¡¹ç›®æ–‡ä»¶ï¼Œå¹¶å®‰è£…é¡¹ç›®ä¾èµ–ï¼›

### **Generator ç”Ÿæˆé¡¹ç›®æ–‡ä»¶**

é€šè¿‡ä»¥ä¸Šåˆ†æžå¯çŸ¥ï¼Œ`Creator.create()` æ–¹æ³•ç”¨äºŽåˆ›å»ºé¡¹ç›®,Generator å¯¹è±¡åˆ›å»ºç”Ÿæˆé¡¹ç›®æ–‡ä»¶ï¼š

![image-20240131200047619](../images/vue-cli-æ–‡ä»¶ç”Ÿæˆå¯¹è±¡å®šä¹‰.png)

Generator å¯¹è±¡é€šè¿‡ `Generator.generate` æ–¹æ³•ç”Ÿæˆ  Vue é¡¹ç›®æ–‡ä»¶ï¼š

```js
  //ç”Ÿæˆæ–‡ä»¶ç³»ç»Ÿ
  async generate({
    extractConfigFiles = false,
    checkExisting = false
  } = {}) {
    //åˆå§‹åŒ–æ’ä»¶
    await this.initPlugins()

    // save the file system before applying plugin for comparison
    const initialFiles = Object.assign({}, this.files)
    // extract configs from package.json into dedicated files.
    //æå–é…ç½®æ–‡ä»¶ä»Ž package.json ä¸­ï¼Œå¹¶å°†å®ƒä»¬åˆ†è§£ä¸ºå•ç‹¬çš„æ–‡ä»¶
    this.extractConfigFiles(extractConfigFiles, checkExisting)
    // wait for file resolve
    //ç­‰å¾…æ–‡ä»¶è§£æž
    await this.resolveFiles()
    // set package.json
    //æŽ’åº package.json å¹¶å°†å…¶æ·»åŠ åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­
    this.sortPkg()
    this.files['package.json'] = JSON.stringify(this.pkg, null, 2) + '\n'
    // write/update file tree to disk
    //å°†æ–‡ä»¶ç³»ç»Ÿå†™å…¥ç£ç›˜
    await writeFileTree(this.context, this.files, initialFiles)
  }
```

> generate æ–¹æ³•ç”¨äºŽç”Ÿæˆæ–‡ä»¶ç³»ç»Ÿã€‚å®ƒæŽ¥å—ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå¯ä»¥è®¾ç½®ä¸¤ä¸ªé€‰é¡¹ï¼š`extractConfigFiles` å’Œ `checkExisting`ã€‚
>
> å‡½æ•°çš„å®žçŽ°åŽŸç†å¦‚ä¸‹ï¼š
>
> 1. é¦–å…ˆï¼Œåˆå§‹åŒ–æ’ä»¶ã€‚
> 2. ä»Ž `package.json` ä¸­æå–é…ç½®æ–‡ä»¶ï¼Œå¹¶å°†å®ƒä»¬åˆ†è§£ä¸ºå•ç‹¬çš„æ–‡ä»¶ã€‚
> 3. ç­‰å¾…æ–‡ä»¶è§£æžã€‚
> 4. æŽ’åº `package.json` å¹¶å°†å…¶æ·»åŠ åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚
> 5. å°†æ–‡ä»¶ç³»ç»Ÿå†™å…¥ç£ç›˜ã€‚
>
> æ³¨æ„äº‹é¡¹ï¼š
>
> - ç¡®ä¿åœ¨è°ƒç”¨æ­¤å‡½æ•°ä¹‹å‰å·²æ­£ç¡®åˆå§‹åŒ–ä¸Šä¸‹æ–‡å’Œæ–‡ä»¶ç³»ç»Ÿã€‚
> - è®¾ç½® `extractConfigFiles` ä¸º `true` ä»¥ä»Ž `package.json` ä¸­æå–é…ç½®æ–‡ä»¶ã€‚
> - è®¾ç½® `checkExisting` ä¸º `true` ä»¥åœ¨æå–é…ç½®æ–‡ä»¶ä¹‹å‰æ£€æŸ¥çŽ°æœ‰æ–‡ä»¶ã€‚
> - æ­¤å‡½æ•°ä¸ºå¼‚æ­¥å‡½æ•°ï¼Œåº”åœ¨é€‚å½“çš„äº‹ä»¶å¾ªçŽ¯æˆ–å›žè°ƒå‡½æ•°ä¸­ä½¿ç”¨ã€‚
> - å¦‚æžœéœ€è¦ï¼Œå¯ä»¥åœ¨å‡½æ•°ç»“æŸåŽæ£€æŸ¥é”™è¯¯å¹¶å¤„ç†å®ƒä»¬ã€‚



## **CLI æœåŠ¡åˆ†æž**

### **ä½¿ç”¨**

åœ¨ä¸€ä¸ª Vue CLI é¡¹ç›®ä¸­ï¼Œ`@vue/cli-service` å®‰è£…äº†ä¸€ä¸ªåä¸º `vue-cli-service` çš„å‘½ä»¤ã€‚

å¯ä»¥åœ¨ npm scripts ä¸­ä»¥ `vue-cli-service`ã€æˆ–è€…ä»Žç»ˆç«¯ä¸­ä»¥ `./node_modules/.bin/vue-cli-service` è®¿é—®è¿™ä¸ªå‘½ä»¤ã€‚

è¿™æ˜¯ä½ ä½¿ç”¨é»˜è®¤ preset çš„é¡¹ç›®çš„ `package.json`ï¼š

```shell
{
  "scripts": {
    "serve": "vue-cli-service serve",
    "build": "vue-cli-service build"
  }
}
```

ä½ å¯ä»¥é€šè¿‡ npm æˆ– Yarn è°ƒç”¨è¿™äº› scriptï¼š

```shell
npm run serve
# OR
yarn serve
```

å¦‚æžœä½ å¯ä»¥ä½¿ç”¨ [npx](https://github.com/npm/npx) (æœ€æ–°ç‰ˆçš„ npm åº”è¯¥å·²ç»è‡ªå¸¦)ï¼Œä¹Ÿå¯ä»¥ç›´æŽ¥è¿™æ ·è°ƒç”¨å‘½ä»¤ï¼š

```shell
npx vue-cli-service serve
```



### **Shell å‘½ä»¤è§£æž**

1. åœ¨ shell å‘½ä»¤è¡Œä¸­è¾“å…¥ `npm run serve` æ—¶å€™ï¼Œä¼šæ‰§è¡Œ `vue-cli-service serve`
2. å½“é‡åˆ° `vue-cli-service` å‘½ä»¤æ—¶ï¼Œä¼šåœ¨ `./node_modules/.bin` ç›®å½•ä¸‹æ ¹æ® windows æˆ– mac å¹³å°æŸ¥æ‰¾ shell æˆ– cmd è„šæœ¬æ‰§è¡Œï¼Œåœ¨ windows å¹³å°ä¸‹ä¼šæ‰§è¡Œ `./node_modules/.bin/vue-cli-service.cmd` :

![image-20240129173804799](../images/vue-cli-serveræºç åˆ†æž.png)

3. è¯¥æ‰¹å¤„ç†è„šæœ¬çš„ä¸»è¦ä½œç”¨æ˜¯æ‰¾åˆ°å¹¶è®¾ç½®Vue CLIæœåŠ¡çš„æ‰§è¡Œè·¯å¾„ï¼Œç„¶åŽä½¿ç”¨Node.jsæ¥è¿è¡ŒVue CLIæœåŠ¡ï¼ŒVue CLIæœåŠ¡çš„æ‰§è¡Œè·¯å¾„æ‰§è¡Œè·¯å¾„ä¸º `..\@vue\cli-service\bin\vue-cli-service.js`

`vue-cli-service.js` æ–‡ä»¶ä¸»è¦ä½œç”¨æ˜¯**æ£€æŸ¥è¿è¡ŒçŽ¯å¢ƒã€è§£æžå‘½ä»¤è¡Œå‚æ•°ï¼Œå¹¶è¿è¡Œ Vue CLI æœåŠ¡**:

```js

// è®¾å®šè„šæœ¬çš„è§£é‡Šå™¨ä¸º nodeï¼Œè¿™æ ·è¿™ä¸ªè„šæœ¬å°±æ˜¯ä¸€ä¸ª node è„šæœ¬ï¼Œå¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œã€‚  
#!/usr/bin/env node  
  
// ä»Ž '@vue/cli-shared-utils' æ¨¡å—ä¸­å¼•å…¥ 'semver' å’Œ 'error' å‡½æ•°ã€‚'semver' ç”¨äºŽå¤„ç†è¯­ä¹‰ç‰ˆæœ¬ï¼Œ'error' ç”¨äºŽè¾“å‡ºé”™è¯¯ä¿¡æ¯ã€‚  
const { semver, error } = require('@vue/cli-shared-utils')  
  
// ä»Ž '../package.json' æ–‡ä»¶ä¸­èŽ·å– 'engines.node' çš„å€¼ï¼Œè¿™ä¸ªå€¼æ˜¯è¿è¡Œè¿™ä¸ªè„šæœ¬æ‰€éœ€è¦çš„ Node.js çš„ç‰ˆæœ¬ã€‚  
const requiredVersion = require('../package.json').engines.node  
  
// æ£€æŸ¥å½“å‰è¿è¡Œçš„ Node.js ç‰ˆæœ¬æ˜¯å¦æ»¡è¶³ 'requiredVersion'ï¼Œå¦‚æžœä¸æ»¡è¶³ï¼Œåˆ™è¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶é€€å‡ºè¿›ç¨‹ã€‚  
if (!semver.satisfies(process.version, requiredVersion)) {  
  error(  
    `You are using Node ${process.version}, but vue-cli-service ` +  
    `requires Node ${requiredVersion}.\nPlease upgrade your Node version.`  
  )  
  process.exit(1)  
}  
  
// ä»Ž '../lib/Service' æ–‡ä»¶ä¸­å¼•å…¥ 'Service' ç±»ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„ 'Service' å®žä¾‹ã€‚  
const Service = require('../lib/Service')  
const service = new Service(process.env.VUE_CLI_CONTEXT || process.cwd())  
  
// èŽ·å–å‘½ä»¤è¡Œå‚æ•°ï¼ˆé™¤äº†è„šæœ¬åå’Œè·¯å¾„å‚æ•°ï¼‰ï¼Œå¹¶å­˜å‚¨åˆ° 'rawArgv' ä¸­ã€‚  
const rawArgv = process.argv.slice(2)  
  
// ä½¿ç”¨ 'minimist' åº“è§£æž 'rawArgv' ä¸­çš„å‚æ•°ã€‚è¿™é‡Œå®šä¹‰äº†ä¸€äº›å¸ƒå°”ç±»åž‹çš„å‚æ•°ã€‚  
const args = require('minimist')(rawArgv, {  
  boolean: [  
    // build  
    'modern',  
    'report',  
    'report-json',  
    'inline-vue',  
    'watch',  
    // serve  
    'open',  
    'copy',  
    'https',  
    // inspect  
    'verbose'  
  ]  
})  
  
// èŽ·å– 'args._[0]'ï¼Œå³ç¬¬ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼ˆä¸åŒ…æ‹¬å‚æ•°åï¼‰ï¼Œè¿™ä¸ªå‚æ•°é€šå¸¸è¡¨ç¤ºå‘½ä»¤ã€‚  
const command = args._[0]  
  
// è¿è¡Œ 'service' çš„ 'run' æ–¹æ³•ï¼Œä¼ å…¥å‘½ä»¤ã€å‚æ•°å’ŒåŽŸå§‹çš„å‘½ä»¤è¡Œå‚æ•°ã€‚å¦‚æžœè¿è¡Œè¿‡ç¨‹ä¸­å‡ºçŽ°é”™è¯¯ï¼Œåˆ™æ•èŽ·å¹¶è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œç„¶åŽé€€å‡ºè¿›ç¨‹ã€‚  
service.run(command, args, rawArgv).catch(err => {  
  error(err)  
  process.exit(1)  
})

```

> ä»¥ä¸Šä»£ç ä¸»è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
>
> 1. **æ£€æŸ¥è¿è¡ŒçŽ¯å¢ƒ**ï¼šé¦–å…ˆï¼Œè„šæœ¬æ£€æŸ¥å½“å‰è¿è¡Œçš„ Node.js ç‰ˆæœ¬æ˜¯å¦æ»¡è¶³æ‰€éœ€çš„ç‰ˆæœ¬è¦æ±‚ã€‚å¦‚æžœä¸æ»¡è¶³ï¼Œå®ƒä¼šè¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶é€€å‡ºè¿›ç¨‹ã€‚
> 2. **è§£æžå‘½ä»¤è¡Œå‚æ•°**ï¼šç„¶åŽï¼Œè„šæœ¬ä½¿ç”¨ 'minimist' åº“è§£æžå‘½ä»¤è¡Œå‚æ•°ã€‚å®ƒå®šä¹‰äº†ä¸€äº›å¸ƒå°”ç±»åž‹çš„å‚æ•°ï¼Œå¹¶æ ¹æ®è¿™äº›å‚æ•°çš„å€¼è®¾ç½®ç›¸åº”çš„æ•°æ®ç»“æž„ã€‚
> 3. **è¿è¡Œ Vue CLI æœåŠ¡**ï¼šæœ€åŽï¼Œè„šæœ¬è¿è¡Œ 'service' çš„ 'run' æ–¹æ³•ï¼Œä¼ å…¥å‘½ä»¤ã€å‚æ•°å’ŒåŽŸå§‹çš„å‘½ä»¤è¡Œå‚æ•°ã€‚å¦‚æžœè¿è¡Œè¿‡ç¨‹ä¸­å‡ºçŽ°é”™è¯¯ï¼Œå®ƒä¼šæ•èŽ·å¹¶è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œç„¶åŽé€€å‡ºè¿›ç¨‹ã€‚

`vue-cli-service` å¸¸ç”¨å‘½ä»¤ï¼š

* **`vue-cli-service serve` å‘½ä»¤:** å¯åŠ¨ä¸€ä¸ªå¼€å‘æœåŠ¡å™¨ (åŸºäºŽ [webpack-dev-server](https://github.com/webpack/webpack-dev-server)) å¹¶é™„å¸¦å¼€ç®±å³ç”¨çš„æ¨¡å—çƒ­é‡è½½ (Hot-Module-Replacement)ã€‚

  ```shell
  ç”¨æ³•ï¼švue-cli-service serve [options] [entry]
  ```

* **`vue-cli-service build` å‘½ä»¤:**  ä¼šåœ¨ `dist/` ç›®å½•äº§ç”Ÿä¸€ä¸ªå¯ç”¨äºŽç”Ÿäº§çŽ¯å¢ƒçš„åŒ…ï¼Œå¸¦æœ‰ JS/CSS/HTML çš„åŽ‹ç¼©ï¼Œå’Œä¸ºæ›´å¥½çš„ç¼“å­˜è€Œåšçš„è‡ªåŠ¨çš„ vendor chunk splittingã€‚å®ƒçš„ chunk manifest ä¼šå†…è”åœ¨ HTML é‡Œã€‚

  ```shell
  ç”¨æ³•ï¼švue-cli-service build [options] [entry|pattern]
  ```

é€šè¿‡ä»¥ä¸Šä»£ç å¯çŸ¥ï¼Œ`vue-cli-service` å‘½ä»¤æ‰§è¡Œå‰ï¼Œå…ˆåˆ›å»ºäº†ä¸€ä¸ª Service ç±»ï¼Œå¹¶é€šè¿‡ `service.run()` æ–¹æ³•æ‰§è¡Œæ‰§è¡Œå‘½ä»¤ã€‚

### **Service å¯¹è±¡åˆå§‹åŒ–**

Service å¯¹è±¡å®šä¹‰ä½äºŽ `./node_modules/@vue/cli-service/lib/Service.js` ä¸­;

`Service`çš„ç±»åŒ…å«äº†Vue CLIä¸­çš„æœåŠ¡å¯¹è±¡ã€‚

æœåŠ¡å¯¹è±¡è´Ÿè´£**å¤„ç†å‘½ä»¤è¡Œé€‰é¡¹ã€æ’ä»¶åŠ è½½ã€Webpacké…ç½®å’Œå…¶ä»–ä¸Žé¡¹ç›®æž„å»ºç›¸å…³çš„ä»»åŠ¡**:

```js
module.exports = class Service {
  constructor (context, { plugins, pkg, inlineOptions, useBuiltIn } = {}) {
    process.VUE_CLI_SERVICE = this
    this.initialized = false
    this.context = context
    this.inlineOptions = inlineOptions
    this.webpackChainFns = []
    this.webpackRawConfigFns = []
    this.devServerConfigFns = []
    this.commands = {}
    // Folder containing the target package.json for plugins
    this.pkgContext = context//contextå‚æ•°ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒ…å«é¡¹ç›®è·¯å¾„å’Œå…¶ä»–é…ç½®çš„çŽ¯å¢ƒå¯¹è±¡
    // package.json containing the plugins
    this.pkg = this.resolvePkg(pkg)//è§£æžpkgå‚æ•°ï¼Œå¦‚æžœpkgæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œå®ƒä¼šç›¸å¯¹äºŽcontextç›®å½•æ¥è§£æžã€‚
    // If there are inline plugins, they will be used instead of those
    // found in package.json.
    // When useBuiltIn === false, built-in plugins are disabled. This is mostly
    // for testing.
    //æ ¹æ®pluginså‚æ•°å’ŒuseBuiltInæ ‡å¿—æ¥åŠ è½½æ’ä»¶ã€‚å¦‚æžœuseBuiltInä¸ºfalseï¼Œåˆ™ç¦ç”¨å†…ç½®æ’ä»¶ã€‚
    this.plugins = this.resolvePlugins(plugins, useBuiltIn)//
    // pluginsToSkip will be populated during run()
    this.pluginsToSkip = new Set() //ç”¨äºŽè®°å½•è¦è·³è¿‡çš„æ’ä»¶çš„é›†åˆ
    // resolve the default mode to use for each command
    // this is provided by plugins as module.exports.defaultModes
    // so we can get the information without actually applying the plugin.
    //é»˜è®¤æ¨¡å¼å¯¹è±¡ï¼Œç”¨äºŽå®šä¹‰æ¯ä¸ªå‘½ä»¤çš„é»˜è®¤æ¨¡å¼ã€‚è¿™ä¸ªå¯¹è±¡æ˜¯é€šè¿‡æ’ä»¶çš„applyå¯¹è±¡ä¸­çš„defaultModesæ¥æž„å»ºçš„ã€‚
    this.modes = this.plugins.reduce((modes, { apply: { defaultModes }}) => {
      return Object.assign(modes, defaultModes)
    }, {})
  }
  //è§£æžpkgå‚æ•°ï¼Œå¦‚æžœpkgæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œå®ƒä¼šç›¸å¯¹äºŽcontextç›®å½•æ¥è§£æž
 //å¦‚æžœinlinePkgå­˜åœ¨ï¼Œåˆ™ç›´æŽ¥è¿”å›žã€‚
  //å¦åˆ™ï¼Œä½¿ç”¨resolvePkgæ–¹æ³•æ¥è§£æžcontextç›®å½•ä¸‹çš„åŒ…ã€‚
  //å¦‚æžœè§£æžåŽçš„åŒ…åŒ…å«vuePluginså±žæ€§ï¼Œåˆ™è®¾ç½®pkgContextå±žæ€§ä¸ºcontextä¸ŽvuePlugins.resolveFromçš„è·¯å¾„åˆ†è¾¨çŽ‡ã€‚
  //é€’å½’è°ƒç”¨resolvePkgæ–¹æ³•ï¼Œç›´åˆ°pkgContextè¢«è®¾ç½®ä¸ºæ­¢ã€‚
  resolvePkg (inlinePkg, context = this.context) {
    // ...
    return pkg
  }
  //åˆå§‹åŒ–
  init (mode = process.env.VUE_CLI_MODE) {
  // ...
  }
  //æ ¹æ®çŽ¯å¢ƒå˜é‡VUE_CLI_MODEæ¥åŠ è½½ç›¸åº”çš„é…ç½®æ–‡ä»¶
  loadEnv (mode) {
   // ...
  }
  //ç”¨äºŽè®°å½•è¦è·³è¿‡çš„æ’ä»¶çš„é›†åˆ
  setPluginsToSkip (args) {
  // ...
  }
  //æ ¹æ®pluginså‚æ•°å’ŒuseBuiltInæ ‡å¿—æ¥åŠ è½½æ’ä»¶ã€‚å¦‚æžœuseBuiltInä¸ºfalseï¼Œåˆ™ç¦ç”¨å†…ç½®æ’ä»¶ã€‚
  resolvePlugins (inlinePlugins, useBuiltIn) {
    // ...
    return plugins
  }

// asyncå‡½æ•°ï¼Œç”¨äºŽè¿è¡Œnameï¼Œargsï¼ŒrawArgv
 async run (name, args = {}, rawArgv = []) {
    // ...
    return fn(args, rawArgv)
  }
 //åŠ è½½ç”¨æˆ·æä¾›çš„chainableé…ç½®æ–‡ä»¶ã€‚é“¾å…¥Webpacké…ç½®å¤„ç†å‡½æ•°ï¼Œä»¥ä¾¿åœ¨æž„å»ºè¿‡ç¨‹ä¸­ä½¿ç”¨ã€‚
 resolveChainableWebpackConfig () {
   	// ...
    return chainableConfig
  }

  	//é“¾å…¥Webpacké…ç½®å¤„ç†å‡½æ•°ï¼Œä»¥ä¾¿åœ¨æž„å»ºè¿‡ç¨‹ä¸­ä½¿ç”¨ã€‚
  	//è§£æžç”¨æˆ·æä¾›çš„chainableé…ç½®æ–‡ä»¶ã€‚
    //æ‰§è¡Œé…ç½®æ–‡ä»¶å¤„ç†å‡½æ•°ï¼Œä»¥ä¾¿åœ¨æž„å»ºè¿‡ç¨‹ä¸­ä½¿ç”¨ã€‚
    //æ£€æŸ¥é…ç½®é¡¹entryçš„ç±»åž‹ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºæ•°ç»„ã€‚
    //å°†entryæ–‡ä»¶è§£æžä¸ºå…·ä½“çš„è·¯å¾„ï¼Œå¹¶è®¾ç½®çŽ¯å¢ƒå˜é‡VUE_CLI_ENTRY_FILESã€‚
  resolveWebpackConfig (chainableConfig = this.resolveChainableWebpackConfig()) {
    // ...
    return config
  }
  //åŠ è½½ç”¨æˆ·æä¾›çš„é€‰é¡¹ï¼Œå¹¶ä½¿ç”¨é»˜è®¤å€¼æ¥å¡«å……ç¼ºå¤±çš„é€‰é¡¹ã€‚
  loadUserOptions () {
    // ...
    return resolved
  }
}
```

> ä»¥ä¸Šä»£ç ä¸º `Service` ç±»çš„å®šä¹‰ï¼Œåœ¨è¯¥ç±»ä¸­å®šä¹‰äº†`Service` ç±»çš„å±žæ€§å’Œæ–¹æ³•ï¼š
>
> 1. åˆå§‹åŒ–`Service`ç±»æ—¶ï¼š
>    * ä¼šè®¾ç½®ä¸€äº›åŸºæœ¬çš„çŠ¶æ€ï¼šå¦‚`initialized`ã€`context`ã€`inlineOptions`ã€`webpackChainFns`ã€`webpackRawConfigFns`ã€`devServerConfigFns`ã€`commands`å’Œ`pkgContext`ã€‚
> 2. æž„é€ å‡½æ•°ï¼š ä¼šæŽ¥æ”¶ä¸€ä¸ª`context`å‚æ•°ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒ…å«é¡¹ç›®è·¯å¾„å’Œå…¶ä»–é…ç½®çš„çŽ¯å¢ƒå¯¹è±¡ã€‚
> 3. `resolvePkg`æ–¹æ³•ï¼šç”¨äºŽè§£æž`pkg`å‚æ•°ï¼Œå¦‚æžœ`pkg`æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œå®ƒä¼šç›¸å¯¹äºŽ`context`ç›®å½•æ¥è§£æžã€‚
> 4. `resolvePlugins`æ–¹æ³•ï¼šä¼šæ ¹æ®`plugins`å‚æ•°å’Œ`useBuiltIn`æ ‡å¿—æ¥åŠ è½½æ’ä»¶ã€‚å¦‚æžœ`useBuiltIn`ä¸º`false`ï¼Œåˆ™ç¦ç”¨å†…ç½®æ’ä»¶ã€‚
> 5. `pluginsToSkip`ï¼šæ˜¯ä¸€ä¸ªç”¨äºŽè®°å½•è¦è·³è¿‡çš„æ’ä»¶çš„é›†åˆã€‚
> 6. `modes`ï¼šæ˜¯ä¸€ä¸ªé»˜è®¤æ¨¡å¼å¯¹è±¡ï¼Œç”¨äºŽå®šä¹‰æ¯ä¸ªå‘½ä»¤çš„é»˜è®¤æ¨¡å¼ã€‚è¿™ä¸ªå¯¹è±¡æ˜¯é€šè¿‡æ’ä»¶çš„`apply`å¯¹è±¡ä¸­çš„`defaultModes`æ¥æž„å»ºçš„ã€‚
> 7. `init` æ–¹æ³•ï¼š
>    * åˆå§‹åŒ–`Service`ç±»ï¼Œè®¾ç½®ä¸€äº›åŸºæœ¬çš„çŠ¶æ€ã€‚
>    * æ ¹æ®çŽ¯å¢ƒå˜é‡`VUE_CLI_MODE`æ¥åŠ è½½ç›¸åº”çš„é…ç½®æ–‡ä»¶ï¼ˆ`vue-cli-service serve [options] [entry]` å‘½ä»¤é€šè¿‡ `--mode` å‚æ•°æŒ‡å®šçŽ¯å¢ƒæ¨¡å¼ ï¼Œé»˜è®¤å€¼ä¸º developmentï¼Œè¯¥å‚æ•°ä¼šåŠ è½½å½“å‰ç›®å½•ä¸‹æŒ‡å®šçŽ¯å¢ƒçš„ä¸‹é…ç½®æ–‡ä»¶ï¼‰ã€‚
>    * åŠ è½½ç”¨æˆ·æä¾›çš„é€‰é¡¹ï¼Œå¹¶ä½¿ç”¨é»˜è®¤å€¼æ¥å¡«å……ç¼ºå¤±çš„é€‰é¡¹ã€‚
>    * éåŽ†æ’ä»¶åˆ—è¡¨ï¼Œå¹¶æ‰§è¡Œå®ƒä»¬çš„æ–¹æ³•ã€‚
>    * é“¾å…¥Webpacké…ç½®å¤„ç†å‡½æ•°ï¼Œä»¥ä¾¿åœ¨æž„å»ºè¿‡ç¨‹ä¸­ä½¿ç”¨ã€‚
>    * åˆ›å»ºä¸€ä¸ªæ–°çš„Webpacké…ç½®å¤„ç†å‡½æ•°ï¼Œä»¥ä¾¿åœ¨æž„å»ºè¿‡ç¨‹ä¸­ä½¿ç”¨ã€‚
> 8. `run`æ–¹æ³•ï¼šç”¨äºŽå¯åŠ¨é¡¹ç›®æž„å»ºè¿‡ç¨‹ï¼Œå®ƒä¼šéåŽ†æ’ä»¶åˆ—è¡¨ï¼Œå¹¶æ‰§è¡Œå®ƒä»¬çš„æ–¹æ³•ã€‚
>
> è¿™äº›æ–¹æ³•ã€å±žæ€§å’ŒçŠ¶æ€çš„å®šä¹‰å…è®¸æœåŠ¡å¯¹è±¡åœ¨é¡¹ç›®æž„å»ºè¿‡ç¨‹ä¸­æ‰§è¡Œå„ç§ä»»åŠ¡ï¼Œå¦‚åŠ è½½æ’ä»¶ã€é…ç½®Webpackå’Œå¤„ç†å¼€å‘æœåŠ¡å™¨é…ç½®ç­‰ã€‚

é€šè¿‡ä»¥ä¸Š Service å¯¹è±¡å®šä¹‰å¯çŸ¥ï¼š

1. åœ¨ shell æ‰§è¡Œå‘½ä»¤æ—¶å€™ï¼Œé¦–å…ˆè§£æžå‚æ•°ï¼Œå¹¶å°†å‚æ•°ä¼ é€’ç»™ Service ç±»: `new Service(process.env.VUE_CLI_CONTEXT || process.cwd())  `;
2.  Service ç±»åˆå§‹åŒ–æ—¶ï¼Œè°ƒç”¨ `resolvePkg(pkg)` è§£æžè§£æžå‚æ•°æŒ‡å®šç›®å½•ä¸‹çš„åŒ…ï¼›
3. åˆå§‹åŒ–å®ŒæˆåŽè°ƒç”¨ `run`æ–¹æ³•ï¼Œç”¨äºŽå¯åŠ¨é¡¹ç›®æž„å»ºè¿‡ç¨‹ï¼Œå®ƒä¼šéåŽ†æ’ä»¶åˆ—è¡¨ï¼Œå¹¶æ‰§è¡Œå®ƒä»¬çš„æ–¹æ³•ã€‚

### **`Service.run ` å¯åŠ¨æž„å»º**

`Service.run ` æ–¹æ³•è¯¦ç»†ä»£ç ï¼š

```js
// asyncå‡½æ•°ï¼Œç”¨äºŽè¿è¡Œnameï¼Œargsï¼ŒrawArgv
 async run (name, args = {}, rawArgv = []) {
    // resolve mode
    // prioritize inline --mode
    // fallback to resolved default modes from plugins or development if --watch is defined
    //è§£æž`args.mode`å’Œ`args.watch`å‚æ•°ï¼Œç¡®å®šå½“å‰æ¨¡å¼
    const mode = args.mode || (name === 'build' && args.watch ? 'development' : this.modes[name])

    // --skip-plugins arg may have plugins that should be skipped during init()
    // set plugins to skip
    //è®¾ç½®è¦è·³è¿‡çš„æ’ä»¶
    this.setPluginsToSkip(args)

    // load env variables, load user config, apply plugins
    // åŠ è½½çŽ¯å¢ƒå˜é‡ï¼ŒåŠ è½½ç”¨æˆ·é…ç½®ï¼Œåº”ç”¨æ’ä»¶
    this.init(mode)

    // resolve args
    // è§£æžå‚æ•°
    args._ = args._ || []
    let command = this.commands[name]
    if (!command && name) {
      error(`command "${name}" does not exist.`)
      process.exit(1)
    }
    if (!command || args.help || args.h) {
      command = this.commands.help
    } else {
      args._.shift() // remove command itself
      rawArgv.shift()
    }
    const { fn } = command
    return fn(args, rawArgv)
  }

```

> è¯¥æ–¹æ³•æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
>
> * è§£æž`args.mode`å’Œ`args.watch`å‚æ•°ï¼Œç¡®å®šå½“å‰æ¨¡å¼ã€‚
> * è®¾ç½®è¦è·³è¿‡çš„æ’ä»¶ã€‚
> * åŠ è½½çŽ¯å¢ƒå˜é‡å’Œç”¨æˆ·é…ç½®ã€‚
> * åº”ç”¨æ’ä»¶ã€‚
> * è§£æžå‚æ•°ã€‚
> * è°ƒç”¨`command`æ–¹æ³•ï¼Œå¹¶è¿”å›žç»“æžœã€‚

æ ¹æ®ä»¥ä¸Š "Shell å‘½ä»¤è§£æž" éƒ¨åˆ†ä»£ç ä¸­ï¼Œ`vue-cli-service.js` æ–‡ä»¶ä¸­è°ƒç”¨äº† `service.run`ï¼š

```js
service.run(command, args, rawArgv).catch(err => {  
  error(err)  
  process.exit(1)  
})
```

è€Œ`vue-cli-service` å‘½ä»¤ç”¨æ³•ä¸ºï¼šï¼ˆä»¥ serveå‚æ•°ä¸ºä¾‹ï¼‰ `vue-cli-service serve [options] [entry]`ï¼Œåˆ™ `service.run` æ–¹æ³•çš„ command å‚æ•°ä¸ºè¯¥å‘½ä»¤çš„ `serve` æ–¹æ³•ï¼›

åœ¨  `service.run` æ–¹æ³•ä¸­æœ€åŽæ‰§è¡Œ :

```js
const { fn } = command
return fn(args, rawArgv)
```

è¯´æ˜Žåœ¨ `vue-cli-service serve [options] [entry]` å‘½ä»¤ä¸­æœ€åŽæ‰§è¡Œ `serve` æ–¹æ³•å¹¶ä¼ å…¥ `[options] [entry]` å‚æ•°ã€‚



### **è§£æžæ’ä»¶**

ä»¥ `serve` æ–¹æ³•ä¸ºä¾‹ï¼Œ`vue-cli-service` æž„å»ºå‘½ä»¤ä¸ºï¼š `vue-cli-service serve[options] [entry|pattern]`

é€šè¿‡ä»¥ä¸Šä»£ç åˆ†æžå¯çŸ¥ï¼Œå‘½ä»¤è¡Œå‚æ•°æ–¹æ³• serve é€šè¿‡ `command` å‚æ•°æ‰§è¡Œï¼Œ `command` å‚æ•°åœ¨ Service æž„é€ å‡½æ•°ä¸­å®šä¹‰ï¼Œå¹¶é€šè¿‡ `Service.resolvePlugins` æ–¹æ³•åˆå§‹åŒ–ï¼Œè¯¥æ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š

```js
 // è§£æžæ’ä»¶
  resolvePlugins (inlinePlugins, useBuiltIn) {
    // æ ¹æ®idèŽ·å–æ’ä»¶
    const idToPlugin = id => ({
      id: id.replace(/^.\//, 'built-in:'),
      apply: require(id)
    })

    let plugins

    // å†…ç½®æ’ä»¶
    const builtInPlugins = [
      './commands/serve',
      './commands/build',
      './commands/inspect',
      './commands/help',
      // config plugins are order sensitive
      './config/base',
      './config/css',
      './config/prod',
      './config/app'
    ].map(idToPlugin)

    // åˆ¤æ–­æ˜¯å¦ä½¿ç”¨å†…ç½®æ’ä»¶
    if (inlinePlugins) {
      // åˆ¤æ–­æ˜¯å¦ä½¿ç”¨å†…ç½®æ’ä»¶
      plugins = useBuiltIn !== false
        ? builtInPlugins.concat(inlinePlugins)
        : inlinePlugins
    } else {
      // èŽ·å–é¡¹ç›®æ’ä»¶
      const projectPlugins = Object.keys(this.pkg.devDependencies || {})
        .concat(Object.keys(this.pkg.dependencies || {}))
        .filter(isPlugin)
        .map(id => {
          // åˆ¤æ–­æ˜¯å¦å¯é€‰ä¾èµ–
          if (
            this.pkg.optionalDependencies &&
            id in this.pkg.optionalDependencies
          ) {
            let apply = () => {}
            try {
              // å°è¯•åŠ è½½æ’ä»¶
              apply = require(id)
            } catch (e) {
              // åŠ è½½å¤±è´¥ï¼Œè¾“å‡ºè­¦å‘Š
              warn(`Optional dependency ${id} is not installed.`)
            }

            return { id, apply }
          } else {
            // æ ¹æ®idèŽ·å–æ’ä»¶
            return idToPlugin(id)
          }
        })
      // åˆå¹¶å†…ç½®æ’ä»¶å’Œé¡¹ç›®æ’ä»¶
      plugins = builtInPlugins.concat(projectPlugins)
    }

    // Local plugins
    // åˆ¤æ–­æ˜¯å¦æœ‰æœ¬åœ°æ’ä»¶
    if (this.pkg.vuePlugins && this.pkg.vuePlugins.service) {
      // èŽ·å–æ–‡ä»¶
      const files = this.pkg.vuePlugins.service
      // åˆ¤æ–­æ–‡ä»¶ç±»åž‹æ˜¯å¦ä¸ºæ•°ç»„
      if (!Array.isArray(files)) {
        // ä¸æ˜¯æ•°ç»„ï¼ŒæŠ›å‡ºé”™è¯¯
        throw new Error(`Invalid type for option 'vuePlugins.service', expected 'array' but got ${typeof files}.`)
      }
      // åˆå¹¶æ’ä»¶
      plugins = plugins.concat(files.map(file => ({
        id: `local:${file}`,
        apply: loadModule(`./${file}`, this.pkgContext)
      })))
    }

    return plugins
  }
```

> è¯¥æ–¹æ³•ä¸»è¦è§£æžæ’ä»¶ï¼š
>
> 1.  æ ¹æ®idèŽ·å–æ’ä»¶;
> 2. åˆ¤æ–­æ˜¯å¦ä½¿ç”¨å†…ç½®æ’ä»¶ï¼ŒèŽ·å–é¡¹ç›®æ’ä»¶
> 3.  åˆå¹¶å†…ç½®æ’ä»¶å’Œé¡¹ç›®æ’ä»¶ï¼›
> 4. åˆ¤æ–­æ˜¯å¦æœ‰æœ¬åœ°æ’ä»¶ï¼Œåˆå¹¶æ’ä»¶
> 5. è¿”å›žåˆå¹¶åŽçš„æ’ä»¶ã€‚

æ ¹æ®ä»¥ä¸Š`resolvePlugins` æ–¹æ³•å¯çŸ¥ï¼Œ  `serve` æ–¹æ³• æ’ä»¶å®šä¹‰åœ¨`./commands/serve`ï¼Œæ‰€æœ‰å†…ç½®æ’ä»¶å®šä¹‰å¦‚ä¸‹ï¼š

![image-20240129200352382](../images/vue-cli-serviceå†…ç½®æ’ä»¶.png)

> è‡ªå®šä¹‰å¼€å‘æ’ä»¶å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š [æ’ä»¶å¼€å‘æŒ‡å— | Vue CLI (vuejs.org)](https://cli.vuejs.org/zh/dev-guide/plugin-dev.html#service-æ’ä»¶)

### **serve å‘½ä»¤è§£æž**  

`vue-cli-service serve` å‘½ä»¤ç”¨äºŽå¼€å‘çŽ¯å¢ƒï¼Œåœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ª HTTP æœåŠ¡ï¼š

#### **ä½¿ç”¨**

```shell
ç”¨æ³•ï¼švue-cli-service serve [options] [entry]

é€‰é¡¹ï¼š

  --open    åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶æ‰“å¼€æµè§ˆå™¨
  --copy    åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶å°† URL å¤åˆ¶åˆ°å‰ªåˆ‡ç‰ˆ
  --mode    æŒ‡å®šçŽ¯å¢ƒæ¨¡å¼ (é»˜è®¤å€¼ï¼šdevelopment)
  --host    æŒ‡å®š host (é»˜è®¤å€¼ï¼š0.0.0.0)
  --port    æŒ‡å®š port (é»˜è®¤å€¼ï¼š8080)
  --https   ä½¿ç”¨ https (é»˜è®¤å€¼ï¼šfalse)
```

é€šè¿‡ npm script æ‰§è¡Œè¯¥å‘½ä»¤ï¼š

```js
  "scripts": {
    "dev": "vue-cli-service serve",
    "prod": "cross-env NODE_ENV=production && vue-cli-service serve",
  },
```

#### **åŽŸç†**

`vue-cli-service serve` å‘½ä»¤ä¼šå¯åŠ¨ä¸€ä¸ªå¼€å‘æœåŠ¡å™¨ (åŸºäºŽ [webpack-dev-server](https://github.com/webpack/webpack-dev-server)) å¹¶é™„å¸¦å¼€ç®±å³ç”¨çš„æ¨¡å—çƒ­é‡è½½ (Hot-Module-Replacement)ã€‚

#### **æºç åˆ†æž**

åœ¨é€šè¿‡ä»¥ä¸Šâ€œè§£æžæ’ä»¶â€ æ­¥éª¤æ—¶ï¼Œæ‰§è¡Œ`vue-cli-service serve`å‘½ä»¤æ—¶ï¼Œæœ€ç»ˆæ˜¯é€šè¿‡è°ƒç”¨ `serve` æ’ä»¶æ–¹æ³•ï¼Œserve å‘½ä»¤è„šæœ¬åœ¨ `cli-service/lib/commands/serve.js` ä¸­ï¼š

```js
module.exports = (api, options) => {
  //è°ƒç”¨ registerCommand æ³¨å†Œä¸€ä¸ª serve å‘½ä»¤
  api.registerCommand('serve', {
    description: 'start development server',
    usage: 'vue-cli-service serve [options] [entry]',
    options: {
      '--open': `open browser on server start`,
      '--copy': `copy url to clipboard on server start`,
      '--stdin': `close when stdin ends`,
      '--mode': `specify env mode (default: development)`,
      '--host': `specify host (default: ${defaults.host})`,
      '--port': `specify port (default: ${defaults.port})`,
      '--https': `use https (default: ${defaults.https})`,
      '--public': `specify the public network URL for the HMR client`,
      '--skip-plugins': `comma-separated list of plugin names to skip for this run`
    }
  }, async function serve (args) {
    info('Starting development server...')
 	// å¯åŠ¨ä¸€ä¸ªå¼€å‘æœåŠ¡å™¨ï¼Œä»¥ä¸‹ä»£ç çœç•¥...
    })
  })
}
```

>  åœ¨ `serve.js` ä¸­ä¸»è¦è°ƒç”¨äº† ` api.registerCommand` è¿›è¡Œæ³¨å†Œå‘½ä»¤ï¼Œå¹¶ä¼ å…¥ä¸‰ä¸ªå‚æ•°:
>
> * ç¬¬ä¸€ä¸ªå‚æ•°ï¼šserve å‘½ä»¤åç§°ï¼›
> * ç¬¬äºŒä¸ªå‚æ•°ï¼šå‘½ä»¤é€‰é¡¹ï¼›
> * ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šå‘½ä»¤å›žè°ƒå‡½æ•°ï¼Œåœ¨è¯¥å›žè°ƒå‡½æ•°ä¸­ä½¿ç”¨ webpack å¯åŠ¨ä¸€ä¸ªæœ¬åœ°å¼€å‘æœåŠ¡;
>
> ` api.registerCommand`  æ–¹å¼å®žé™…ä¸Šåœ¨ `cli-service/lib/PluginAPI.js` ä¸­å®šä¹‰ï¼šä¸»è¦ä½œç”¨æ˜¯åœ¨ Service ç±»ä¸­æ³¨å†Œä¸€ä¸ªå‘½ä»¤
>
> ```js
>   registerCommand (name, opts, fn) {
>     if (typeof opts === 'function') {
>       fn = opts
>       opts = null
>     }
>     this.service.commands[name] = { fn, opts: opts || {}}
>   }
> ```

è¯¥å‘½ä»¤çš„ä¸»è¦æ‰§è¡Œé€»è¾‘ä¸º` api.registerCommand` çš„ç¬¬ä¸‰ä¸ªå‚æ•°å›žè°ƒæ–¹æ³•ï¼Œä¸‹é¢åˆ†æžè¯¥å›žè°ƒ `serve` æ–¹æ³• :

#### **`serve` å›žè°ƒ**

serve å›žè°ƒä¸­ä¸»è¦**ä½¿ç”¨ webpack å¯åŠ¨ä¸€ä¸ªå¯åŠ¨ä¸€ä¸ªæœ¬åœ°å¼€å‘æœåŠ¡**,å†…éƒ¨ä¸»è¦é€»è¾‘ï¼š

1. **é…ç½®åˆå§‹åŒ–**ï¼š webpack å’Œ webpack å¼€å‘æœåŠ¡é…ç½®é¡¹åˆå§‹åŒ–ï¼›
2. åˆ›å»º webpack å®žä¾‹ å’Œ å¼€å‘æœåŠ¡å®žä¾‹ï¼›
3. è¿”å›ž HTTP æœåŠ¡å®žä¾‹ï¼Œå¹¶å¯åŠ¨æœ¬åœ° HTTP æœåŠ¡;

ä»£ç ç®€åŒ–é€»è¾‘ä¸ºï¼š

```js
async function serve (args) {
    info('Starting development server...')
  
    // although this is primarily a dev server, it is possible that we
    // are running it in a mode with a production env, e.g. in E2E tests.
    const isInContainer = checkInContainer()
    const isProduction = process.env.NODE_ENV === 'production'

    const url = require('url')
    const { chalk } = require('@vue/cli-shared-utils')
    const webpack = require('webpack')
    const WebpackDevServer = require('webpack-dev-server')
    const portfinder = require('portfinder')
    const prepareURLs = require('../util/prepareURLs')
    const prepareProxy = require('../util/prepareProxy')
    const launchEditorMiddleware = require('launch-editor-middleware')
    const validateWebpackConfig = require('../util/validateWebpackConfig')
    const isAbsoluteUrl = require('../util/isAbsoluteUrl')
   // ==================webpack å’Œ webpack å¼€å‘æœåŠ¡é…ç½®é¡¹ åˆå§‹åŒ–====================
    // å¾€ service.webpackChainFns é˜Ÿåˆ—ä¸­æ·»åŠ å›žè°ƒ...
    // 1.è®¾ç½®å¼€å‘çŽ¯å¢ƒä¸‹ webpack å¼€å‘å·¥å…·...
    // 2.è§£æž webpack é…ç½®
    // 3.æ£€æŸ¥å¸¸è§çš„ webpack é…ç½®é”™è¯¯
    // 4.æš´éœ²é«˜çº§ç»Ÿè®¡ä¿¡æ¯...
    //5.è§£æž webpack å…¥å£å‚æ•°...
    // 6.è§£æžæœåŠ¡å™¨é€‰é¡¹...
    // 7.éžç”Ÿäº§çŽ¯å¢ƒä¸‹ï¼Œæ³¨å…¥å¼€å‘å’Œçƒ­é‡è½½ä¸­é—´ä»¶...
  
    //========== webpack é…ç½®é¡¹åˆå§‹åŒ–å®Œæˆ ====================
    //========== åˆ›å»º webpack å®žä¾‹ å’Œ å¼€å‘æœåŠ¡å®žä¾‹============
    // create compiler
    // æ ¸å¿ƒï¼šåˆ›å»º webpack å®žä¾‹ï¼Œè¿”å›žä¸€ä¸ªç¼–è¯‘å™¨å¯¹è±¡
    const compiler = webpack(webpackConfig)

    // create server
    // æ ¸å¿ƒï¼šåˆ›å»ºä¸€ä¸ª webpack å¼€å‘æœåŠ¡, ä¼ å…¥ä¸€ä¸ªç¼–è¯‘å™¨å®žä¾‹ å’Œ å‚æ•°é€‰é¡¹
    const server = new WebpackDevServer(compiler, {
     //é…ç½®é¡¹çœç•¥...
    })
	// è¿”å›žä¸€ä¸ª HTTP æœåŠ¡å®žä¾‹
    return new Promise((resolve, reject) => {
      // log instructions & open browser on first compilation complete
      let isFirstCompile = true
      // ç›‘å¬ webpack æ’ä»¶ done äº‹ä»¶
      compiler.hooks.done.tap('vue-cli-service serve', stats => {
  	  // é…ç½®æ“ä½œ....
      // å¯åŠ¨æœåŠ¡ï¼Œå¹¶ç›‘å¬
      server.listen(port, host, err => {
        if (err) {
          reject(err)
        }
      })
    })
  }
```



å®Œæ•´ä»£ç å’Œæ³¨é‡Šä¸ºï¼š

```js
async function serve (args) {
    info('Starting development server...')
    // ==================webpack å’Œ webpack å¼€å‘æœåŠ¡é…ç½®é¡¹ åˆå§‹åŒ–====================
    // although this is primarily a dev server, it is possible that we
    // are running it in a mode with a production env, e.g. in E2E tests.
    const isInContainer = checkInContainer()
    const isProduction = process.env.NODE_ENV === 'production'

    const url = require('url')
    const { chalk } = require('@vue/cli-shared-utils')
    const webpack = require('webpack')
    const WebpackDevServer = require('webpack-dev-server')
    const portfinder = require('portfinder')
    const prepareURLs = require('../util/prepareURLs')
    const prepareProxy = require('../util/prepareProxy')
    const launchEditorMiddleware = require('launch-editor-middleware')
    const validateWebpackConfig = require('../util/validateWebpackConfig')
    const isAbsoluteUrl = require('../util/isAbsoluteUrl')

    // configs that only matters for dev server
    // å¾€ service.webpackChainFns é˜Ÿåˆ—ä¸­æ·»åŠ å›žè°ƒ
    api.chainWebpack(webpackConfig => {
      // è®¾ç½®å¼€å‘çŽ¯å¢ƒä¸‹ webpack å¼€å‘å·¥å…·
      if (process.env.NODE_ENV !== 'production' && process.env.NODE_ENV !== 'test') {
        webpackConfig
          .devtool('cheap-module-eval-source-map')

        // æ·»åŠ  webpack çƒ­æ›´æ–°æ’ä»¶
        webpackConfig
          .plugin('hmr')
            .use(require('webpack/lib/HotModuleReplacementPlugin'))

        // https://github.com/webpack/webpack/issues/6642
        // https://github.com/vuejs/vue-cli/issues/3539
        // https://v3.vuejs.org/api/global-api.html#definecomponnet
        // è®¾ç½® webpack å…¨å±€å¯¹è±¡ ä¸€äº›æ’ä»¶éœ€è¦å®ƒæ¥æ­£ç¡®å·¥ä½œ
        webpackConfig
          .output
            .globalObject(`(typeof self !== 'undefined' ? self : this)`)

        // æ·»åŠ  webpack è¿›åº¦æ¡
        if (!process.env.VUE_CLI_TEST && options.devServer.progress !== false) {
          webpackConfig
            .plugin('progress')
            .use(require('webpack/lib/ProgressPlugin'))
        }
      }
    })

    // resolve webpack config è§£æž webpack é…ç½®
    const webpackConfig = api.resolveWebpackConfig()

    // check for common config errors
    // æ£€æŸ¥å¸¸è§çš„ webpack é…ç½®é”™è¯¯
    validateWebpackConfig(webpackConfig, api, options)

    // load user devServer options with higher priority than devServer
    // in webpack config
    // åŠ è½½ç”¨æˆ· devServer é€‰é¡¹ï¼Œå…·æœ‰æ¯” webpack é…ç½®ä¸­çš„ devServer æ›´é«˜çš„ä¼˜å…ˆçº§
    const projectDevServerOptions = Object.assign(
      webpackConfig.devServer || {},
      options.devServer
    )

    // expose advanced stats
    // æš´éœ²é«˜çº§ç»Ÿè®¡ä¿¡æ¯
    if (args.dashboard) {
      // https://github.com/FormidableLabs/webpack-dashboard
      const DashboardPlugin = require('../webpack/DashboardPlugin')
      ;(webpackConfig.plugins = webpackConfig.plugins || []).push(new DashboardPlugin({
        type: 'serve'
      }))
    }

    // entry arg
    //è§£æž webpack å…¥å£å‚æ•°
    const entry = args._[0]
    if (entry) {
      webpackConfig.entry = {
        app: api.resolve(entry)
      }
    }

    // resolve server options
    // è§£æžæœåŠ¡å™¨é€‰é¡¹
    const useHttps = args.https || projectDevServerOptions.https || defaults.https   
    const protocol = useHttps ? 'https' : 'http'
    const host = args.host || process.env.HOST || projectDevServerOptions.host || defaults.host
    portfinder.basePort = args.port || process.env.PORT || projectDevServerOptions.port || defaults.port
    const port = await portfinder.getPortPromise()
    const rawPublicUrl = args.public || projectDevServerOptions.public
    const publicUrl = rawPublicUrl
      ? /^[a-zA-Z]+:\/\//.test(rawPublicUrl)
        ? rawPublicUrl
        : `${protocol}://${rawPublicUrl}`
      : null

    const urls = prepareURLs(
      protocol,
      host,
      port,
      isAbsoluteUrl(options.publicPath) ? '/' : options.publicPath
    )
    const localUrlForBrowser = publicUrl || urls.localUrlForBrowser
    // proxy config
    const proxySettings = prepareProxy(
      projectDevServerOptions.proxy,
      api.resolve('public')
    )

    // inject dev & hot-reload middleware entries
    // éžç”Ÿäº§çŽ¯å¢ƒä¸‹ï¼Œæ³¨å…¥å¼€å‘å’Œçƒ­é‡è½½ä¸­é—´ä»¶
    if (!isProduction) {
      // socket è¿žæŽ¥è·¯å¾„
      const sockPath = projectDevServerOptions.sockPath || '/sockjs-node'
      const sockjsUrl = publicUrl
        // explicitly configured via devServer.public
        ? `?${publicUrl}&sockPath=${sockPath}`
        : isInContainer
          // can't infer public network url if inside a container...
          // use client-side inference (note this would break with non-root publicPath)
          ? ``
          // otherwise infer the url
          : `?` + url.format({
            protocol,
            port,
            hostname: urls.lanUrlForConfig || 'localhost'
          }) + `&sockPath=${sockPath}`
      const devClients = [
        // dev server client
        require.resolve(`webpack-dev-server/client`) + sockjsUrl,
        // hmr client
        require.resolve(projectDevServerOptions.hotOnly
          ? 'webpack/hot/only-dev-server'
          : 'webpack/hot/dev-server')
        // TODO custom overlay client
        // `@vue/cli-overlay/dist/client`
      ]
      if (process.env.APPVEYOR) {
        devClients.push(`webpack/hot/poll?500`)
      }
      // inject dev/hot client
      // æ·»åŠ å¼€å‘å’Œçƒ­é‡è½½å®¢æˆ·ç«¯åˆ° entry
      addDevClientToEntry(webpackConfig, devClients)
    }
    //========== webpack é…ç½®é¡¹åˆå§‹åŒ–å®Œæˆ ====================
    //========== åˆ›å»º webpack å®žä¾‹ å’Œ å¼€å‘æœåŠ¡å®žä¾‹============
    // create compiler
    // æ ¸å¿ƒï¼šåˆ›å»º webpack å®žä¾‹ï¼Œè¿”å›žä¸€ä¸ªç¼–è¯‘å™¨å¯¹è±¡
    const compiler = webpack(webpackConfig)

    // handle compiler error
    // webpack å¤„ç†ç¼–è¯‘é”™è¯¯ï¼Œç›‘å¬é”™è¯¯ï¼Œå‘ç”Ÿé”™è¯¯æ—¶é€€å‡ºç¨‹åº
    compiler.hooks.failed.tap('vue-cli-service serve', msg => {
      error(msg)
      process.exit(1)
    })

    // create server
    // æ ¸å¿ƒï¼šåˆ›å»ºä¸€ä¸ª webpack å¼€å‘æœåŠ¡, ä¼ å…¥ä¸€ä¸ªç¼–è¯‘å™¨å®žä¾‹ å’Œ å‚æ•°é€‰é¡¹
   const server = new WebpackDevServer(compiler, Object.assign({
      // å…³é—­ webpack çš„æ—¥å¿—
      logLevel: 'silent',
      // å…³é—­ webpack-dev-server çš„æ—¥å¿—
      clientLogLevel: 'silent',
      // æ”¯æŒé¡µé¢è·³è½¬
      historyApiFallback: {
        // ç¦ç”¨ç‚¹å¼è§„åˆ™
        disableDotRule: true,
        // ç”ŸæˆåŽ†å²apiå›žé€€é‡å†™
        rewrites: genHistoryApiFallbackRewrites(options.publicPath, options.pages)
      },
      // æŒ‡å®šå†…å®¹åŸºç¡€
      contentBase: api.resolve('public'),
      // éžç”Ÿäº§çŽ¯å¢ƒæ—¶ï¼Œç›‘å¬å†…å®¹åŸºç¡€
      watchContentBase: !isProduction,
      // éžç”Ÿäº§çŽ¯å¢ƒæ—¶ï¼Œå¯ç”¨çƒ­æ›´æ–°
      hot: !isProduction,
      // ç¦ç”¨æ³¨å…¥å®¢æˆ·ç«¯
      injectClient: false,
      // åŽ‹ç¼©
      compress: isProduction,
      // æŒ‡å®špublicPath
      publicPath: options.publicPath,
      // éžç”Ÿäº§çŽ¯å¢ƒæ—¶ï¼Œå¯ç”¨è¦†ç›–
      overlay: isProduction // TODO disable this
        ? false
        : { warnings: false, errors: true }
    }, projectDevServerOptions, {
      // ä½¿ç”¨https
      https: useHttps,
      // ä»£ç†è®¾ç½®
      proxy: proxySettings,
      // æ³¨å†Œä¸­é—´ä»¶
      // eslint-disable-next-line no-shadow
      before (app, server) {
        // launch editor support.
        // this works with vue-devtools & @vue/cli-overlay
        // å¯åŠ¨ç¼–è¾‘å™¨æ”¯æŒ
        // æ­¤åŠŸèƒ½ä¸Žvue-devtoolså’Œ@vue/cli-overlayä¸€èµ·å·¥ä½œ
        app.use('/__open-in-editor', launchEditorMiddleware(() => console.log(
          `To specify an editor, specify the EDITOR env variable or ` +
          `add "editor" field to your Vue project config.\n`
        )))
        // allow other plugins to register middlewares, e.g. PWA
        // å…è®¸å…¶ä»–æ’ä»¶æ³¨å†Œä¸­é—´ä»¶ï¼Œä¾‹å¦‚PWA
        api.service.devServerConfigFns.forEach(fn => fn(app, server))
        // apply in project middlewares
        // åº”ç”¨é¡¹ç›®ä¸­é—´ä»¶
        projectDevServerOptions.before && projectDevServerOptions.before(app, server)
      },
      // avoid opening browser
      // é¿å…æ‰“å¼€æµè§ˆå™¨
      open: false
    }))

   // æ³¨å†Œ node ä¿¡å·
   ;['SIGINT', 'SIGTERM'].forEach(signal => {
      // å½“æ”¶åˆ°SIGINTæˆ–SIGTERMä¿¡å·æ—¶ï¼Œå…³é—­æœåŠ¡å™¨
      process.on(signal, () => {
        server.close(() => {
          // é€€å‡ºè¿›ç¨‹
          process.exit(0)
        })
      })
    })

   // åˆ¤æ–­args.stdinæ˜¯å¦å­˜åœ¨
   if (args.stdin) {
      // å½“æ ‡å‡†è¾“å…¥æµç»“æŸæ—¶
      process.stdin.on('end', () => {
        // å…³é—­æœåŠ¡å™¨
        server.close(() => {
          // é€€å‡ºè¿›ç¨‹
          process.exit(0)
        })
      })

      // æ¢å¤æ ‡å‡†è¾“å…¥æµ
      process.stdin.resume()
    }

   // on appveyor, killing the process with SIGTERM causes execa to
    // throw error
    if (process.env.VUE_CLI_TEST) {
      process.stdin.on('data', data => {
        if (data.toString() === 'close') {
          console.log('got close signal!')
          server.close(() => {
            process.exit(0)
          })
        }
      })
    }

    return new Promise((resolve, reject) => {
      // log instructions & open browser on first compilation complete
      let isFirstCompile = true
      // ç›‘å¬ webpack æ’ä»¶ done äº‹ä»¶
      compiler.hooks.done.tap('vue-cli-service serve', stats => {
        if (stats.hasErrors()) {
          return
        }

        let copied = ''
        // é¦–æ¬¡ç¼–è¯‘å°†æœåŠ¡åœ°å€æ·»åŠ åˆ°ç²˜è´´æ¿
        if (isFirstCompile && args.copy) {
          try {
            require('clipboardy').writeSync(localUrlForBrowser)
            copied = chalk.dim('(copied to clipboard)')
          } catch (_) {
            /* catch exception if copy to clipboard isn't supported (e.g. WSL), see issue #3476 */
          }
        }

        const networkUrl = publicUrl
          ? publicUrl.replace(/([^/])$/, '$1/')
          : urls.lanUrlForTerminal

        console.log()
        console.log(`  App running at:`)
        console.log(`  - Local:   ${chalk.cyan(urls.localUrlForTerminal)} ${copied}`)
        if (!isInContainer) {
          console.log(`  - Network: ${chalk.cyan(networkUrl)}`)
        } else {
          console.log()
          console.log(chalk.yellow(`  It seems you are running Vue CLI inside a container.`))
          if (!publicUrl && options.publicPath && options.publicPath !== '/') {
            console.log()
            console.log(chalk.yellow(`  Since you are using a non-root publicPath, the hot-reload socket`))
            console.log(chalk.yellow(`  will not be able to infer the correct URL to connect. You should`))
            console.log(chalk.yellow(`  explicitly specify the URL via ${chalk.blue(`devServer.public`)}.`))
            console.log()
          }
          console.log(chalk.yellow(`  Access the dev server via ${chalk.cyan(
            `${protocol}://localhost:<your container's external mapped port>${options.publicPath}`
          )}`))
        }
        console.log()

        if (isFirstCompile) {
          isFirstCompile = false

          if (!isProduction) {
            const buildCommand = hasProjectYarn(api.getCwd()) ? `yarn build` : hasProjectPnpm(api.getCwd()) ? `pnpm run build` : `npm run build`
            console.log(`  Note that the development build is not optimized.`)
            console.log(`  To create a production build, run ${chalk.cyan(buildCommand)}.`)
          } else {
            console.log(`  App is served in production mode.`)
            console.log(`  Note this is for preview or E2E testing only.`)
          }
          console.log()
          // æ‰“å¼€æµè§ˆå™¨
          if (args.open || projectDevServerOptions.open) {
            const pageUri = (projectDevServerOptions.openPage && typeof projectDevServerOptions.openPage === 'string')
              ? projectDevServerOptions.openPage
              : ''
            openBrowser(localUrlForBrowser + pageUri)
          }

          // Send final app URL
          // å‘é€ url åˆ°ç²˜è´´æ¿
          if (args.dashboard) {
            const ipc = new IpcMessenger()
            ipc.send({
              vueServe: {
                url: localUrlForBrowser
              }
            })
          }

          // resolve returned Promise
          // so other commands can do api.service.run('serve').then(...)
          resolve({
            server,
            url: localUrlForBrowser
          })
        } else if (process.env.VUE_CLI_TEST) {
          // signal for test to check HMR
          console.log('App updated')
        }
      })
      // å¯åŠ¨æœåŠ¡ï¼Œå¹¶ç›‘å¬
      server.listen(port, host, err => {
        if (err) {
          reject(err)
        }
      })
    })
  }
```



### **`build` å‘½ä»¤è§£æž**

`vue-cli-service build` å‘½ä»¤ç”¨äºŽç”Ÿäº§çŽ¯å¢ƒï¼Œä½¿ç”¨ webpack å¯¹é¡¹ç›®è¿›è¡Œæž„å»ºï¼š

#### **ä½¿ç”¨**

```shell
ç”¨æ³•ï¼švue-cli-service build [options] [entry|pattern]

é€‰é¡¹ï¼š

  --mode        æŒ‡å®šçŽ¯å¢ƒæ¨¡å¼ (é»˜è®¤å€¼ï¼šproduction)
  --dest        æŒ‡å®šè¾“å‡ºç›®å½• (é»˜è®¤å€¼ï¼šdist)
  --modern      é¢å‘çŽ°ä»£æµè§ˆå™¨å¸¦è‡ªåŠ¨å›žé€€åœ°æž„å»ºåº”ç”¨
  --target      app | lib | wc | wc-async (é»˜è®¤å€¼ï¼šapp)
  --name        åº“æˆ– Web Components æ¨¡å¼ä¸‹çš„åå­— (é»˜è®¤å€¼ï¼špackage.json ä¸­çš„ "name" å­—æ®µæˆ–å…¥å£æ–‡ä»¶å)
  --no-clean    åœ¨æž„å»ºé¡¹ç›®ä¹‹å‰ä¸æ¸…é™¤ç›®æ ‡ç›®å½•çš„å†…å®¹
  --report      ç”Ÿæˆ report.html ä»¥å¸®åŠ©åˆ†æžåŒ…å†…å®¹
  --report-json ç”Ÿæˆ report.json ä»¥å¸®åŠ©åˆ†æžåŒ…å†…å®¹
  --watch       ç›‘å¬æ–‡ä»¶å˜åŒ–
```

`vue-cli-service build` ä¼šåœ¨ `dist/` ç›®å½•äº§ç”Ÿä¸€ä¸ªå¯ç”¨äºŽç”Ÿäº§çŽ¯å¢ƒçš„åŒ…ï¼Œå¸¦æœ‰ JS/CSS/HTML çš„åŽ‹ç¼©ï¼Œå’Œä¸ºæ›´å¥½çš„ç¼“å­˜è€Œåšçš„è‡ªåŠ¨çš„ vendor chunk splittingã€‚å®ƒçš„ chunk manifest ä¼šå†…è”åœ¨ HTML é‡Œã€‚

è¿™é‡Œè¿˜æœ‰ä¸€äº›æœ‰ç”¨çš„å‘½ä»¤å‚æ•°ï¼š

- `--modern` ä½¿ç”¨[çŽ°ä»£æ¨¡å¼](https://cli.vuejs.org/zh/guide/browser-compatibility.html#çŽ°ä»£æ¨¡å¼)æž„å»ºåº”ç”¨ï¼Œä¸ºçŽ°ä»£æµè§ˆå™¨äº¤ä»˜åŽŸç”Ÿæ”¯æŒçš„ ES2015 ä»£ç ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªå…¼å®¹è€æµè§ˆå™¨çš„åŒ…ç”¨æ¥è‡ªåŠ¨å›žé€€ã€‚
- `--target` å…è®¸ä½ å°†é¡¹ç›®ä¸­çš„ä»»ä½•ç»„ä»¶ä»¥ä¸€ä¸ªåº“æˆ– Web Components ç»„ä»¶çš„æ–¹å¼è¿›è¡Œæž„å»ºã€‚æ›´å¤šç»†èŠ‚è¯·æŸ¥é˜…[æž„å»ºç›®æ ‡](https://cli.vuejs.org/zh/guide/build-targets.html)ã€‚
- `--report` å’Œ `--report-json` ä¼šæ ¹æ®æž„å»ºç»Ÿè®¡ç”ŸæˆæŠ¥å‘Šï¼Œå®ƒä¼šå¸®åŠ©ä½ åˆ†æžåŒ…ä¸­åŒ…å«çš„æ¨¡å—ä»¬çš„å¤§å°ã€‚

é€šè¿‡ npm script æ‰§è¡Œè¯¥å‘½ä»¤ï¼š

```js
  "scripts": {
    "build:prod": "git pull && vue-cli-service build && npm run upload prod",
    "build:test": "git pull && vue-cli-service build --mode staging && npm run upload test",
  },
```



#### **æºç åˆ†æž**



## **WebPack é…ç½®åŽŸç†**

### **é…ç½®æ–¹å¼**

åœ¨ `vue.config.js` ä¸­çš„ `configureWebpack` é€‰é¡¹æä¾›ä¸€ä¸ªå¯¹è±¡ï¼š

```js
// vue.config.js
module.exports = {
  configureWebpack: {
    plugins: [
      new MyAwesomeWebpackPlugin()
    ]
  }
}
```

è¯¥å¯¹è±¡å°†ä¼šè¢« [webpack-merge](https://github.com/survivejs/webpack-merge) åˆå¹¶å…¥æœ€ç»ˆçš„ webpack é…ç½®ã€‚

ä½¿ç”¨ Vue-Cli åˆ›å»ºçš„é¡¹ç›® `vue.config.js` é…ç½®ä¸ºï¼š

```js
'use strict'
const path = require('path')
const defaultSettings = require('./src/settings/projectSettings.js')
const LodashModuleReplacementPlugin = require('lodash-webpack-plugin')
const UpdatePopup = require('@femessage/update-popup') // ç‰ˆæœ¬æ›´æ–°æé†’æ’ä»¶
function resolve(dir) {
  return path.join(__dirname, dir)
}

const name = defaultSettings.title page title

// If your port is set to 80,
// use administrator privileges to execute the command line.
// For example, Mac: sudo npm run
// You can change the port by the following methods:
// port = 8080 npm run dev OR npm run dev --port = 8080
const port = process.env.port || process.env.npm_config_port || 8080 // dev port

// All configuration item explanations can be find in https://cli.vuejs.org/config/
module.exports = {
  /**
   * You will need to set publicPath if you plan to deploy your site under a sub path,
   * for example GitHub Pages. If you plan to deploy your site to https://foo.github.io/bar/,
   * then publicPath should be set to "/bar/".
   * In most cases please use '/' !!!
   * Detail: https://cli.vuejs.org/config/#publicpath
   */
  publicPath: './',
  outputDir: 'dist',
  assetsDir: 'static',
  lintOnSave: process.env.NODE_ENV === 'development',
  productionSourceMap: false,
  devServer: {
    port: port,
    open: true,
    overlay: {
      warnings: false,
      errors: true
    },
    hot: true,
    // websocket é…ç½®ä»£ç†
    proxy: {
      '/socket.io': {
        target: 'http://localhost:3000', // target host
        changeOrigin: true, // needed for virtual hosted sites
        logLevel: 'debug'
      }
    }
  },
  configureWebpack: {
    // provide the app's title in webpack's name field, so that
    // it can be accessed in index.html to inject the correct title.
    name: name,
    resolve: {
      alias: {
        '@': resolve('src')
      }
    }
  },
  chainWebpack(config) {
    // it can improve the speed of the first screen, it is recommended to turn on preload
    config.plugin('preload').tap(() => [
      {
        rel: 'preload',
        // to ignore runtime.js
        // https://github.com/vuejs/vue-cli/blob/dev/packages/@vue/cli-service/lib/config/views/App.js#L171
        fileBlacklist: [/\.map$/, /hot-update\.js$/, /runtime\..*\.js$/],
        include: 'initial'
      }
    ])
    // ç‰ˆæœ¬æ›´æ–°æé†’æ’ä»¶
    config.plugin('femessage-update-popup').use(UpdatePopup, [{
      auto: true
    }])
    // when there are many pages, it will cause too many meaningless requests
    config.plugins.delete('prefetch')

    // set svg-sprite-loader
    config.module
      .rule('svg')
      .exclude.add(resolve('src/icons'))
      .end()
    config.module
      .rule('icons')
      .test(/\.svg$/)
      .include.add(resolve('src/icons'))
      .end()
      .use('svg-sprite-loader')
      .loader('svg-sprite-loader')
      .options({
        symbolId: 'icon-[name]'
      })
      .end()

    config
      .when(process.env.NODE_ENV !== 'development',
        config => {
          config
            .plugin('ScriptExtHtmlWebpackPlugin')
            .after('html')
            .use('script-ext-html-webpack-plugin', [{
            // `runtime` must same as runtimeChunk name. default is `runtime`
              inline: /runtime\..*\.js$/
            }])
            .end()
          config
            .optimization.splitChunks({
              chunks: 'all',
              cacheGroups: {
                libs: {
                  name: 'chunk-libs',
                  test: /[\\/]node_modules[\\/]/,
                  priority: 10,
                  chunks: 'initial' // only package third parties that are initially dependent
                },
                elementUI: {
                  name: 'chunk-elementUI', // split elementUI into a single package
                  priority: 20, // the weight needs to be larger than libs and app or it will be packaged into libs or app
                  test: /[\\/]node_modules[\\/]_?element-ui(.*)/ // in order to adapt to cnpm
                },
                commons: {
                  name: 'chunk-commons',
                  test: resolve('src/components'), // can customize your rules
                  minChunks: 3, //  minimum common number
                  priority: 5,
                  reuseExistingChunk: true
                }
              }
            })
          // https:// webpack.js.org/configuration/optimization/#optimizationruntimechunk
          config.optimization.runtimeChunk('single')
        }
      )

    config.plugin('loadshReplace').use(new LodashModuleReplacementPlugin())
  },
  css: {
    loaderOptions: {
      sass: {
        prependData: `@import "~@/styles/variables.scss";`
      }
    }
  }
}

```

#### **`configureWebpack`  å±žæ€§**

> Type: `Object | Function`
>
> webpack é…ç½®å±žæ€§ï¼š
>
> * å¦‚æžœè¿™ä¸ªå€¼æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œåˆ™ä¼šé€šè¿‡ [webpack-merge](https://github.com/survivejs/webpack-merge) åˆå¹¶åˆ°æœ€ç»ˆçš„é…ç½®ä¸­ã€‚
>
> * å¦‚æžœè¿™ä¸ªå€¼æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåˆ™ä¼šæŽ¥æ”¶è¢«è§£æžçš„é…ç½®ä½œä¸ºå‚æ•°ã€‚è¯¥å‡½æ•°æ—¢å¯ä»¥ä¿®æ”¹é…ç½®å¹¶ä¸è¿”å›žä»»ä½•ä¸œè¥¿ï¼Œä¹Ÿå¯ä»¥è¿”å›žä¸€ä¸ªè¢«å…‹éš†æˆ–åˆå¹¶è¿‡çš„é…ç½®ç‰ˆæœ¬ã€‚

**åŽŸç†**

`configureWebpack` å±žæ€§åœ¨ CLI æœåŠ¡å¯¹è±¡ `Service` ç±»åˆå§‹åŒ– `init` æ–¹æ³•ä¸­ï¼Œé€šè¿‡å°†ç”¨æˆ·é…ç½®çš„ webpack é¡¹å­˜å‚¨åˆ° `webpackRawConfigFns`ï¼Œæœ€åŽé€šè¿‡ [webpack-merge](https://github.com/survivejs/webpack-merge) åˆå¹¶åˆ°æœ€ç»ˆçš„é…ç½®ä¸­ï¼š

![image-20240131135803195](../images/vue-cli-webpacké…ç½®é¡¹.png)

### **é“¾å¼æ“ä½œ (é«˜çº§)**

Vue CLI å†…éƒ¨çš„ webpack é…ç½®æ˜¯é€šè¿‡ [webpack-chain](https://github.com/mozilla-neutrino/webpack-chain) ç»´æŠ¤çš„ã€‚

è¿™ä¸ªåº“æä¾›äº†ä¸€ä¸ª webpack åŽŸå§‹é…ç½®çš„ä¸Šå±‚æŠ½è±¡ï¼Œä½¿å…¶å¯ä»¥å®šä¹‰å…·åçš„ loader è§„åˆ™å’Œå…·åæ’ä»¶ï¼Œå¹¶æœ‰æœºä¼šåœ¨åŽæœŸè¿›å…¥è¿™äº›è§„åˆ™å¹¶å¯¹å®ƒä»¬çš„é€‰é¡¹è¿›è¡Œä¿®æ”¹ã€‚
é“¾å¼æ“ä½œé€šè¿‡  `vue.config.js` ä¸­çš„ `chainWebpack` å±žæ€§é…ç½®ï¼š

#### **`chainWebpack` å±žæ€§**

> Type: `Function`
>
> æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¼šæŽ¥æ”¶ä¸€ä¸ªåŸºäºŽ [webpack-chain](https://github.com/mozilla-neutrino/webpack-chain) çš„ `ChainableConfig` å®žä¾‹ã€‚
>
> å…è®¸å¯¹å†…éƒ¨çš„ webpack é…ç½®è¿›è¡Œæ›´ç»†ç²’åº¦çš„ä¿®æ”¹ã€‚

 `chainWebpack` å±žæ€§ä½¿ç”¨æ–¹å¼å‚è€ƒ [webpack-chain](https://github.com/mozilla-neutrino/webpack-chain) å®˜æ–¹æ–‡æ¡£ä½¿ç”¨æ–¹å¼ã€‚

####  **[webpack-chain](https://github.com/mozilla-neutrino/webpack-chain)** 

**webpack-chain æ˜¯ä»€ä¹ˆï¼Ÿ**

> `webpack-chain` æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œå®ƒé€šè¿‡é“¾å¼ API ç”Ÿæˆå’Œç®€åŒ– webpack 2-4 ç‰ˆæœ¬çš„é…ç½®çš„ä¿®æ”¹

**ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ webpack-chain ï¼Ÿ**

> Webpack-chain çš„å‡ºçŽ°æ˜¯ä¸ºäº†è§£å†³ webpack é…ç½®çš„é—®é¢˜ã€‚
>
> Webpack çš„é…ç½®è¿‡ç¨‹æžå…¶å¤æ‚ï¼Œéœ€è¦è¾“å…¥å¤§é‡çš„ä¿¡æ¯æ¥ä¿è¯æ‰“åŒ…ç»“æžœç¬¦åˆé¢„æœŸã€‚
>
> Webpack-chain é€šè¿‡æä¾›ä¸€ä¸ªé“¾å¼ API æ¥è§£å†³è¿™ä¸ªé—®é¢˜:
>
> 1. å®ƒå…è®¸ç”¨æˆ·ä»¥é“¾å¼æ–¹å¼åˆ›å»ºå’Œä¿®æ”¹ webpack é…ç½®ï¼Œè¿™ä½¿å¾—é…ç½®è¿‡ç¨‹æ›´åŠ ç›´è§‚å’Œæ˜“äºŽç®¡ç†ã€‚
> 2. API çš„ Key éƒ¨åˆ†å¯ä»¥ç”±ç”¨æˆ·æŒ‡å®šçš„åç§°å¼•ç”¨ï¼Œè¿™æœ‰åŠ©äºŽæ ‡å‡†åŒ–è·¨é¡¹ç›®çš„é…ç½®ä¿®æ”¹æ–¹å¼ã€‚



## **[æ¨¡å¼å’ŒçŽ¯å¢ƒå˜é‡](https://cli.vuejs.org/zh/guide/mode-and-env.html#æ¨¡å¼å’ŒçŽ¯å¢ƒå˜é‡)**

### **æ¨¡å¼**

**æ¨¡å¼**æ˜¯ Vue CLI é¡¹ç›®ä¸­ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ª Vue CLI é¡¹ç›®æœ‰ä¸‰ä¸ªæ¨¡å¼ï¼š

- å¼€å‘æ¨¡å¼ï¼š`development` å­—æ®µè¡¨ç¤ºï¼Œä½¿ç”¨ `vue-cli-service serve` å‘½ä»¤å¯åŠ¨ï¼›
- æµ‹è¯•æ¨¡å¼ï¼š`test` å­—æ®µè¡¨ç¤ºï¼Œä½¿ç”¨ `vue-cli-service test:unit` å‘½ä»¤å¯åŠ¨ï¼›
- ç”Ÿäº§æ¨¡å¼ï¼š`production` å­—æ®µè¡¨ç¤ºï¼Œä½¿ç”¨  `vue-cli-service build` å‘½ä»¤å¯åŠ¨ï¼›

ä½ å¯ä»¥é€šè¿‡ä¼ é€’ `--mode` é€‰é¡¹å‚æ•°ä¸ºå‘½ä»¤è¡Œè¦†å†™é»˜è®¤çš„æ¨¡å¼ã€‚ä¾‹å¦‚ï¼Œå¦‚æžœä½ æƒ³è¦åœ¨æž„å»ºå‘½ä»¤ä¸­ä½¿ç”¨å¼€å‘çŽ¯å¢ƒå˜é‡ï¼š

```
vue-cli-service build --mode development
```

å½“è¿è¡Œ `vue-cli-service` å‘½ä»¤æ—¶ï¼Œæ‰€æœ‰çš„çŽ¯å¢ƒå˜é‡éƒ½ä»Žå¯¹åº”çš„[çŽ¯å¢ƒæ–‡ä»¶](https://cli.vuejs.org/zh/guide/mode-and-env.html#çŽ¯å¢ƒå˜é‡)ä¸­è½½å…¥ã€‚

é€šè¿‡ä»¥ä¸Š "serve å‘½ä»¤è§£æž" éƒ¨åˆ†å¯çŸ¥ï¼š`vue-cli-service` ä¸­ `serve` å’Œ `build` å‘½ä»¤æœ€ç»ˆå®žé™…æ‰§è¡Œ `server.js` å’Œ `build` æ’ä»¶ï¼Œæ’ä»¶ç›®å½•å¦‚ä¸‹ï¼š![image-20240131160413569](../images/vue-cli-service-æ’ä»¶.png)



### **çŽ¯å¢ƒå˜é‡**

é¡¹ç›®æ ¹ç›®å½•ä¸­æ”¾ç½®ä¸‹åˆ—æ–‡ä»¶æ¥æŒ‡å®šçŽ¯å¢ƒå˜é‡ï¼š

```shell
.env                # åœ¨æ‰€æœ‰çš„çŽ¯å¢ƒä¸­è¢«è½½å…¥
.env.local          # åœ¨æ‰€æœ‰çš„çŽ¯å¢ƒä¸­è¢«è½½å…¥ï¼Œä½†ä¼šè¢« git å¿½ç•¥
.env.[mode]         # åªåœ¨æŒ‡å®šçš„æ¨¡å¼ä¸­è¢«è½½å…¥
.env.[mode].local   # åªåœ¨æŒ‡å®šçš„æ¨¡å¼ä¸­è¢«è½½å…¥ï¼Œä½†ä¼šè¢« git å¿½ç•¥
```

ä¸€ä¸ªçŽ¯å¢ƒæ–‡ä»¶åªåŒ…å«çŽ¯å¢ƒå˜é‡çš„â€œé”®=å€¼â€å¯¹ï¼š

```shell
FOO=bar
VUE_APP_NOT_SECRET_CODE=some_value
```



### **æºç åˆ†æž**

æ¨¡å¼å’ŒçŽ¯å¢ƒå˜é‡åˆå§‹åŒ–åœ¨ Service ç±»åˆå§‹åŒ–æ—¶ `init` æ–¹æ³•ä¸­ï¼Œé€šè¿‡ `loadEnv` æ–¹æ³•åˆå§‹åŒ–ï¼š

![image-20240131144841437](../images/vue-cli-service-loadEnv.png)

`loadEnv` æ–¹æ³•å®šä¹‰ï¼š

![image-20240131145425965](../images/loadEnvæ–¹æ³•.png)





## **å‚è€ƒèµ„æ–™**

[vue-cli](https://cli.vuejs.org/zh/guide/)

[å‰–æž Vue CLI å®žçŽ°åŽŸç†](https://cloud.tencent.com/developer/article/1781202#:~:text=Vue%20CLI%20%E6%98%AF%E4%B8%80%E4%B8%AA%E5%9F%BA%E4%BA%8E%20Vue.js%20%E8%BF%9B%E8%A1%8C%E5%BF%AB%E9%80%9F%E5%BC%80%E5%8F%91%E7%9A%84%E5%AE%8C%E6%95%B4%E7%B3%BB%E7%BB%9F%EF%BC%8C%E6%8F%90%E4%BE%9B%E4%BA%86%E7%BB%88%E7%AB%AF%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7%E3%80%81%E9%9B%B6%E9%85%8D%E7%BD%AE%E8%84%9A%E6%89%8B%E6%9E%B6%E3%80%81%E6%8F%92%E4%BB%B6%E4%BD%93%E7%B3%BB%E3%80%81%E5%9B%BE%E5%BD%A2%E5%8C%96%E7%AE%A1%E7%90%86%E7%95%8C%E9%9D%A2%E7%AD%89%E3%80%82,%E6%9C%AC%E6%96%87%E6%9A%82%E4%B8%94%E5%8F%AA%E5%88%86%E6%9E%90%20%E9%A1%B9%E7%9B%AE%E5%88%9D%E5%A7%8B%E5%8C%96%20%E9%83%A8%E5%88%86%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AF%E7%BB%88%E7%AB%AF%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7%E7%9A%84%E5%AE%9E%E7%8E%B0%E3%80%82%200.%20%E7%94%A8%E6%B3%95)