---
star: true
category:
  - æºç åˆ†æ
  - Vue
tag:
  - VueCli
---
# VueCliæºç åˆ†æ

![](../images/VueCli.png)

## **æ˜¯ä»€ä¹ˆ**

Vue CLIï¼ˆVue Command Line Interfaceï¼‰æ˜¯ä¸€ä¸ªå®˜æ–¹æä¾›çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºå¿«é€Ÿæ­å»ºå’Œç®¡ç†Vue.jsé¡¹ç›®ã€‚

å®ƒæä¾›äº†ä¸€æ•´å¥—å®Œæ•´çš„å¼€å‘è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ä»£ç æ„å»ºã€çƒ­æ›´æ–°ã€ä»£ç åˆ†å‰²ã€ä»£ç å‹ç¼©ã€ç‰ˆæœ¬æ§åˆ¶ç­‰åŠŸèƒ½ï¼Œå¤§å¤§ç®€åŒ–äº†Vue.jsé¡¹ç›®çš„å¼€å‘è¿‡ç¨‹ã€‚

## **ä¸ºä»€ä¹ˆ**

åœ¨å¼€å‘Vue.jsé¡¹ç›®æ—¶ï¼Œå¦‚æœæ²¡æœ‰ä¸€ä¸ªç»Ÿä¸€çš„æ„å»ºå·¥å…·ï¼Œå¼€å‘äººå‘˜éœ€è¦æ‰‹åŠ¨é…ç½®å„ç§å·¥å…·å’Œæ’ä»¶ï¼Œè¿™ä¸ä»…æµªè´¹æ—¶é—´ï¼Œè¿˜å®¹æ˜“å‡ºé”™ã€‚

è€ŒVue CLIä½œä¸ºå®˜æ–¹çš„æ„å»ºå·¥å…·ï¼Œæä¾›äº†é¢„å…ˆé…ç½®å¥½çš„æœ€ä½³å®è·µï¼Œä½¿å¾—å¼€å‘äººå‘˜å¯ä»¥ä¸“æ³¨äºç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸æ˜¯èŠ±è´¹å¤§é‡æ—¶é—´åœ¨é…ç½®ä¸Šã€‚

Vue CLIè¿˜å¯ä»¥è‡ªåŠ¨åŒ–å¤„ç†è®¸å¤šç¹ççš„ä»»åŠ¡ï¼Œå¦‚ä»£ç å‹ç¼©ã€çƒ­æ›´æ–°ç­‰ï¼Œä»è€Œæé«˜å¼€å‘æ•ˆç‡ã€‚

 

## **Vue-cli é›†æˆæ’ä»¶/åº“**

| æŠ€æœ¯           | ä½œç”¨                                                         |
| :------------- | :----------------------------------------------------------- |
| Vue.js         | ç”¨äºæ„å»ºç”¨æˆ·ç•Œé¢çš„æµè¡ŒJavaScriptå‰ç«¯æ¡†æ¶                     |
| Webpack        | é™æ€æ¨¡å—æ‰“åŒ…å·¥å…·ï¼Œå¤„ç†é¡¹ç›®ä¸­çš„èµ„æºæ–‡ä»¶å¹¶æ‰“åŒ…æˆå¯ç”¨çš„æ–‡ä»¶     |
| Babel          | JavaScript ç¼–è¯‘å™¨ï¼Œå°†ES6+ä»£ç è½¬æ¢ä¸ºå‘åå…¼å®¹çš„JavaScriptç‰ˆæœ¬  |
| ESLint         | å¯æ’æ‹”çš„JavaScriptä»£ç æ£€æŸ¥å·¥å…·ï¼Œå¸®åŠ©ä¿æŒä¸€è‡´çš„ä»£ç é£æ ¼å’Œå‘ç°æ½œåœ¨é—®é¢˜ |
| Vue Router     | Vue.jså®˜æ–¹æä¾›çš„è·¯ç”±ç®¡ç†å™¨ï¼Œç”¨äºæ„å»ºå•é¡µåº”ç”¨ç¨‹åºçš„è·¯ç”±ç³»ç»Ÿ   |
| Vuex           | Vue.jså®˜æ–¹æä¾›çš„çŠ¶æ€ç®¡ç†åº“ï¼Œç”¨äºç®¡ç†åº”ç”¨ç¨‹åºçš„å…¨å±€çŠ¶æ€       |
| Axios          | ç”¨äºå‘èµ· GET ã€æˆ– POST ç­‰ httpè¯·æ±‚ï¼ŒåŸºäº Promise è®¾è®¡        |
| Jest           | å•å…ƒæµ‹è¯•æ¡†æ¶ï¼Œç”¨äºç¼–å†™å’Œè¿è¡Œå•å…ƒæµ‹è¯•                         |
| Cypress        | ç«¯åˆ°ç«¯æµ‹è¯•æ¡†æ¶ï¼Œç”¨äºç¼–å†™å’Œè¿è¡Œæ•´ä¸ªåº”ç”¨ç¨‹åºçš„ç«¯åˆ°ç«¯æµ‹è¯•       |
| Sass           | CSSé¢„å¤„ç†å™¨ï¼Œå¢å¼ºCSSçš„ç¼–ç¨‹èƒ½åŠ›å’Œå¯ç»´æŠ¤æ€§                     |
| Less           | CSSé¢„å¤„ç†å™¨ï¼Œå¢å¼ºCSSçš„ç¼–ç¨‹èƒ½åŠ›å’Œå¯ç»´æŠ¤æ€§                     |
| Prettier       | ä»£ç æ ¼å¼åŒ–å·¥å…·ï¼Œç”¨äºè‡ªåŠ¨æ ¼å¼åŒ–ä»£ç                            |
| ä»£ç åˆ†å‰²       | å°†ä»£ç æ‹†åˆ†æˆå¤šä¸ªå°å—ï¼Œå®ç°æŒ‰éœ€åŠ è½½å’Œæé«˜åº”ç”¨ç¨‹åºæ€§èƒ½         |
| æ‡’åŠ è½½         | å»¶è¿ŸåŠ è½½é¡µé¢ä¸­çš„èµ„æºï¼Œæé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½                     |
| `emit.js` æ–‡ä»¶ | ç”¨äº vue äº‹ä»¶æœºåˆ¶çš„ç®¡ç†                                      |

`Vue-CLi` é›†æˆçš„æ‰€æœ‰å†…ç½®æ’ä»¶ä½äº `./node_modules/@vue/`ç›®å½•ä¸‹ï¼š

![image-20240201112118335](../images/vueclié›†æˆçš„æ’ä»¶.png)



## **åŠŸèƒ½**

Vue-Cli ä¸»è¦æœ‰ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š

1. å¿«é€Ÿæ­å»ºå’Œç®¡ç†Vue.jsé¡¹ç›®ï¼š `vue-cli` å†…ç½® Vue é¡¹ç›®çš„è„šæ‰‹æ¶æ¨¡æ¿ï¼Œé€šè¿‡ä½¿ç”¨ `vue create` å³å¯åˆ›å»ºä¸€ä¸ª Vue é¡¹ç›®ï¼›
2. æä¾›å¼€å‘å’Œéƒ¨ç½²æœåŠ¡ï¼šå¼€å‘å’Œéƒ¨ç½²è§£å†³æ–¹æ¡ˆé€šè¿‡ `vue-cli-service` æœåŠ¡å®ç°ï¼Œ`vue-cli-service` æœåŠ¡å¯¹ webpack è¿›è¡Œäº†äºŒæ¬¡å°è£…ï¼Œå†…ç½® webpack dev server å¼€å‘æœåŠ¡å’Œ webpack æ„å»ºéƒ¨ç½²æœåŠ¡ã€‚

ä¸‹é¢å°†é€šè¿‡åˆ†æ åˆ›å»º `vue create` é¡¹ç›®æ¨¡æ¿ï¼ˆé¡¹ç›®è„šæ‰‹æ¶ï¼‰è¿‡ç¨‹å’Œ `vue-cli-service` æœåŠ¡è¿‡ç¨‹æºç ï¼Œæ¥äº†è§£ vue-cli çš„ä¸¤å¤§æ ¸å¿ƒåŠŸèƒ½çš„å®ç°ã€‚

## åˆ›å»ºé¡¹ç›®è¿‡ç¨‹åˆ†æ

### **å®‰è£… Vue-Cli**

å¯ä»¥ä½¿ç”¨ä¸‹åˆ—ä»»ä¸€å‘½ä»¤å®‰è£…è¿™ä¸ªæ–°çš„åŒ…ï¼š

```shell
npm install -g @vue/cli
# OR
yarn global add @vue/cli
```

å®‰è£…ä¹‹åï¼Œä½ å°±å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­è®¿é—® `vue` å‘½ä»¤ã€‚

ä»¥ä¸Šé€šè¿‡å…¨å±€å®‰è£… `vue-cli`ï¼Œé»˜è®¤æƒ…å†µä¸‹ windows ä¼šå®‰è£…åˆ° `C:\Users\{{YourUserName}}\AppData\Roaming\npm\node_modules\@vue\cli` ç›®å½•ä¸­;

### **å‘½ä»¤è§£æ**

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ï¼š(è¯¦ç»†å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š[åˆ›å»ºä¸€ä¸ªé¡¹ç›® | Vue CLI (vuejs.org)](https://cli.vuejs.org/zh/guide/creating-a-project.html#vue-create))

```shell
vue create hello-world
```

> `vue create` å‘½ä»¤åœ¨ Windows ä¸‹çš„è§£ææµç¨‹å¸¸åœ¨ç”¨æˆ·æ‰§è¡Œå‘½ä»¤æ—¶è‡ªåŠ¨è¿›è¡Œï¼š
>
> 1. **å‘½ä»¤è¡Œè¾“å…¥**ï¼šå½“ä½ åœ¨å‘½ä»¤æç¤ºç¬¦ï¼ˆCommand Promptï¼‰æˆ– PowerShell ä¸­è¾“å…¥ `vue create` å‘½ä»¤æ—¶ï¼Œé¦–å…ˆä¼šæ£€æŸ¥ç³»ç»Ÿç¯å¢ƒå˜é‡ä¸­å®šä¹‰çš„å…¨å±€å®‰è£…åŒ…ç›®å½•ã€‚
> 2. **ç¯å¢ƒå˜é‡æŸ¥æ‰¾**ï¼šWindows ä¼šæ£€æŸ¥ç³»ç»Ÿçš„ `PATH` ç¯å¢ƒå˜é‡ä¸­åˆ—å‡ºçš„ç›®å½•ï¼Œå¯»æ‰¾ `@vue/cli` çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚åœ¨å…¨å±€å®‰è£… npm åŒ…æ—¶ï¼Œé€šå¸¸ä¼šå°†åŒ…çš„ bin ç›®å½•æ·»åŠ åˆ°ç³»ç»Ÿçš„ PATH ä¸­ã€‚
> 3. **å…¨å±€å®‰è£…åŒ…ç›®å½•**ï¼šæ‰¾åˆ° `@vue/cli` çš„å®‰è£…ä½ç½®åï¼Œç³»ç»Ÿä¼šåœ¨è¯¥ç›®å½•ä¸‹çš„ `bin` å­ç›®å½•ä¸­æŸ¥æ‰¾åä¸º `vue` çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚
> 4. **æ‰§è¡Œæ–‡ä»¶å…³è”**ï¼šä¸€æ—¦æ‰¾åˆ° `vue` å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç³»ç»Ÿä¼šå°†å…¶ä¸ `vue create` å‘½ä»¤å…³è”èµ·æ¥ã€‚è¿™æ„å‘³ç€å½“ä½ è¾“å…¥ `vue create` æ—¶ï¼Œå®é™…ä¸Šæ˜¯åœ¨æ‰§è¡Œè¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚
> 5. **å‘½ä»¤æ‰§è¡Œ**ï¼š`vue` å¯æ‰§è¡Œæ–‡ä»¶ä¼šæ¥æ”¶åˆ° `create` å‘½ä»¤åŠå…¶åç»­å‚æ•°ï¼ˆä¾‹å¦‚ `hello-world`ï¼‰ï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚è¿™é€šå¸¸æ¶‰åŠå¯åŠ¨ä¸€ä¸ªè„šæœ¬æ¥åˆ›å»ºæ–°çš„ Vue é¡¹ç›®ã€‚
> 6. **å­è¿›ç¨‹è°ƒç”¨**ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œ`vue create` å‘½ä»¤å¯èƒ½ä¼šé€šè¿‡å­è¿›ç¨‹è°ƒç”¨å…¶ä»–å·¥å…·æˆ–è„šæœ¬ï¼Œå¦‚ `yarn` æˆ– `npm`ï¼Œæ¥å®‰è£…é¡¹ç›®çš„ä¾èµ–é¡¹æˆ–æ‰§è¡Œå…¶ä»–åˆå§‹åŒ–ä»»åŠ¡ã€‚
> 7. **è¾“å‡ºä¸åé¦ˆ**ï¼šå‘½ä»¤çš„æ‰§è¡Œç»“æœï¼ˆå¦‚æˆåŠŸåˆ›å»ºé¡¹ç›®æˆ–é‡åˆ°é”™è¯¯ï¼‰ä¼šæ˜¾ç¤ºåœ¨å‘½ä»¤è¡Œç•Œé¢ä¸Šï¼Œä¸ºç”¨æˆ·æä¾›åé¦ˆã€‚

å½“è¿è¡Œ `vue create` å‘½ä»¤æ—¶ï¼Œé»˜è®¤ä¼šæ‰§è¡Œå®‰è£…çš„ `vue-cli` é¡¹ç›®ä¸‹çš„ `/bin/vue.js` æ–‡ä»¶ï¼ˆä»¥ä¸‹æ˜¯å…¨å±€å®‰è£…çš„ `vue-cli` é¡¹ç›®ç›®å½•ï¼‰ï¼š

![image-20240131164539288](../images/vue-cli.png)

> `/bin/vue.js` æ–‡ä»¶æ‰§è¡Œæµç¨‹ï¼š
>
> 1. æ£€æŸ¥ Node.js ç‰ˆæœ¬ï¼›
>
> 2. å®šä¹‰æ‰€æœ‰ vue å‘½ä»¤;
>
>    * vue ä½¿ç”¨ commander åº“å®šä¹‰å‘½ä»¤çš„é…ç½®é¡¹ï¼Œå¹¶åœ¨é…ç½®ä¸­æŒ‡æ˜å‘½ä»¤çš„æ‰§è¡Œæ–‡ä»¶ï¼›
>
>    * `vue create` å‘½ä»¤åœ¨æ–‡ä»¶ä¸­çš„å®šä¹‰å’Œæ‰§è¡Œè·¯å¾„å¦‚ä¸‹ï¼š
>
>      ![image-20240131170240448](../images/vue-createæ–‡ä»¶æ‰§è¡Œ.png)
>
> 3. è§£æ shell å‘½ä»¤ï¼Œå¹¶æ ¹æ®å‘½ä»¤æ‰§è¡Œè·¯å¾„æ‰§è¡Œå‘½ä»¤ï¼›

### **`vue create` å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹**

1. ç»ˆç«¯è¾“å…¥`vue create vue-test-app`;
2. ç»ˆç«¯è§£æå‡º`vue`ä¸»å‘½ä»¤;
3. ç»ˆç«¯åœ¨ç¯å¢ƒå˜é‡ä¸­æ‰¾åˆ°`vue`å‘½ä»¤;
4. ç»ˆç«¯æ ¹æ®`vue`å‘½ä»¤é“¾æ¥åˆ°å®é™…å¯æ‰§è¡Œæ–‡ä»¶vue.js;
5. ç»ˆç«¯åˆ©ç”¨ node æ‰§è¡Œ vue.js;
6. vue.js è§£æ command å’Œ option;
7. vue.js æ‰§è¡Œ command;
8. æ‰§è¡Œå®Œæ¯•ï¼Œé€€å‡ºæ‰§è¡Œ;

### **`vue create` å‘½ä»¤è§£æ**

æ‰§è¡Œ `vue create` å‘½ä»¤æ—¶ï¼Œæœ€ç»ˆæ˜¯è§£æ `./@vue/cli/lib/create.js` æ–‡ä»¶ï¼š

![image-20240131171951445](../images/vue-createæ–‡ä»¶åˆ†æ.png)

> `vue create` å‘½ä»¤ä¸»è¦æ‰§è¡Œä»¥ä¸‹é€»è¾‘ï¼š
>
> 1. æ£€æŸ¥è¾“å…¥çš„ projectName æ˜¯å¦ç¬¦åˆè§„èŒƒï¼›å¿…é¡»æŒ‡å®šä¸€ä¸ª `app-name `ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼›
> 2. åˆ¤æ–­ target  ç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œç„¶åé€šè¿‡äº¤äº’è¯¢é—®ç”¨æˆ·æ˜¯å¦è¦†ç›–ï¼ˆå¯¹åº”çš„æ˜¯æ“ä½œæ˜¯åˆ é™¤åŸç›®å½•;
> 3. åˆ›å»º Creator ç±»,å¹¶æ‰§è¡Œ`creator.create(options)`;

###  **Creator åˆ›å»ºé¡¹ç›®**

Creator ç±»æ˜¯ä¸»è¦åˆ›å»ºè„šæ‰‹æ¶çš„ç±»ï¼Œè¯¥ç±»å®šä¹‰å¦‚ä¸‹ï¼š

![image-20240131190642601](../images/creatorç±».png)

ç”±ä»¥ä¸Š Creator ç±»çš„å®šä¹‰ï¼Œåˆ›å»ºé¡¹ç›®çš„æ ¸å¿ƒæ–¹æ³•åœ¨ `Creator.create()` ä¸­ï¼š

```js
  // æ ¹æ®ç”¨æˆ·äº¤äº’æç¤ºåˆ›å»ºé¡¹ç›®
  async create(cliOptions = {}, preset = null) {
    // åˆ¤æ–­æ˜¯å¦æ˜¯æµ‹è¯•æˆ–è°ƒè¯•ç¯å¢ƒ
    const isTestOrDebug = process.env.VUE_CLI_TEST || process.env.VUE_CLI_DEBUG
    // è·å– runã€nameã€contextã€afterInvokeCbsã€afterAnyInvokeCbs äº”ä¸ªå±æ€§
    const { run, name, context, afterInvokeCbs, afterAnyInvokeCbs } = this

    // å¦‚æœæ²¡æœ‰æä¾›presetï¼Œåˆ™æ ¹æ®cliOptionsçš„å‚æ•°æ¥å†³å®šä½¿ç”¨å“ªä¸ªpreset
    if (!preset) {
      if (cliOptions.preset) {
        // vue create foo --preset bar
        preset = await this.resolvePreset(cliOptions.preset, cliOptions.clone)
      } else if (cliOptions.default) {
        // vue create foo --default
        preset = defaults.presets.default
      } else if (cliOptions.inlinePreset) {
        // vue create foo --inlinePreset {...}
        try {
          preset = JSON.parse(cliOptions.inlinePreset)
        } catch (e) {
          error(`CLI inline preset is not valid JSON: ${cliOptions.inlinePreset}`)
          exit(1)
        }
      } else {
        // ç”¨æˆ·æ²¡æœ‰æä¾›ä»»ä½•presetï¼Œå› æ­¤å¼¹å‡ºä¸€ä¸ªæç¤ºï¼Œè®©ç”¨æˆ·é€‰æ‹©
        preset = await this.promptAndResolvePreset()
      }
    }

    // clone before mutating
    // å…‹éš†ä¸€ä»½presetï¼Œå› ä¸ºåé¢ä¼šä¿®æ”¹å®ƒ
    preset = cloneDeep(preset)
    // inject core service
    // æ³¨å…¥æ ¸å¿ƒæœåŠ¡
    preset.plugins['@vue/cli-service'] = Object.assign({
      projectName: name
    }, preset)

    // åˆ¤æ–­cliOptions.bareæ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™å°†preset.plugins['@vue/cli-service'].bareè®¾ç½®ä¸ºtrue
    if (cliOptions.bare) {
      preset.plugins['@vue/cli-service'].bare = true
    }

    // legacy support for router
    // åˆ¤æ–­preset.routeræ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™å°†preset.plugins['@vue/cli-plugin-router']è®¾ç½®ä¸ºç©ºå¯¹è±¡
    if (preset.router) {
      preset.plugins['@vue/cli-plugin-router'] = {}

      // åˆ¤æ–­preset.routerHistoryModeæ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™å°†preset.plugins['@vue/cli-plugin-router'].historyModeè®¾ç½®ä¸ºtrue
      if (preset.routerHistoryMode) {
        preset.plugins['@vue/cli-plugin-router'].historyMode = true
      }
    }

    // Introducing this hack because typescript plugin must be invoked after router.
    // Currently we rely on the `plugins` object enumeration order,
    // which depends on the order of the field initialization.
    // FIXME: Remove this ugly hack after the plugin ordering API settled down
    // å¦‚æœpreset.pluginsä¸­åŒ…å«@vue/cli-plugin-routerå’Œ@vue/cli-plugin-typescriptï¼Œåˆ™åˆ é™¤@vue/cli-plugin-typescriptï¼Œå¹¶å°†@vue/cli-plugin-typescriptè®¾ç½®ä¸ºpreset.plugins['@vue/cli-plugin-typescript']
    if (preset.plugins['@vue/cli-plugin-router'] && preset.plugins['@vue/cli-plugin-typescript']) {
      const tmp = preset.plugins['@vue/cli-plugin-typescript']
      delete preset.plugins['@vue/cli-plugin-typescript']
      preset.plugins['@vue/cli-plugin-typescript'] = tmp
    }

    // legacy support for vuex
    // å¦‚æœpreset.vuexå­˜åœ¨ï¼Œåˆ™å°†preset.plugins['@vue/cli-plugin-vuex']è®¾ç½®ä¸ºç©ºå¯¹è±¡
    if (preset.vuex) {
      preset.plugins['@vue/cli-plugin-vuex'] = {}
    }

    // åŠ è½½cliOptionsä¸­çš„packageManagerå±æ€§ï¼Œå¦‚æœæ²¡æœ‰åˆ™åŠ è½½optionsä¸­çš„packageManagerå±æ€§ï¼Œ
    // å¦‚æœæ²¡æœ‰åˆ™æ ¹æ®æ˜¯å¦æœ‰yarnï¼Œpnpm3æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œè¿”å›å¯¹åº”çš„packageManager
    const packageManager = (
      cliOptions.packageManager ||
      loadOptions().packageManager ||
      (hasYarn() ? 'yarn' : null) ||
      (hasPnpm3OrLater() ? 'pnpm' : 'npm')
    )

    await clearConsole()
    const pm = new PackageManager({ context, forcePackageManager: packageManager })

    log(`âœ¨  Creating project in ${chalk.yellow(context)}.`)
    this.emit('creation', { event: 'creating' })

    // get latest CLI plugin version
    const { latestMinor } = await getVersions()

    // generate package.json with plugin dependencies
    const pkg = {
      name,
      version: '0.1.0',
      private: true,
      devDependencies: {},
      ...resolvePkg(context)
    }
    const deps = Object.keys(preset.plugins)
    deps.forEach(dep => {
      // è¿‡æ»¤æ‰ preset æ’ä»¶
      if (preset.plugins[dep]._isPreset) {
        return
      }

      let { version } = preset.plugins[dep]

      // å¦‚æœæ²¡æœ‰æŒ‡å®šç‰ˆæœ¬ï¼Œåˆ™æ ¹æ®ä¸åŒçš„æ’ä»¶ç±»å‹ï¼Œä½¿ç”¨ä¸åŒçš„é»˜è®¤ç‰ˆæœ¬
      if (!version) {
        if (isOfficialPlugin(dep) || dep === '@vue/cli-service' || dep === '@vue/babel-preset-env') {
          version = isTestOrDebug ? `file:${path.resolve(__dirname, '../../../', dep)}` : `~${latestMinor}`
        } else {
          version = 'latest'
        }
      }

      // æ·»åŠ åˆ°ä¾èµ–ä¸­
      pkg.devDependencies[dep] = version
    })

    // write package.json
    // å†™å…¥æ–‡ä»¶æ ‘ï¼Œcontextä¸ºä¸Šä¸‹æ–‡ï¼Œpkgä¸ºåŒ…ä¿¡æ¯
    await writeFileTree(context, {
      'package.json': JSON.stringify(pkg, null, 2)
    })

    // generate a .npmrc file for pnpm, to persist the `shamefully-flatten` flag
    if (packageManager === 'pnpm') {
      const pnpmConfig = hasPnpmVersionOrLater('4.0.0')
        ? 'shamefully-hoist=true\n'
        : 'shamefully-flatten=true\n'

      await writeFileTree(context, {
        '.npmrc': pnpmConfig
      })
    }

    if (packageManager === 'yarn' && semver.satisfies(process.version, '8.x')) {
      // Vue CLI 4.x should support Node 8.x,
      // but some dependenices already bumped `engines` field to Node 10
      // and Yarn treats `engines` field too strictly
      await writeFileTree(context, {
        '.yarnrc': '# Hotfix for Node 8.x\n--install.ignore-engines true\n'
      })
    }

    // intilaize git repository before installing deps
    // so that vue-cli-service can setup git hooks.
    // åˆ¤æ–­æ˜¯å¦åˆå§‹åŒ–gitä»“åº“
    const shouldInitGit = this.shouldInitGit(cliOptions)
    if (shouldInitGit) {
      log(`ğŸ—ƒ  Initializing git repository...`)
      this.emit('creation', { event: 'git-init' })
      await run('git init')//åˆå§‹åŒ–gitä»“åº“
    }

    // install plugins
    log(`âš™\u{fe0f}  Installing CLI plugins. This might take a while...`)
    log()
    this.emit('creation', { event: 'plugins-install' })

    // å¦‚æœisTestOrDebugä¸ºtrueï¼Œä¸”process.env.VUE_CLI_TEST_DO_INSTALL_PLUGINä¸ºfalseï¼Œåˆ™æ‰§è¡ŒsetupDevProjectå‡½æ•°ï¼Œå¦åˆ™æ‰§è¡Œinstallå‡½æ•°
    if (isTestOrDebug && !process.env.VUE_CLI_TEST_DO_INSTALL_PLUGIN) {
      // in development, avoid installation process
      await require('./util/setupDevProject')(context)
    } else {
      await pm.install()
    }

    // run generator
    this.emit('creation', { event: 'invoking-generators' })
    // è§£ææ’ä»¶
    const plugins = await this.resolvePlugins(preset.plugins, pkg)
    // åˆ›å»ºç”Ÿæˆå™¨
    const generator = new Generator(context, {
      pkg,
      plugins,
      afterInvokeCbs,
      afterAnyInvokeCbs
    })
    // ç”Ÿæˆæ–‡ä»¶
    await generator.generate({
      extractConfigFiles: preset.useConfigFiles
    })

    // install additional deps (injected by generators)
    log(`ğŸ“¦  Installing additional dependencies...`)
    this.emit('creation', { event: 'deps-install' })
    log()
    // åˆ¤æ–­æ˜¯å¦æ˜¯æµ‹è¯•æˆ–è€…è°ƒè¯•ç¯å¢ƒï¼Œæˆ–è€…VUE_CLI_TEST_DO_INSTALL_PLUGINç¯å¢ƒå˜é‡æ˜¯å¦ä¸ºtrue
    if (!isTestOrDebug || process.env.VUE_CLI_TEST_DO_INSTALL_PLUGIN) {
      // å®‰è£…æ’ä»¶
      await pm.install()
    }

    // run complete cbs if any (injected by generators)
    log(`âš“  Running completion hooks...`)
    // è§¦å‘åˆ›å»ºäº‹ä»¶
    this.emit('creation', { event: 'completion-hooks' })
    // æ‰§è¡ŒafterInvokeCbsä¸­çš„å›è°ƒå‡½æ•°
    for (const cb of afterInvokeCbs) {
      await cb()
    }
    // æ‰§è¡ŒafterAnyInvokeCbsä¸­çš„å›è°ƒå‡½æ•°
    for (const cb of afterAnyInvokeCbs) {
      await cb()
    }
    // ç”Ÿæˆ  README.md
    if (!generator.files['README.md']) {
      // generate README.md
      log()
      log('ğŸ“„  Generating README.md...')
      await writeFileTree(context, {
        'README.md': generateReadme(generator.pkg, packageManager)
      })
    }

    // commit initial state
    let gitCommitFailed = false
    if (shouldInitGit) {
      // æ·»åŠ æ‰€æœ‰æ–‡ä»¶åˆ° git
      await run('git add -A')
      if (isTestOrDebug) {
        // è®¾ç½®æµ‹è¯•é…ç½®
        await run('git', ['config', 'user.name', 'test'])
        await run('git', ['config', 'user.email', 'test@test.com'])
        await run('git', ['config', 'commit.gpgSign', 'false'])
      }
      const msg = typeof cliOptions.git === 'string' ? cliOptions.git : 'init'
      try {
        // æäº¤
        await run('git', ['commit', '-m', msg, '--no-verify'])
      } catch (e) {
        // å¦‚æœæäº¤å¤±è´¥ï¼Œåˆ™è®¾ç½®gitCommitFailedä¸ºtrue
        gitCommitFailed = true
      }
    }

    // log instructions
    log()
    log(`ğŸ‰  Successfully created project ${chalk.yellow(name)}.`)
    if (!cliOptions.skipGetStarted) {
      log(
        `ğŸ‘‰  Get started with the following commands:\n\n` +
        (this.context === process.cwd() ? `` : chalk.cyan(` ${chalk.gray('$')} cd ${name}\n`)) +
        chalk.cyan(` ${chalk.gray('$')} ${packageManager === 'yarn' ? 'yarn serve' : packageManager === 'pnpm' ? 'pnpm run serve' : 'npm run serve'}`)
      )
    }
    log()
    this.emit('creation', { event: 'done' })

    if (gitCommitFailed) {
      warn(
        `Skipped git commit due to missing username and email in git config, or failed to sign commit.\n` +
        `You will need to perform the initial commit yourself.\n`
      )
    }

    generator.printExitLogs()
  }
```

> `Creator.create()` æ–¹æ³•ä¸»è¦é€»è¾‘ï¼š
>
> 1. preset é¢„è®¾å‚æ•°åˆå§‹åŒ–ï¼›
>
>    * Preset æ˜¯ä¸€ä¸ªåŒ…å«åˆ›å»ºæ–°é¡¹ç›®æ‰€éœ€é¢„å®šä¹‰é€‰é¡¹å’Œæ’ä»¶çš„ JSON å¯¹è±¡ï¼Œè®©ç”¨æˆ·æ— éœ€åœ¨å‘½ä»¤æç¤ºä¸­é€‰æ‹©å®ƒä»¬ã€‚
>
> 2. åŒ…ç®¡ç†å™¨å®ä¾‹åˆå§‹åŒ–ï¼›
>
> 3. æ ¹æ®æ’ä»¶ä¾èµ–ç”Ÿæˆ package.json æ–‡ä»¶ï¼›
>
>    * Vue CLI åœ¨åˆ›å»ºç›®å½•ä¸‹å†™å…¥ä¸€ä¸ªåŸºç¡€çš„ `package.json`
>
> 4. æ ¹æ®åŒ…ç®¡ç†å™¨è‡ªåŠ¨åˆ¤æ–­ NPM æºï¼Œç”Ÿæˆå¯¹åº”ç®¡ç†å™¨çš„ xxxrc æ–‡ä»¶ï¼›
>
> 5. åˆ¤æ–­æ˜¯å¦åˆå§‹åŒ– Git ä»“åº“ï¼Œå¹¶åˆå§‹åŒ– Git ä»“åº“ç¯å¢ƒï¼›
>
> 6. åˆ¤æ–­æ˜¯å¦ä¸ºæ˜¯æµ‹è¯•æˆ–è°ƒè¯•ç¯å¢ƒï¼š
>
>    * æ˜¯ï¼Œåˆ™è°ƒç”¨`setupDevProject` å¯åŠ¨å¼€å‘æœåŠ¡ï¼›åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œé¿å…å®‰è£…è¿‡ç¨‹ï¼›
>    * å¦ï¼Œæ ¹æ® package.json æ–‡ä»¶å®‰è£…é¡¹ç›®ä¾èµ–ï¼›
>
> 7. ç”Ÿæˆé¡¹ç›®æ–‡ä»¶ï¼š è§£ææ’ä»¶å¯¹è±¡ï¼Œå¹¶åˆ›å»ºç”Ÿæˆå™¨å®ä¾‹ç”Ÿæˆé¡¹ç›®æ–‡ä»¶ï¼›
>
>    ```js
>        // è§£ææ’ä»¶
>        const plugins = await this.resolvePlugins(preset.plugins, pkg)
>        // åˆ›å»ºç”Ÿæˆå™¨
>        const generator = new Generator(context, {
>          pkg,
>          plugins,
>          afterInvokeCbs,
>          afterAnyInvokeCbs
>        })
>        // ç”Ÿæˆæ–‡ä»¶
>        await generator.generate({
>          extractConfigFiles: preset.useConfigFiles
>        })
>    ```
>
> 8. å®‰è£…ç”±ç”Ÿæˆå™¨å®ä¾‹æ³¨å…¥çš„ä¾èµ–ï¼›
>
> 9. è¿è¡Œåˆå§‹åŒ–åçš„å›è°ƒï¼›
>
> 10. ç”Ÿæˆ  README.mdï¼›
>
> 11. æš‚å­˜ git ï¼Œæ‹‰å–è¿œç¨‹ presetï¼›
>
> 12. æ‰“å°åˆ›å»ºç»“æœï¼›
>
> `Creator`  ç±»æ˜¯ç»§æ‰¿äº Node.js çš„ `EventEmitter` ç±»,`events`  æ˜¯ Node.js ä¸­æœ€é‡è¦çš„ä¸€ä¸ªæ¨¡å—ï¼Œè€Œ `EventEmitter` ç±»å°±æ˜¯å…¶åŸºç¡€ï¼Œæ˜¯ Node.js ä¸­äº‹ä»¶è§¦å‘ä¸äº‹ä»¶ç›‘å¬ç­‰åŠŸèƒ½çš„å°è£…ã€‚
>
> åœ¨ `create`  è¿‡ç¨‹ä¸­ `emit`  ä¸€äº›äº‹ä»¶ï¼š
>
> ```javascript
> this.emit('creation', { event: 'creating' }); // åˆ›å»ºé¡¹ç›®æ—¶
> this.emit('creation', { event: 'git-init' }); // åˆå§‹åŒ– git æ—¶
> this.emit('creation', { event: 'plugins-install' }); // å®‰è£…æ’ä»¶
> this.emit('creation', { event: 'invoking-generators' }); // è°ƒç”¨ generator
> this.emit('creation', { event: 'deps-install' }); // å®‰è£…é¢å¤–çš„ä¾èµ–
> this.emit('creation', { event: 'completion-hooks' }); // å®Œæˆä¹‹åçš„å›è°ƒ
> this.emit('creation', { event: 'done' }); // create æµç¨‹ç»“æŸ
> this.emit('creation', { event: 'fetch-remote-preset' }); // æ‹‰å–è¿œç¨‹ preset
> ```

`Creator.create()` æ–¹æ³•ä¸»è¦æ‰§è¡Œé¡¹ç›®çš„å‚æ•°åˆå§‹åŒ–ã€åŒ…ç®¡ç†åˆå§‹åŒ–ã€npm åˆå§‹åŒ–ã€ä»“åº“åˆå§‹åŒ–ï¼Œé€šè¿‡Generatorç”Ÿæˆé¡¹ç›®æ–‡ä»¶ï¼Œå¹¶å®‰è£…é¡¹ç›®ä¾èµ–ï¼›

### **Generator ç”Ÿæˆé¡¹ç›®æ–‡ä»¶**

é€šè¿‡ä»¥ä¸Šåˆ†æå¯çŸ¥ï¼Œ`Creator.create()` æ–¹æ³•ç”¨äºåˆ›å»ºé¡¹ç›®,Generator å¯¹è±¡åˆ›å»ºç”Ÿæˆé¡¹ç›®æ–‡ä»¶ï¼š

![image-20240131200047619](../images/vue-cli-æ–‡ä»¶ç”Ÿæˆå¯¹è±¡å®šä¹‰.png)

Generator å¯¹è±¡é€šè¿‡ `Generator.generate` æ–¹æ³•ç”Ÿæˆ  Vue é¡¹ç›®æ–‡ä»¶ï¼š

```js
  //ç”Ÿæˆæ–‡ä»¶ç³»ç»Ÿ
  async generate({
    extractConfigFiles = false,
    checkExisting = false
  } = {}) {
    //åˆå§‹åŒ–æ’ä»¶
    await this.initPlugins()

    // save the file system before applying plugin for comparison
    const initialFiles = Object.assign({}, this.files)
    // extract configs from package.json into dedicated files.
    //æå–é…ç½®æ–‡ä»¶ä» package.json ä¸­ï¼Œå¹¶å°†å®ƒä»¬åˆ†è§£ä¸ºå•ç‹¬çš„æ–‡ä»¶
    this.extractConfigFiles(extractConfigFiles, checkExisting)
    // wait for file resolve
    //ç­‰å¾…æ–‡ä»¶è§£æ
    await this.resolveFiles()
    // set package.json
    //æ’åº package.json å¹¶å°†å…¶æ·»åŠ åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­
    this.sortPkg()
    this.files['package.json'] = JSON.stringify(this.pkg, null, 2) + '\n'
    // write/update file tree to disk
    //å°†æ–‡ä»¶ç³»ç»Ÿå†™å…¥ç£ç›˜
    await writeFileTree(this.context, this.files, initialFiles)
  }
```

> generate æ–¹æ³•ç”¨äºç”Ÿæˆæ–‡ä»¶ç³»ç»Ÿã€‚å®ƒæ¥å—ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå¯ä»¥è®¾ç½®ä¸¤ä¸ªé€‰é¡¹ï¼š`extractConfigFiles` å’Œ `checkExisting`ã€‚
>
> å‡½æ•°çš„å®ç°åŸç†å¦‚ä¸‹ï¼š
>
> 1. é¦–å…ˆï¼Œåˆå§‹åŒ–æ’ä»¶ã€‚
> 2. ä» `package.json` ä¸­æå–é…ç½®æ–‡ä»¶ï¼Œå¹¶å°†å®ƒä»¬åˆ†è§£ä¸ºå•ç‹¬çš„æ–‡ä»¶ã€‚
> 3. ç­‰å¾…æ–‡ä»¶è§£æã€‚
> 4. æ’åº `package.json` å¹¶å°†å…¶æ·»åŠ åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚
> 5. å°†æ–‡ä»¶ç³»ç»Ÿå†™å…¥ç£ç›˜ã€‚
>
> æ³¨æ„äº‹é¡¹ï¼š
>
> - ç¡®ä¿åœ¨è°ƒç”¨æ­¤å‡½æ•°ä¹‹å‰å·²æ­£ç¡®åˆå§‹åŒ–ä¸Šä¸‹æ–‡å’Œæ–‡ä»¶ç³»ç»Ÿã€‚
> - è®¾ç½® `extractConfigFiles` ä¸º `true` ä»¥ä» `package.json` ä¸­æå–é…ç½®æ–‡ä»¶ã€‚
> - è®¾ç½® `checkExisting` ä¸º `true` ä»¥åœ¨æå–é…ç½®æ–‡ä»¶ä¹‹å‰æ£€æŸ¥ç°æœ‰æ–‡ä»¶ã€‚
> - æ­¤å‡½æ•°ä¸ºå¼‚æ­¥å‡½æ•°ï¼Œåº”åœ¨é€‚å½“çš„äº‹ä»¶å¾ªç¯æˆ–å›è°ƒå‡½æ•°ä¸­ä½¿ç”¨ã€‚
> - å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨å‡½æ•°ç»“æŸåæ£€æŸ¥é”™è¯¯å¹¶å¤„ç†å®ƒä»¬ã€‚

### **åˆå§‹åŒ–æ’ä»¶**

 `Generator.generate` æ–¹æ³•ç”Ÿæˆ  Vue é¡¹ç›®æ–‡ä»¶ç¬¬ä¸€æ­¥ä¸­ï¼Œå…ˆæ‰§è¡Œçš„æ˜¯ä¸€ä¸ª `initPlugins`  æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```javascript
async initPlugins () {
  for (const id of this.allPluginIds) {
    const api = new GeneratorAPI(id, this, {}, rootOptions)
    const pluginGenerator = loadModule(`${id}/generator`, this.context)

    if (pluginGenerator && pluginGenerator.hooks) {
      await pluginGenerator.hooks(api, {}, rootOptions, pluginIds)
    }
  }
}
```

åœ¨è¿™é‡Œä¼šç»™æ¯ä¸€ä¸ª `package.json`  é‡Œçš„æ’ä»¶åˆå§‹åŒ–ä¸€ä¸ª `GeneratorAPI`  å®ä¾‹ï¼Œå°†å®ä¾‹ä¼ å…¥å¯¹åº”æ’ä»¶çš„ `generator`  æ–¹æ³•å¹¶æ‰§è¡Œ:

```js
 loadModule(`${id}/generator`, this.context)
```

é€šè¿‡ä»¥ä¸Šä»£ç æ‰§è¡Œæ—¶ï¼Œä¼šåŠ è½½ä¸¤ç±»æ’ä»¶ï¼š

* `cli-service` æ’ä»¶ï¼š Vue CLI çš„æ ¸å¿ƒæ’ä»¶ï¼›
* `cli-plugin-xxx/`æ‰©å±•æ’ä»¶ï¼šé¢„é€‰é¡¹æ’ä»¶ï¼Œæ ¹æ®ç”¨æˆ·é€‰æ‹©åŠ è½½ï¼›

**åŠ è½½`cli-service` æ ¸å¿ƒæ’ä»¶ï¼š**

åŠ è½½`cli-service` æ ¸å¿ƒæ’ä»¶ï¼Œä¼šæ‰§è¡Œ `@vue/cli-service/generator/index.js` ç›®å½•ï¼š

![image-20240201103647431](../images/image-20240201103647431.png)

> `cli-service` æ ¸å¿ƒæ’ä»¶çš„ generator æ–¹æ³•ä¸»è¦é€»è¾‘ï¼š
>
> 1. æ¸²æŸ“ Vue é¡¹ç›®æ¨¡æ¿ï¼›
>
>    * Vue é¡¹ç›®æ¨¡æ¿ä½äº  `@vue/cli-service/tempalte/` ç›®å½•ï¼Œå¯ä»¥çœ‹åˆ°è¯¥ç›®å½•ä¸‹æ–‡ä»¶å³ä¸ºä¸€ä¸ªä½¿ç”¨ vue-cli åˆ›å»ºçš„ vue åŸºç¡€é¡¹ç›®ç›®å½•æ–‡ä»¶ï¼›
>
>    *  `api.render` ä¼šé€šè¿‡ EJS å°†æ¨¡æ¿æ–‡ä»¶æ¸²æŸ“æˆå­—ç¬¦ä¸²æ”¾åœ¨å†…å­˜ä¸­ã€‚
>
>      
>
> 2. é€šè¿‡ `extendPackage` å¾€ `pacakge.json` ä¸­å†™å…¥ `Vue`   çš„ç›¸å…³ä¾èµ–å’Œ scriptï¼›
>
> 3. é€šè¿‡ `extendPackage` å¾€ `pacakge.json` ä¸­å†™å…¥ `CSS` é¢„å¤„ç†å‚æ•°;
>
> 4. è°ƒç”¨ router æ’ä»¶å’Œ vuex æ’ä»¶ã€‚
>
> æ‰§è¡Œäº† `generate`  çš„æ‰€æœ‰é€»è¾‘ä¹‹åï¼Œå†…å­˜ä¸­å·²ç»æœ‰äº†éœ€è¦è¾“å‡ºçš„å„ç§æ–‡ä»¶ï¼Œæ”¾åœ¨ `this.files`  é‡Œã€‚ `generate`  çš„æœ€åä¸€æ­¥å°±æ˜¯è°ƒç”¨ `writeFileTree`  å°†å†…å­˜ä¸­çš„æ‰€æœ‰æ–‡ä»¶å†™å…¥åˆ°ç¡¬ç›˜



**åŠ è½½`cli-plugin-xxx/`æ‰©å±•æ’ä»¶ï¼š**

åŠ è½½`cli-plugin-xxx/`æ‰©å±•æ’ä»¶ï¼Œä¼šå» `@vue/` ç›®å½•ä¸‹åŠ è½½å¯¹åº” `cli-plugin-xxx/generator.js` æ’ä»¶çš„  generator æ–¹æ³•ã€‚

ä»¥åŠ è½½ `@vue/cli-plugin-babel` æ’ä»¶çš„  `@vue/cli-plugin-babel/generator.js` ä¸ºä¾‹ï¼š

æ‰§è¡Œä»¥ä¸Šä»£ç æ—¶å€™ï¼Œä¼šåœ¨å½“å‰é¡¹ç›®çš„ `./node_modules/@vue/cli-plugin-babel/`  ç›®å½•ä¸‹åŠ è½½ `generator.js` æ–‡ä»¶ï¼š

![image-20240201100829288](../images/vue-cli-babel-generator.png)

> è¿™é‡Œ `api`  å°±æ˜¯ä¸€ä¸ª `GeneratorAPI` å®ä¾‹ï¼Œè¿™é‡Œç”¨åˆ°äº†ä¸€ä¸ª `extendPackage`  æ–¹æ³•ï¼š
>
> ```javascript
> // GeneratorAPI.js
> // åˆ å‡éƒ¨åˆ†ä»£ç ï¼Œåªé’ˆå¯¹ @vue/cli-plugin-babel åˆ†æ
> extendPackage (fields, options = {}) {
>   const pkg = this.generator.pkg
>   const toMerge = isFunction(fields) ? fields(pkg) : fields
>   // éå†ä¼ å…¥çš„å‚æ•°ï¼Œè¿™é‡Œæ˜¯ babel å’Œ dependencies ä¸¤ä¸ªå¯¹è±¡
>   for (const key in toMerge) {
>     const value = toMerge[key]
>     const existing = pkg[key]
>     // å¦‚æœ key çš„åç§°æ˜¯ dependencies å’Œ devDependencies
>     // å°±é€šè¿‡ mergeDeps æ–¹æ³•å¾€ package.json åˆå¹¶ä¾èµ–
>     if (isObject(value) && (key === 'dependencies' || key === 'devDependencies')) {
>       pkg[key] = mergeDeps(
>         this.id,
>         existing || {},
>         value,
>         this.generator.depSources,
>         extendOptions
>       )
>     } else if (!extendOptions.merge || !(key in pkg)) {
>       pkg[key] = value
>     }
>   }
> }
> 
> ```

é€šè¿‡`extendPackage`  æ–¹æ³•åŠ è½½ `cli-plugin-babel` åï¼Œé»˜è®¤çš„ `package.json`  å°±å˜æˆï¼š

```javascript
{
  "babel": {
    "presets": ["@vue/cli-plugin-babel/preset"]
  },
  "dependencies": {
    "core-js": "^3.6.5"
  },
  "devDependencies": {},
  "name": "test",
  "private": true,
  "version": "0.1.0"
}
```





## **CLI æœåŠ¡åˆ†æ**

### **ä½¿ç”¨**

åœ¨ä¸€ä¸ª Vue CLI é¡¹ç›®ä¸­ï¼Œ`@vue/cli-service` å®‰è£…äº†ä¸€ä¸ªåä¸º `vue-cli-service` çš„å‘½ä»¤ã€‚

å¯ä»¥åœ¨ npm scripts ä¸­ä»¥ `vue-cli-service`ã€æˆ–è€…ä»ç»ˆç«¯ä¸­ä»¥ `./node_modules/.bin/vue-cli-service` è®¿é—®è¿™ä¸ªå‘½ä»¤ã€‚

è¿™æ˜¯ä½ ä½¿ç”¨é»˜è®¤ preset çš„é¡¹ç›®çš„ `package.json`ï¼š

```shell
{
  "scripts": {
    "serve": "vue-cli-service serve",
    "build": "vue-cli-service build"
  }
}
```

ä½ å¯ä»¥é€šè¿‡ npm æˆ– Yarn è°ƒç”¨è¿™äº› scriptï¼š

```shell
npm run serve
# OR
yarn serve
```

å¦‚æœä½ å¯ä»¥ä½¿ç”¨ [npx](https://github.com/npm/npx) (æœ€æ–°ç‰ˆçš„ npm åº”è¯¥å·²ç»è‡ªå¸¦)ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¿™æ ·è°ƒç”¨å‘½ä»¤ï¼š

```shell
npx vue-cli-service serve
```



### **Shell å‘½ä»¤è§£æ**

1. åœ¨ shell å‘½ä»¤è¡Œä¸­è¾“å…¥ `npm run serve` æ—¶å€™ï¼Œä¼šæ‰§è¡Œ `vue-cli-service serve`
2. å½“é‡åˆ° `vue-cli-service` å‘½ä»¤æ—¶ï¼Œä¼šåœ¨ `./node_modules/.bin` ç›®å½•ä¸‹æ ¹æ® windows æˆ– mac å¹³å°æŸ¥æ‰¾ shell æˆ– cmd è„šæœ¬æ‰§è¡Œï¼Œåœ¨ windows å¹³å°ä¸‹ä¼šæ‰§è¡Œ `./node_modules/.bin/vue-cli-service.cmd` :

![image-20240129173804799](../images/vue-cli-serveræºç åˆ†æ.png)

3. è¯¥æ‰¹å¤„ç†è„šæœ¬çš„ä¸»è¦ä½œç”¨æ˜¯æ‰¾åˆ°å¹¶è®¾ç½®Vue CLIæœåŠ¡çš„æ‰§è¡Œè·¯å¾„ï¼Œç„¶åä½¿ç”¨Node.jsæ¥è¿è¡ŒVue CLIæœåŠ¡ï¼ŒVue CLIæœåŠ¡çš„æ‰§è¡Œè·¯å¾„æ‰§è¡Œè·¯å¾„ä¸º `..\@vue\cli-service\bin\vue-cli-service.js`

`vue-cli-service.js` æ–‡ä»¶ä¸»è¦ä½œç”¨æ˜¯**æ£€æŸ¥è¿è¡Œç¯å¢ƒã€è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œå¹¶è¿è¡Œ Vue CLI æœåŠ¡**:

```js

// è®¾å®šè„šæœ¬çš„è§£é‡Šå™¨ä¸º nodeï¼Œè¿™æ ·è¿™ä¸ªè„šæœ¬å°±æ˜¯ä¸€ä¸ª node è„šæœ¬ï¼Œå¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œã€‚  
#!/usr/bin/env node  
  
// ä» '@vue/cli-shared-utils' æ¨¡å—ä¸­å¼•å…¥ 'semver' å’Œ 'error' å‡½æ•°ã€‚'semver' ç”¨äºå¤„ç†è¯­ä¹‰ç‰ˆæœ¬ï¼Œ'error' ç”¨äºè¾“å‡ºé”™è¯¯ä¿¡æ¯ã€‚  
const { semver, error } = require('@vue/cli-shared-utils')  
  
// ä» '../package.json' æ–‡ä»¶ä¸­è·å– 'engines.node' çš„å€¼ï¼Œè¿™ä¸ªå€¼æ˜¯è¿è¡Œè¿™ä¸ªè„šæœ¬æ‰€éœ€è¦çš„ Node.js çš„ç‰ˆæœ¬ã€‚  
const requiredVersion = require('../package.json').engines.node  
  
// æ£€æŸ¥å½“å‰è¿è¡Œçš„ Node.js ç‰ˆæœ¬æ˜¯å¦æ»¡è¶³ 'requiredVersion'ï¼Œå¦‚æœä¸æ»¡è¶³ï¼Œåˆ™è¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶é€€å‡ºè¿›ç¨‹ã€‚  
if (!semver.satisfies(process.version, requiredVersion)) {  
  error(  
    `You are using Node ${process.version}, but vue-cli-service ` +  
    `requires Node ${requiredVersion}.\nPlease upgrade your Node version.`  
  )  
  process.exit(1)  
}  
  
// ä» '../lib/Service' æ–‡ä»¶ä¸­å¼•å…¥ 'Service' ç±»ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„ 'Service' å®ä¾‹ã€‚  
const Service = require('../lib/Service')  
const service = new Service(process.env.VUE_CLI_CONTEXT || process.cwd())  
  
// è·å–å‘½ä»¤è¡Œå‚æ•°ï¼ˆé™¤äº†è„šæœ¬åå’Œè·¯å¾„å‚æ•°ï¼‰ï¼Œå¹¶å­˜å‚¨åˆ° 'rawArgv' ä¸­ã€‚  
const rawArgv = process.argv.slice(2)  
  
// ä½¿ç”¨ 'minimist' åº“è§£æ 'rawArgv' ä¸­çš„å‚æ•°ã€‚è¿™é‡Œå®šä¹‰äº†ä¸€äº›å¸ƒå°”ç±»å‹çš„å‚æ•°ã€‚  
const args = require('minimist')(rawArgv, {  
  boolean: [  
    // build  
    'modern',  
    'report',  
    'report-json',  
    'inline-vue',  
    'watch',  
    // serve  
    'open',  
    'copy',  
    'https',  
    // inspect  
    'verbose'  
  ]  
})  
  
// è·å– 'args._[0]'ï¼Œå³ç¬¬ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼ˆä¸åŒ…æ‹¬å‚æ•°åï¼‰ï¼Œè¿™ä¸ªå‚æ•°é€šå¸¸è¡¨ç¤ºå‘½ä»¤ã€‚  
const command = args._[0]  
  
// è¿è¡Œ 'service' çš„ 'run' æ–¹æ³•ï¼Œä¼ å…¥å‘½ä»¤ã€å‚æ•°å’ŒåŸå§‹çš„å‘½ä»¤è¡Œå‚æ•°ã€‚å¦‚æœè¿è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œåˆ™æ•è·å¹¶è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œç„¶åé€€å‡ºè¿›ç¨‹ã€‚  
service.run(command, args, rawArgv).catch(err => {  
  error(err)  
  process.exit(1)  
})

```

> ä»¥ä¸Šä»£ç ä¸»è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
>
> 1. **æ£€æŸ¥è¿è¡Œç¯å¢ƒ**ï¼šé¦–å…ˆï¼Œè„šæœ¬æ£€æŸ¥å½“å‰è¿è¡Œçš„ Node.js ç‰ˆæœ¬æ˜¯å¦æ»¡è¶³æ‰€éœ€çš„ç‰ˆæœ¬è¦æ±‚ã€‚å¦‚æœä¸æ»¡è¶³ï¼Œå®ƒä¼šè¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶é€€å‡ºè¿›ç¨‹ã€‚
> 2. **è§£æå‘½ä»¤è¡Œå‚æ•°**ï¼šç„¶åï¼Œè„šæœ¬ä½¿ç”¨ 'minimist' åº“è§£æå‘½ä»¤è¡Œå‚æ•°ã€‚å®ƒå®šä¹‰äº†ä¸€äº›å¸ƒå°”ç±»å‹çš„å‚æ•°ï¼Œå¹¶æ ¹æ®è¿™äº›å‚æ•°çš„å€¼è®¾ç½®ç›¸åº”çš„æ•°æ®ç»“æ„ã€‚
> 3. **è¿è¡Œ Vue CLI æœåŠ¡**ï¼šæœ€åï¼Œè„šæœ¬è¿è¡Œ 'service' çš„ 'run' æ–¹æ³•ï¼Œä¼ å…¥å‘½ä»¤ã€å‚æ•°å’ŒåŸå§‹çš„å‘½ä»¤è¡Œå‚æ•°ã€‚å¦‚æœè¿è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œå®ƒä¼šæ•è·å¹¶è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œç„¶åé€€å‡ºè¿›ç¨‹ã€‚

`vue-cli-service` å¸¸ç”¨å‘½ä»¤ï¼š

* **`vue-cli-service serve` å‘½ä»¤:** å¯åŠ¨ä¸€ä¸ªå¼€å‘æœåŠ¡å™¨ (åŸºäº [webpack-dev-server](https://github.com/webpack/webpack-dev-server)) å¹¶é™„å¸¦å¼€ç®±å³ç”¨çš„æ¨¡å—çƒ­é‡è½½ (Hot-Module-Replacement)ã€‚

  ```shell
  ç”¨æ³•ï¼švue-cli-service serve [options] [entry]
  ```

* **`vue-cli-service build` å‘½ä»¤:**  ä¼šåœ¨ `dist/` ç›®å½•äº§ç”Ÿä¸€ä¸ªå¯ç”¨äºç”Ÿäº§ç¯å¢ƒçš„åŒ…ï¼Œå¸¦æœ‰ JS/CSS/HTML çš„å‹ç¼©ï¼Œå’Œä¸ºæ›´å¥½çš„ç¼“å­˜è€Œåšçš„è‡ªåŠ¨çš„ vendor chunk splittingã€‚å®ƒçš„ chunk manifest ä¼šå†…è”åœ¨ HTML é‡Œã€‚

  ```shell
  ç”¨æ³•ï¼švue-cli-service build [options] [entry|pattern]
  ```

é€šè¿‡ä»¥ä¸Šä»£ç å¯çŸ¥ï¼Œ`vue-cli-service` å‘½ä»¤æ‰§è¡Œå‰ï¼Œå…ˆåˆ›å»ºäº†ä¸€ä¸ª Service ç±»ï¼Œå¹¶é€šè¿‡ `service.run()` æ–¹æ³•æ‰§è¡Œæ‰§è¡Œå‘½ä»¤ã€‚

### **Service å¯¹è±¡åˆå§‹åŒ–**

Service å¯¹è±¡å®šä¹‰ä½äº `./node_modules/@vue/cli-service/lib/Service.js` ä¸­;

`Service`çš„ç±»åŒ…å«äº†Vue CLIä¸­çš„æœåŠ¡å¯¹è±¡ã€‚

æœåŠ¡å¯¹è±¡è´Ÿè´£**å¤„ç†å‘½ä»¤è¡Œé€‰é¡¹ã€æ’ä»¶åŠ è½½ã€Webpacké…ç½®å’Œå…¶ä»–ä¸é¡¹ç›®æ„å»ºç›¸å…³çš„ä»»åŠ¡**:

```js
module.exports = class Service {
  constructor (context, { plugins, pkg, inlineOptions, useBuiltIn } = {}) {
    process.VUE_CLI_SERVICE = this
    this.initialized = false
    this.context = context
    this.inlineOptions = inlineOptions
    this.webpackChainFns = []
    this.webpackRawConfigFns = []
    this.devServerConfigFns = []
    this.commands = {}
    // Folder containing the target package.json for plugins
    this.pkgContext = context//contextå‚æ•°ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒ…å«é¡¹ç›®è·¯å¾„å’Œå…¶ä»–é…ç½®çš„ç¯å¢ƒå¯¹è±¡
    // package.json containing the plugins
    this.pkg = this.resolvePkg(pkg)//è§£æpkgå‚æ•°ï¼Œå¦‚æœpkgæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œå®ƒä¼šç›¸å¯¹äºcontextç›®å½•æ¥è§£æã€‚
    // If there are inline plugins, they will be used instead of those
    // found in package.json.
    // When useBuiltIn === false, built-in plugins are disabled. This is mostly
    // for testing.
    //æ ¹æ®pluginså‚æ•°å’ŒuseBuiltInæ ‡å¿—æ¥åŠ è½½æ’ä»¶ã€‚å¦‚æœuseBuiltInä¸ºfalseï¼Œåˆ™ç¦ç”¨å†…ç½®æ’ä»¶ã€‚
    this.plugins = this.resolvePlugins(plugins, useBuiltIn)//
    // pluginsToSkip will be populated during run()
    this.pluginsToSkip = new Set() //ç”¨äºè®°å½•è¦è·³è¿‡çš„æ’ä»¶çš„é›†åˆ
    // resolve the default mode to use for each command
    // this is provided by plugins as module.exports.defaultModes
    // so we can get the information without actually applying the plugin.
    //é»˜è®¤æ¨¡å¼å¯¹è±¡ï¼Œç”¨äºå®šä¹‰æ¯ä¸ªå‘½ä»¤çš„é»˜è®¤æ¨¡å¼ã€‚è¿™ä¸ªå¯¹è±¡æ˜¯é€šè¿‡æ’ä»¶çš„applyå¯¹è±¡ä¸­çš„defaultModesæ¥æ„å»ºçš„ã€‚
    this.modes = this.plugins.reduce((modes, { apply: { defaultModes }}) => {
      return Object.assign(modes, defaultModes)
    }, {})
  }
  //è§£æpkgå‚æ•°ï¼Œå¦‚æœpkgæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œå®ƒä¼šç›¸å¯¹äºcontextç›®å½•æ¥è§£æ
 //å¦‚æœinlinePkgå­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚
  //å¦åˆ™ï¼Œä½¿ç”¨resolvePkgæ–¹æ³•æ¥è§£æcontextç›®å½•ä¸‹çš„åŒ…ã€‚
  //å¦‚æœè§£æåçš„åŒ…åŒ…å«vuePluginså±æ€§ï¼Œåˆ™è®¾ç½®pkgContextå±æ€§ä¸ºcontextä¸vuePlugins.resolveFromçš„è·¯å¾„åˆ†è¾¨ç‡ã€‚
  //é€’å½’è°ƒç”¨resolvePkgæ–¹æ³•ï¼Œç›´åˆ°pkgContextè¢«è®¾ç½®ä¸ºæ­¢ã€‚
  resolvePkg (inlinePkg, context = this.context) {
    // ...
    return pkg
  }
  //åˆå§‹åŒ–
  init (mode = process.env.VUE_CLI_MODE) {
  // ...
  }
  //æ ¹æ®ç¯å¢ƒå˜é‡VUE_CLI_MODEæ¥åŠ è½½ç›¸åº”çš„é…ç½®æ–‡ä»¶
  loadEnv (mode) {
   // ...
  }
  //ç”¨äºè®°å½•è¦è·³è¿‡çš„æ’ä»¶çš„é›†åˆ
  setPluginsToSkip (args) {
  // ...
  }
  //æ ¹æ®pluginså‚æ•°å’ŒuseBuiltInæ ‡å¿—æ¥åŠ è½½æ’ä»¶ã€‚å¦‚æœuseBuiltInä¸ºfalseï¼Œåˆ™ç¦ç”¨å†…ç½®æ’ä»¶ã€‚
  resolvePlugins (inlinePlugins, useBuiltIn) {
    // ...
    return plugins
  }

// asyncå‡½æ•°ï¼Œç”¨äºè¿è¡Œnameï¼Œargsï¼ŒrawArgv
 async run (name, args = {}, rawArgv = []) {
    // ...
    return fn(args, rawArgv)
  }
 //åŠ è½½ç”¨æˆ·æä¾›çš„chainableé…ç½®æ–‡ä»¶ã€‚é“¾å…¥Webpacké…ç½®å¤„ç†å‡½æ•°ï¼Œä»¥ä¾¿åœ¨æ„å»ºè¿‡ç¨‹ä¸­ä½¿ç”¨ã€‚
 resolveChainableWebpackConfig () {
   	// ...
    return chainableConfig
  }

  	//é“¾å…¥Webpacké…ç½®å¤„ç†å‡½æ•°ï¼Œä»¥ä¾¿åœ¨æ„å»ºè¿‡ç¨‹ä¸­ä½¿ç”¨ã€‚
  	//è§£æç”¨æˆ·æä¾›çš„chainableé…ç½®æ–‡ä»¶ã€‚
    //æ‰§è¡Œé…ç½®æ–‡ä»¶å¤„ç†å‡½æ•°ï¼Œä»¥ä¾¿åœ¨æ„å»ºè¿‡ç¨‹ä¸­ä½¿ç”¨ã€‚
    //æ£€æŸ¥é…ç½®é¡¹entryçš„ç±»å‹ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºæ•°ç»„ã€‚
    //å°†entryæ–‡ä»¶è§£æä¸ºå…·ä½“çš„è·¯å¾„ï¼Œå¹¶è®¾ç½®ç¯å¢ƒå˜é‡VUE_CLI_ENTRY_FILESã€‚
  resolveWebpackConfig (chainableConfig = this.resolveChainableWebpackConfig()) {
    // ...
    return config
  }
  //åŠ è½½ç”¨æˆ·æä¾›çš„é€‰é¡¹ï¼Œå¹¶ä½¿ç”¨é»˜è®¤å€¼æ¥å¡«å……ç¼ºå¤±çš„é€‰é¡¹ã€‚
  loadUserOptions () {
    // ...
    return resolved
  }
}
```

> ä»¥ä¸Šä»£ç ä¸º `Service` ç±»çš„å®šä¹‰ï¼Œåœ¨è¯¥ç±»ä¸­å®šä¹‰äº†`Service` ç±»çš„å±æ€§å’Œæ–¹æ³•ï¼š
>
> 1. åˆå§‹åŒ–`Service`ç±»æ—¶ï¼š
>    * ä¼šè®¾ç½®ä¸€äº›åŸºæœ¬çš„çŠ¶æ€ï¼šå¦‚`initialized`ã€`context`ã€`inlineOptions`ã€`webpackChainFns`ã€`webpackRawConfigFns`ã€`devServerConfigFns`ã€`commands`å’Œ`pkgContext`ã€‚
> 2. æ„é€ å‡½æ•°ï¼š ä¼šæ¥æ”¶ä¸€ä¸ª`context`å‚æ•°ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒ…å«é¡¹ç›®è·¯å¾„å’Œå…¶ä»–é…ç½®çš„ç¯å¢ƒå¯¹è±¡ã€‚
> 3. `resolvePkg`æ–¹æ³•ï¼šç”¨äºè§£æ`pkg`å‚æ•°ï¼Œå¦‚æœ`pkg`æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œå®ƒä¼šç›¸å¯¹äº`context`ç›®å½•æ¥è§£æã€‚
> 4. `resolvePlugins`æ–¹æ³•ï¼šä¼šæ ¹æ®`plugins`å‚æ•°å’Œ`useBuiltIn`æ ‡å¿—æ¥åŠ è½½æ’ä»¶ã€‚å¦‚æœ`useBuiltIn`ä¸º`false`ï¼Œåˆ™ç¦ç”¨å†…ç½®æ’ä»¶ã€‚
> 5. `pluginsToSkip`ï¼šæ˜¯ä¸€ä¸ªç”¨äºè®°å½•è¦è·³è¿‡çš„æ’ä»¶çš„é›†åˆã€‚
> 6. `modes`ï¼šæ˜¯ä¸€ä¸ªé»˜è®¤æ¨¡å¼å¯¹è±¡ï¼Œç”¨äºå®šä¹‰æ¯ä¸ªå‘½ä»¤çš„é»˜è®¤æ¨¡å¼ã€‚è¿™ä¸ªå¯¹è±¡æ˜¯é€šè¿‡æ’ä»¶çš„`apply`å¯¹è±¡ä¸­çš„`defaultModes`æ¥æ„å»ºçš„ã€‚
> 7. `init` æ–¹æ³•ï¼š
>    * åˆå§‹åŒ–`Service`ç±»ï¼Œè®¾ç½®ä¸€äº›åŸºæœ¬çš„çŠ¶æ€ã€‚
>    * æ ¹æ®ç¯å¢ƒå˜é‡`VUE_CLI_MODE`æ¥åŠ è½½ç›¸åº”çš„é…ç½®æ–‡ä»¶ï¼ˆ`vue-cli-service serve [options] [entry]` å‘½ä»¤é€šè¿‡ `--mode` å‚æ•°æŒ‡å®šç¯å¢ƒæ¨¡å¼ ï¼Œé»˜è®¤å€¼ä¸º developmentï¼Œè¯¥å‚æ•°ä¼šåŠ è½½å½“å‰ç›®å½•ä¸‹æŒ‡å®šç¯å¢ƒçš„ä¸‹é…ç½®æ–‡ä»¶ï¼‰ã€‚
>    * åŠ è½½ç”¨æˆ·æä¾›çš„é€‰é¡¹ï¼Œå¹¶ä½¿ç”¨é»˜è®¤å€¼æ¥å¡«å……ç¼ºå¤±çš„é€‰é¡¹ã€‚
>    * éå†æ’ä»¶åˆ—è¡¨ï¼Œå¹¶æ‰§è¡Œå®ƒä»¬çš„æ–¹æ³•ã€‚
>    * é“¾å…¥Webpacké…ç½®å¤„ç†å‡½æ•°ï¼Œä»¥ä¾¿åœ¨æ„å»ºè¿‡ç¨‹ä¸­ä½¿ç”¨ã€‚
>    * åˆ›å»ºä¸€ä¸ªæ–°çš„Webpacké…ç½®å¤„ç†å‡½æ•°ï¼Œä»¥ä¾¿åœ¨æ„å»ºè¿‡ç¨‹ä¸­ä½¿ç”¨ã€‚
> 8. `run`æ–¹æ³•ï¼šç”¨äºå¯åŠ¨é¡¹ç›®æ„å»ºè¿‡ç¨‹ï¼Œå®ƒä¼šéå†æ’ä»¶åˆ—è¡¨ï¼Œå¹¶æ‰§è¡Œå®ƒä»¬çš„æ–¹æ³•ã€‚
>
> è¿™äº›æ–¹æ³•ã€å±æ€§å’ŒçŠ¶æ€çš„å®šä¹‰å…è®¸æœåŠ¡å¯¹è±¡åœ¨é¡¹ç›®æ„å»ºè¿‡ç¨‹ä¸­æ‰§è¡Œå„ç§ä»»åŠ¡ï¼Œå¦‚åŠ è½½æ’ä»¶ã€é…ç½®Webpackå’Œå¤„ç†å¼€å‘æœåŠ¡å™¨é…ç½®ç­‰ã€‚

é€šè¿‡ä»¥ä¸Š Service å¯¹è±¡å®šä¹‰å¯çŸ¥ï¼š

1. åœ¨ shell æ‰§è¡Œå‘½ä»¤æ—¶å€™ï¼Œé¦–å…ˆè§£æå‚æ•°ï¼Œå¹¶å°†å‚æ•°ä¼ é€’ç»™ Service ç±»: `new Service(process.env.VUE_CLI_CONTEXT || process.cwd())  `;
2.  Service ç±»åˆå§‹åŒ–æ—¶ï¼Œè°ƒç”¨ `resolvePkg(pkg)` è§£æè§£æå‚æ•°æŒ‡å®šç›®å½•ä¸‹çš„åŒ…ï¼›
3. åˆå§‹åŒ–å®Œæˆåè°ƒç”¨ `run`æ–¹æ³•ï¼Œç”¨äºå¯åŠ¨é¡¹ç›®æ„å»ºè¿‡ç¨‹ï¼Œå®ƒä¼šéå†æ’ä»¶åˆ—è¡¨ï¼Œå¹¶æ‰§è¡Œå®ƒä»¬çš„æ–¹æ³•ã€‚

### **`Service.run ` å¯åŠ¨æ„å»º**

`Service.run ` æ–¹æ³•è¯¦ç»†ä»£ç ï¼š

```js
// asyncå‡½æ•°ï¼Œç”¨äºè¿è¡Œnameï¼Œargsï¼ŒrawArgv
 async run (name, args = {}, rawArgv = []) {
    // resolve mode
    // prioritize inline --mode
    // fallback to resolved default modes from plugins or development if --watch is defined
    //è§£æ`args.mode`å’Œ`args.watch`å‚æ•°ï¼Œç¡®å®šå½“å‰æ¨¡å¼
    const mode = args.mode || (name === 'build' && args.watch ? 'development' : this.modes[name])

    // --skip-plugins arg may have plugins that should be skipped during init()
    // set plugins to skip
    //è®¾ç½®è¦è·³è¿‡çš„æ’ä»¶
    this.setPluginsToSkip(args)

    // load env variables, load user config, apply plugins
    // åŠ è½½ç¯å¢ƒå˜é‡ï¼ŒåŠ è½½ç”¨æˆ·é…ç½®ï¼Œåº”ç”¨æ’ä»¶
    this.init(mode)

    // resolve args
    // è§£æå‚æ•°
    args._ = args._ || []
    let command = this.commands[name]
    if (!command && name) {
      error(`command "${name}" does not exist.`)
      process.exit(1)
    }
    if (!command || args.help || args.h) {
      command = this.commands.help
    } else {
      args._.shift() // remove command itself
      rawArgv.shift()
    }
    const { fn } = command
    return fn(args, rawArgv)
  }

```

> è¯¥æ–¹æ³•æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
>
> * è§£æ`args.mode`å’Œ`args.watch`å‚æ•°ï¼Œç¡®å®šå½“å‰æ¨¡å¼ã€‚
> * è®¾ç½®è¦è·³è¿‡çš„æ’ä»¶ã€‚
> * åŠ è½½ç¯å¢ƒå˜é‡å’Œç”¨æˆ·é…ç½®ã€‚
> * åº”ç”¨æ’ä»¶ã€‚
> * è§£æå‚æ•°ã€‚
> * è°ƒç”¨`command`æ–¹æ³•ï¼Œå¹¶è¿”å›ç»“æœã€‚

æ ¹æ®ä»¥ä¸Š "Shell å‘½ä»¤è§£æ" éƒ¨åˆ†ä»£ç ä¸­ï¼Œ`vue-cli-service.js` æ–‡ä»¶ä¸­è°ƒç”¨äº† `service.run`ï¼š

```js
service.run(command, args, rawArgv).catch(err => {  
  error(err)  
  process.exit(1)  
})
```

è€Œ`vue-cli-service` å‘½ä»¤ç”¨æ³•ä¸ºï¼šï¼ˆä»¥ serveå‚æ•°ä¸ºä¾‹ï¼‰ `vue-cli-service serve [options] [entry]`ï¼Œåˆ™ `service.run` æ–¹æ³•çš„ command å‚æ•°ä¸ºè¯¥å‘½ä»¤çš„ `serve` æ–¹æ³•ï¼›

åœ¨  `service.run` æ–¹æ³•ä¸­æœ€åæ‰§è¡Œ :

```js
const { fn } = command
return fn(args, rawArgv)
```

è¯´æ˜åœ¨ `vue-cli-service serve [options] [entry]` å‘½ä»¤ä¸­æœ€åæ‰§è¡Œ `serve` æ–¹æ³•å¹¶ä¼ å…¥ `[options] [entry]` å‚æ•°ã€‚



### **è§£ææ’ä»¶**

ä»¥ `serve` æ–¹æ³•ä¸ºä¾‹ï¼Œ`vue-cli-service` æ„å»ºå‘½ä»¤ä¸ºï¼š `vue-cli-service serve[options] [entry|pattern]`

é€šè¿‡ä»¥ä¸Šä»£ç åˆ†æå¯çŸ¥ï¼Œå‘½ä»¤è¡Œå‚æ•°æ–¹æ³• serve é€šè¿‡ `command` å‚æ•°æ‰§è¡Œï¼Œ `command` å‚æ•°åœ¨ Service æ„é€ å‡½æ•°ä¸­å®šä¹‰ï¼Œå¹¶é€šè¿‡ `Service.resolvePlugins` æ–¹æ³•åˆå§‹åŒ–ï¼Œè¯¥æ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š

```js
 // è§£ææ’ä»¶
  resolvePlugins (inlinePlugins, useBuiltIn) {
    // æ ¹æ®idè·å–æ’ä»¶
    const idToPlugin = id => ({
      id: id.replace(/^.\//, 'built-in:'),
      apply: require(id)
    })

    let plugins

    // å†…ç½®æ’ä»¶
    const builtInPlugins = [
      './commands/serve',
      './commands/build',
      './commands/inspect',
      './commands/help',
      // config plugins are order sensitive
      './config/base',
      './config/css',
      './config/prod',
      './config/app'
    ].map(idToPlugin)

    // åˆ¤æ–­æ˜¯å¦ä½¿ç”¨å†…ç½®æ’ä»¶
    if (inlinePlugins) {
      // åˆ¤æ–­æ˜¯å¦ä½¿ç”¨å†…ç½®æ’ä»¶
      plugins = useBuiltIn !== false
        ? builtInPlugins.concat(inlinePlugins)
        : inlinePlugins
    } else {
      // è·å–é¡¹ç›®æ’ä»¶
      const projectPlugins = Object.keys(this.pkg.devDependencies || {})
        .concat(Object.keys(this.pkg.dependencies || {}))
        .filter(isPlugin)
        .map(id => {
          // åˆ¤æ–­æ˜¯å¦å¯é€‰ä¾èµ–
          if (
            this.pkg.optionalDependencies &&
            id in this.pkg.optionalDependencies
          ) {
            let apply = () => {}
            try {
              // å°è¯•åŠ è½½æ’ä»¶
              apply = require(id)
            } catch (e) {
              // åŠ è½½å¤±è´¥ï¼Œè¾“å‡ºè­¦å‘Š
              warn(`Optional dependency ${id} is not installed.`)
            }

            return { id, apply }
          } else {
            // æ ¹æ®idè·å–æ’ä»¶
            return idToPlugin(id)
          }
        })
      // åˆå¹¶å†…ç½®æ’ä»¶å’Œé¡¹ç›®æ’ä»¶
      plugins = builtInPlugins.concat(projectPlugins)
    }

    // Local plugins
    // åˆ¤æ–­æ˜¯å¦æœ‰æœ¬åœ°æ’ä»¶
    if (this.pkg.vuePlugins && this.pkg.vuePlugins.service) {
      // è·å–æ–‡ä»¶
      const files = this.pkg.vuePlugins.service
      // åˆ¤æ–­æ–‡ä»¶ç±»å‹æ˜¯å¦ä¸ºæ•°ç»„
      if (!Array.isArray(files)) {
        // ä¸æ˜¯æ•°ç»„ï¼ŒæŠ›å‡ºé”™è¯¯
        throw new Error(`Invalid type for option 'vuePlugins.service', expected 'array' but got ${typeof files}.`)
      }
      // åˆå¹¶æ’ä»¶
      plugins = plugins.concat(files.map(file => ({
        id: `local:${file}`,
        apply: loadModule(`./${file}`, this.pkgContext)
      })))
    }

    return plugins
  }
```

> è¯¥æ–¹æ³•ä¸»è¦è§£ææ’ä»¶ï¼š
>
> 1.  æ ¹æ®idè·å–æ’ä»¶;
> 2. åˆ¤æ–­æ˜¯å¦ä½¿ç”¨å†…ç½®æ’ä»¶ï¼Œè·å–é¡¹ç›®æ’ä»¶
> 3.  åˆå¹¶å†…ç½®æ’ä»¶å’Œé¡¹ç›®æ’ä»¶ï¼›
> 4. åˆ¤æ–­æ˜¯å¦æœ‰æœ¬åœ°æ’ä»¶ï¼Œåˆå¹¶æ’ä»¶
> 5. è¿”å›åˆå¹¶åçš„æ’ä»¶ã€‚

æ ¹æ®ä»¥ä¸Š`resolvePlugins` æ–¹æ³•å¯çŸ¥ï¼Œ  `serve` æ–¹æ³• æ’ä»¶å®šä¹‰åœ¨`./commands/serve`ï¼Œæ‰€æœ‰å†…ç½®æ’ä»¶å®šä¹‰å¦‚ä¸‹ï¼š

![image-20240129200352382](../images/vue-cli-serviceå†…ç½®æ’ä»¶.png)

> è‡ªå®šä¹‰å¼€å‘æ’ä»¶å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š [æ’ä»¶å¼€å‘æŒ‡å— | Vue CLI (vuejs.org)](https://cli.vuejs.org/zh/dev-guide/plugin-dev.html#service-æ’ä»¶)

### **serve å‘½ä»¤è§£æ**  

`vue-cli-service serve` å‘½ä»¤ç”¨äºå¼€å‘ç¯å¢ƒï¼Œåœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ª HTTP æœåŠ¡ï¼š

#### **ä½¿ç”¨**

```shell
ç”¨æ³•ï¼švue-cli-service serve [options] [entry]

é€‰é¡¹ï¼š

  --open    åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶æ‰“å¼€æµè§ˆå™¨
  --copy    åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶å°† URL å¤åˆ¶åˆ°å‰ªåˆ‡ç‰ˆ
  --mode    æŒ‡å®šç¯å¢ƒæ¨¡å¼ (é»˜è®¤å€¼ï¼šdevelopment)
  --host    æŒ‡å®š host (é»˜è®¤å€¼ï¼š0.0.0.0)
  --port    æŒ‡å®š port (é»˜è®¤å€¼ï¼š8080)
  --https   ä½¿ç”¨ https (é»˜è®¤å€¼ï¼šfalse)
```

é€šè¿‡ npm script æ‰§è¡Œè¯¥å‘½ä»¤ï¼š

```js
  "scripts": {
    "dev": "vue-cli-service serve",
    "prod": "cross-env NODE_ENV=production && vue-cli-service serve",
  },
```

#### **åŸç†**

`vue-cli-service serve` å‘½ä»¤ä¼šå¯åŠ¨ä¸€ä¸ªå¼€å‘æœåŠ¡å™¨ (åŸºäº [webpack-dev-server](https://github.com/webpack/webpack-dev-server)) å¹¶é™„å¸¦å¼€ç®±å³ç”¨çš„æ¨¡å—çƒ­é‡è½½ (Hot-Module-Replacement)ã€‚

#### **æºç åˆ†æ**

åœ¨é€šè¿‡ä»¥ä¸Šâ€œè§£ææ’ä»¶â€ æ­¥éª¤æ—¶ï¼Œæ‰§è¡Œ`vue-cli-service serve`å‘½ä»¤æ—¶ï¼Œæœ€ç»ˆæ˜¯é€šè¿‡è°ƒç”¨ `serve` æ’ä»¶æ–¹æ³•ï¼Œserve å‘½ä»¤è„šæœ¬åœ¨ `cli-service/lib/commands/serve.js` ä¸­ï¼š

```js
module.exports = (api, options) => {
  //è°ƒç”¨ registerCommand æ³¨å†Œä¸€ä¸ª serve å‘½ä»¤
  api.registerCommand('serve', {
    description: 'start development server',
    usage: 'vue-cli-service serve [options] [entry]',
    options: {
      '--open': `open browser on server start`,
      '--copy': `copy url to clipboard on server start`,
      '--stdin': `close when stdin ends`,
      '--mode': `specify env mode (default: development)`,
      '--host': `specify host (default: ${defaults.host})`,
      '--port': `specify port (default: ${defaults.port})`,
      '--https': `use https (default: ${defaults.https})`,
      '--public': `specify the public network URL for the HMR client`,
      '--skip-plugins': `comma-separated list of plugin names to skip for this run`
    }
  }, async function serve (args) {
    info('Starting development server...')
 	// å¯åŠ¨ä¸€ä¸ªå¼€å‘æœåŠ¡å™¨ï¼Œä»¥ä¸‹ä»£ç çœç•¥...
    })
  })
}
```

>  åœ¨ `serve.js` ä¸­ä¸»è¦è°ƒç”¨äº† ` api.registerCommand` è¿›è¡Œæ³¨å†Œå‘½ä»¤ï¼Œå¹¶ä¼ å…¥ä¸‰ä¸ªå‚æ•°:
>
> * ç¬¬ä¸€ä¸ªå‚æ•°ï¼šserve å‘½ä»¤åç§°ï¼›
> * ç¬¬äºŒä¸ªå‚æ•°ï¼šå‘½ä»¤é€‰é¡¹ï¼›
> * ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šå‘½ä»¤å›è°ƒå‡½æ•°ï¼Œåœ¨è¯¥å›è°ƒå‡½æ•°ä¸­ä½¿ç”¨ webpack å¯åŠ¨ä¸€ä¸ªæœ¬åœ°å¼€å‘æœåŠ¡;
>
> ` api.registerCommand`  æ–¹å¼å®é™…ä¸Šåœ¨ `cli-service/lib/PluginAPI.js` ä¸­å®šä¹‰ï¼šä¸»è¦ä½œç”¨æ˜¯åœ¨ Service ç±»ä¸­æ³¨å†Œä¸€ä¸ªå‘½ä»¤
>
> ```js
>   registerCommand (name, opts, fn) {
>     if (typeof opts === 'function') {
>       fn = opts
>       opts = null
>     }
>     this.service.commands[name] = { fn, opts: opts || {}}
>   }
> ```

è¯¥å‘½ä»¤çš„ä¸»è¦æ‰§è¡Œé€»è¾‘ä¸º` api.registerCommand` çš„ç¬¬ä¸‰ä¸ªå‚æ•°å›è°ƒæ–¹æ³•ï¼Œä¸‹é¢åˆ†æè¯¥å›è°ƒ `serve` æ–¹æ³• :

#### **`serve` å›è°ƒ**

serve å›è°ƒä¸­ä¸»è¦**ä½¿ç”¨ webpack å¯åŠ¨ä¸€ä¸ªå¯åŠ¨ä¸€ä¸ªæœ¬åœ°å¼€å‘æœåŠ¡**,å†…éƒ¨ä¸»è¦é€»è¾‘ï¼š

1. **é…ç½®åˆå§‹åŒ–**ï¼š webpack å’Œ webpack å¼€å‘æœåŠ¡é…ç½®é¡¹åˆå§‹åŒ–ï¼›
2. åˆ›å»º webpack å®ä¾‹ å’Œ å¼€å‘æœåŠ¡å®ä¾‹ï¼›
3. è¿”å› HTTP æœåŠ¡å®ä¾‹ï¼Œå¹¶å¯åŠ¨æœ¬åœ° HTTP æœåŠ¡;

ä»£ç ç®€åŒ–é€»è¾‘ä¸ºï¼š

```js
async function serve (args) {
    info('Starting development server...')
  
    // although this is primarily a dev server, it is possible that we
    // are running it in a mode with a production env, e.g. in E2E tests.
    const isInContainer = checkInContainer()
    const isProduction = process.env.NODE_ENV === 'production'

    const url = require('url')
    const { chalk } = require('@vue/cli-shared-utils')
    const webpack = require('webpack')
    const WebpackDevServer = require('webpack-dev-server')
    const portfinder = require('portfinder')
    const prepareURLs = require('../util/prepareURLs')
    const prepareProxy = require('../util/prepareProxy')
    const launchEditorMiddleware = require('launch-editor-middleware')
    const validateWebpackConfig = require('../util/validateWebpackConfig')
    const isAbsoluteUrl = require('../util/isAbsoluteUrl')
   // ==================webpack å’Œ webpack å¼€å‘æœåŠ¡é…ç½®é¡¹ åˆå§‹åŒ–====================
    // å¾€ service.webpackChainFns é˜Ÿåˆ—ä¸­æ·»åŠ å›è°ƒ...
    // 1.è®¾ç½®å¼€å‘ç¯å¢ƒä¸‹ webpack å¼€å‘å·¥å…·...
    // 2.è§£æ webpack é…ç½®
    // 3.æ£€æŸ¥å¸¸è§çš„ webpack é…ç½®é”™è¯¯
    // 4.æš´éœ²é«˜çº§ç»Ÿè®¡ä¿¡æ¯...
    //5.è§£æ webpack å…¥å£å‚æ•°...
    // 6.è§£ææœåŠ¡å™¨é€‰é¡¹...
    // 7.éç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œæ³¨å…¥å¼€å‘å’Œçƒ­é‡è½½ä¸­é—´ä»¶...
  
    //========== webpack é…ç½®é¡¹åˆå§‹åŒ–å®Œæˆ ====================
    //========== åˆ›å»º webpack å®ä¾‹ å’Œ å¼€å‘æœåŠ¡å®ä¾‹============
    // create compiler
    // æ ¸å¿ƒï¼šåˆ›å»º webpack å®ä¾‹ï¼Œè¿”å›ä¸€ä¸ªç¼–è¯‘å™¨å¯¹è±¡
    const compiler = webpack(webpackConfig)

    // create server
    // æ ¸å¿ƒï¼šåˆ›å»ºä¸€ä¸ª webpack å¼€å‘æœåŠ¡, ä¼ å…¥ä¸€ä¸ªç¼–è¯‘å™¨å®ä¾‹ å’Œ å‚æ•°é€‰é¡¹
    const server = new WebpackDevServer(compiler, {
     //é…ç½®é¡¹çœç•¥...
    })
	// è¿”å›ä¸€ä¸ª HTTP æœåŠ¡å®ä¾‹
    return new Promise((resolve, reject) => {
      // log instructions & open browser on first compilation complete
      let isFirstCompile = true
      // ç›‘å¬ webpack æ’ä»¶ done äº‹ä»¶
      compiler.hooks.done.tap('vue-cli-service serve', stats => {
  	  // é…ç½®æ“ä½œ....
      // å¯åŠ¨æœåŠ¡ï¼Œå¹¶ç›‘å¬
      server.listen(port, host, err => {
        if (err) {
          reject(err)
        }
      })
    })
  }
```



å®Œæ•´ä»£ç å’Œæ³¨é‡Šä¸ºï¼š

```js
async function serve (args) {
    info('Starting development server...')
    // ==================webpack å’Œ webpack å¼€å‘æœåŠ¡é…ç½®é¡¹ åˆå§‹åŒ–====================
    // although this is primarily a dev server, it is possible that we
    // are running it in a mode with a production env, e.g. in E2E tests.
    const isInContainer = checkInContainer()
    const isProduction = process.env.NODE_ENV === 'production'

    const url = require('url')
    const { chalk } = require('@vue/cli-shared-utils')
    const webpack = require('webpack')
    const WebpackDevServer = require('webpack-dev-server')
    const portfinder = require('portfinder')
    const prepareURLs = require('../util/prepareURLs')
    const prepareProxy = require('../util/prepareProxy')
    const launchEditorMiddleware = require('launch-editor-middleware')
    const validateWebpackConfig = require('../util/validateWebpackConfig')
    const isAbsoluteUrl = require('../util/isAbsoluteUrl')

    // configs that only matters for dev server
    // å¾€ service.webpackChainFns é˜Ÿåˆ—ä¸­æ·»åŠ å›è°ƒ
    api.chainWebpack(webpackConfig => {
      // è®¾ç½®å¼€å‘ç¯å¢ƒä¸‹ webpack å¼€å‘å·¥å…·
      if (process.env.NODE_ENV !== 'production' && process.env.NODE_ENV !== 'test') {
        webpackConfig
          .devtool('cheap-module-eval-source-map')

        // æ·»åŠ  webpack çƒ­æ›´æ–°æ’ä»¶
        webpackConfig
          .plugin('hmr')
            .use(require('webpack/lib/HotModuleReplacementPlugin'))

        // https://github.com/webpack/webpack/issues/6642
        // https://github.com/vuejs/vue-cli/issues/3539
        // https://v3.vuejs.org/api/global-api.html#definecomponnet
        // è®¾ç½® webpack å…¨å±€å¯¹è±¡ ä¸€äº›æ’ä»¶éœ€è¦å®ƒæ¥æ­£ç¡®å·¥ä½œ
        webpackConfig
          .output
            .globalObject(`(typeof self !== 'undefined' ? self : this)`)

        // æ·»åŠ  webpack è¿›åº¦æ¡
        if (!process.env.VUE_CLI_TEST && options.devServer.progress !== false) {
          webpackConfig
            .plugin('progress')
            .use(require('webpack/lib/ProgressPlugin'))
        }
      }
    })

    // resolve webpack config è§£æ webpack é…ç½®
    const webpackConfig = api.resolveWebpackConfig()

    // check for common config errors
    // æ£€æŸ¥å¸¸è§çš„ webpack é…ç½®é”™è¯¯
    validateWebpackConfig(webpackConfig, api, options)

    // load user devServer options with higher priority than devServer
    // in webpack config
    // åŠ è½½ç”¨æˆ· devServer é€‰é¡¹ï¼Œå…·æœ‰æ¯” webpack é…ç½®ä¸­çš„ devServer æ›´é«˜çš„ä¼˜å…ˆçº§
    const projectDevServerOptions = Object.assign(
      webpackConfig.devServer || {},
      options.devServer
    )

    // expose advanced stats
    // æš´éœ²é«˜çº§ç»Ÿè®¡ä¿¡æ¯
    if (args.dashboard) {
      // https://github.com/FormidableLabs/webpack-dashboard
      const DashboardPlugin = require('../webpack/DashboardPlugin')
      ;(webpackConfig.plugins = webpackConfig.plugins || []).push(new DashboardPlugin({
        type: 'serve'
      }))
    }

    // entry arg
    //è§£æ webpack å…¥å£å‚æ•°
    const entry = args._[0]
    if (entry) {
      webpackConfig.entry = {
        app: api.resolve(entry)
      }
    }

    // resolve server options
    // è§£ææœåŠ¡å™¨é€‰é¡¹
    const useHttps = args.https || projectDevServerOptions.https || defaults.https   
    const protocol = useHttps ? 'https' : 'http'
    const host = args.host || process.env.HOST || projectDevServerOptions.host || defaults.host
    portfinder.basePort = args.port || process.env.PORT || projectDevServerOptions.port || defaults.port
    const port = await portfinder.getPortPromise()
    const rawPublicUrl = args.public || projectDevServerOptions.public
    const publicUrl = rawPublicUrl
      ? /^[a-zA-Z]+:\/\//.test(rawPublicUrl)
        ? rawPublicUrl
        : `${protocol}://${rawPublicUrl}`
      : null

    const urls = prepareURLs(
      protocol,
      host,
      port,
      isAbsoluteUrl(options.publicPath) ? '/' : options.publicPath
    )
    const localUrlForBrowser = publicUrl || urls.localUrlForBrowser
    // proxy config
    const proxySettings = prepareProxy(
      projectDevServerOptions.proxy,
      api.resolve('public')
    )

    // inject dev & hot-reload middleware entries
    // éç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œæ³¨å…¥å¼€å‘å’Œçƒ­é‡è½½ä¸­é—´ä»¶
    if (!isProduction) {
      // socket è¿æ¥è·¯å¾„
      const sockPath = projectDevServerOptions.sockPath || '/sockjs-node'
      const sockjsUrl = publicUrl
        // explicitly configured via devServer.public
        ? `?${publicUrl}&sockPath=${sockPath}`
        : isInContainer
          // can't infer public network url if inside a container...
          // use client-side inference (note this would break with non-root publicPath)
          ? ``
          // otherwise infer the url
          : `?` + url.format({
            protocol,
            port,
            hostname: urls.lanUrlForConfig || 'localhost'
          }) + `&sockPath=${sockPath}`
      const devClients = [
        // dev server client
        require.resolve(`webpack-dev-server/client`) + sockjsUrl,
        // hmr client
        require.resolve(projectDevServerOptions.hotOnly
          ? 'webpack/hot/only-dev-server'
          : 'webpack/hot/dev-server')
        // TODO custom overlay client
        // `@vue/cli-overlay/dist/client`
      ]
      if (process.env.APPVEYOR) {
        devClients.push(`webpack/hot/poll?500`)
      }
      // inject dev/hot client
      // æ·»åŠ å¼€å‘å’Œçƒ­é‡è½½å®¢æˆ·ç«¯åˆ° entry
      addDevClientToEntry(webpackConfig, devClients)
    }
    //========== webpack é…ç½®é¡¹åˆå§‹åŒ–å®Œæˆ ====================
    //========== åˆ›å»º webpack å®ä¾‹ å’Œ å¼€å‘æœåŠ¡å®ä¾‹============
    // create compiler
    // æ ¸å¿ƒï¼šåˆ›å»º webpack å®ä¾‹ï¼Œè¿”å›ä¸€ä¸ªç¼–è¯‘å™¨å¯¹è±¡
    const compiler = webpack(webpackConfig)

    // handle compiler error
    // webpack å¤„ç†ç¼–è¯‘é”™è¯¯ï¼Œç›‘å¬é”™è¯¯ï¼Œå‘ç”Ÿé”™è¯¯æ—¶é€€å‡ºç¨‹åº
    compiler.hooks.failed.tap('vue-cli-service serve', msg => {
      error(msg)
      process.exit(1)
    })

    // create server
    // æ ¸å¿ƒï¼šåˆ›å»ºä¸€ä¸ª webpack å¼€å‘æœåŠ¡, ä¼ å…¥ä¸€ä¸ªç¼–è¯‘å™¨å®ä¾‹ å’Œ å‚æ•°é€‰é¡¹
   const server = new WebpackDevServer(compiler, Object.assign({
      // å…³é—­ webpack çš„æ—¥å¿—
      logLevel: 'silent',
      // å…³é—­ webpack-dev-server çš„æ—¥å¿—
      clientLogLevel: 'silent',
      // æ”¯æŒé¡µé¢è·³è½¬
      historyApiFallback: {
        // ç¦ç”¨ç‚¹å¼è§„åˆ™
        disableDotRule: true,
        // ç”Ÿæˆå†å²apiå›é€€é‡å†™
        rewrites: genHistoryApiFallbackRewrites(options.publicPath, options.pages)
      },
      // æŒ‡å®šå†…å®¹åŸºç¡€
      contentBase: api.resolve('public'),
      // éç”Ÿäº§ç¯å¢ƒæ—¶ï¼Œç›‘å¬å†…å®¹åŸºç¡€
      watchContentBase: !isProduction,
      // éç”Ÿäº§ç¯å¢ƒæ—¶ï¼Œå¯ç”¨çƒ­æ›´æ–°
      hot: !isProduction,
      // ç¦ç”¨æ³¨å…¥å®¢æˆ·ç«¯
      injectClient: false,
      // å‹ç¼©
      compress: isProduction,
      // æŒ‡å®špublicPath
      publicPath: options.publicPath,
      // éç”Ÿäº§ç¯å¢ƒæ—¶ï¼Œå¯ç”¨è¦†ç›–
      overlay: isProduction // TODO disable this
        ? false
        : { warnings: false, errors: true }
    }, projectDevServerOptions, {
      // ä½¿ç”¨https
      https: useHttps,
      // ä»£ç†è®¾ç½®
      proxy: proxySettings,
      // æ³¨å†Œä¸­é—´ä»¶
      // eslint-disable-next-line no-shadow
      before (app, server) {
        // launch editor support.
        // this works with vue-devtools & @vue/cli-overlay
        // å¯åŠ¨ç¼–è¾‘å™¨æ”¯æŒ
        // æ­¤åŠŸèƒ½ä¸vue-devtoolså’Œ@vue/cli-overlayä¸€èµ·å·¥ä½œ
        app.use('/__open-in-editor', launchEditorMiddleware(() => console.log(
          `To specify an editor, specify the EDITOR env variable or ` +
          `add "editor" field to your Vue project config.\n`
        )))
        // allow other plugins to register middlewares, e.g. PWA
        // å…è®¸å…¶ä»–æ’ä»¶æ³¨å†Œä¸­é—´ä»¶ï¼Œä¾‹å¦‚PWA
        api.service.devServerConfigFns.forEach(fn => fn(app, server))
        // apply in project middlewares
        // åº”ç”¨é¡¹ç›®ä¸­é—´ä»¶
        projectDevServerOptions.before && projectDevServerOptions.before(app, server)
      },
      // avoid opening browser
      // é¿å…æ‰“å¼€æµè§ˆå™¨
      open: false
    }))

   // æ³¨å†Œ node ä¿¡å·
   ;['SIGINT', 'SIGTERM'].forEach(signal => {
      // å½“æ”¶åˆ°SIGINTæˆ–SIGTERMä¿¡å·æ—¶ï¼Œå…³é—­æœåŠ¡å™¨
      process.on(signal, () => {
        server.close(() => {
          // é€€å‡ºè¿›ç¨‹
          process.exit(0)
        })
      })
    })

   // åˆ¤æ–­args.stdinæ˜¯å¦å­˜åœ¨
   if (args.stdin) {
      // å½“æ ‡å‡†è¾“å…¥æµç»“æŸæ—¶
      process.stdin.on('end', () => {
        // å…³é—­æœåŠ¡å™¨
        server.close(() => {
          // é€€å‡ºè¿›ç¨‹
          process.exit(0)
        })
      })

      // æ¢å¤æ ‡å‡†è¾“å…¥æµ
      process.stdin.resume()
    }

   // on appveyor, killing the process with SIGTERM causes execa to
    // throw error
    if (process.env.VUE_CLI_TEST) {
      process.stdin.on('data', data => {
        if (data.toString() === 'close') {
          console.log('got close signal!')
          server.close(() => {
            process.exit(0)
          })
        }
      })
    }

    return new Promise((resolve, reject) => {
      // log instructions & open browser on first compilation complete
      let isFirstCompile = true
      // ç›‘å¬ webpack æ’ä»¶ done äº‹ä»¶
      compiler.hooks.done.tap('vue-cli-service serve', stats => {
        if (stats.hasErrors()) {
          return
        }

        let copied = ''
        // é¦–æ¬¡ç¼–è¯‘å°†æœåŠ¡åœ°å€æ·»åŠ åˆ°ç²˜è´´æ¿
        if (isFirstCompile && args.copy) {
          try {
            require('clipboardy').writeSync(localUrlForBrowser)
            copied = chalk.dim('(copied to clipboard)')
          } catch (_) {
            /* catch exception if copy to clipboard isn't supported (e.g. WSL), see issue #3476 */
          }
        }

        const networkUrl = publicUrl
          ? publicUrl.replace(/([^/])$/, '$1/')
          : urls.lanUrlForTerminal

        console.log()
        console.log(`  App running at:`)
        console.log(`  - Local:   ${chalk.cyan(urls.localUrlForTerminal)} ${copied}`)
        if (!isInContainer) {
          console.log(`  - Network: ${chalk.cyan(networkUrl)}`)
        } else {
          console.log()
          console.log(chalk.yellow(`  It seems you are running Vue CLI inside a container.`))
          if (!publicUrl && options.publicPath && options.publicPath !== '/') {
            console.log()
            console.log(chalk.yellow(`  Since you are using a non-root publicPath, the hot-reload socket`))
            console.log(chalk.yellow(`  will not be able to infer the correct URL to connect. You should`))
            console.log(chalk.yellow(`  explicitly specify the URL via ${chalk.blue(`devServer.public`)}.`))
            console.log()
          }
          console.log(chalk.yellow(`  Access the dev server via ${chalk.cyan(
            `${protocol}://localhost:<your container's external mapped port>${options.publicPath}`
          )}`))
        }
        console.log()

        if (isFirstCompile) {
          isFirstCompile = false

          if (!isProduction) {
            const buildCommand = hasProjectYarn(api.getCwd()) ? `yarn build` : hasProjectPnpm(api.getCwd()) ? `pnpm run build` : `npm run build`
            console.log(`  Note that the development build is not optimized.`)
            console.log(`  To create a production build, run ${chalk.cyan(buildCommand)}.`)
          } else {
            console.log(`  App is served in production mode.`)
            console.log(`  Note this is for preview or E2E testing only.`)
          }
          console.log()
          // æ‰“å¼€æµè§ˆå™¨
          if (args.open || projectDevServerOptions.open) {
            const pageUri = (projectDevServerOptions.openPage && typeof projectDevServerOptions.openPage === 'string')
              ? projectDevServerOptions.openPage
              : ''
            openBrowser(localUrlForBrowser + pageUri)
          }

          // Send final app URL
          // å‘é€ url åˆ°ç²˜è´´æ¿
          if (args.dashboard) {
            const ipc = new IpcMessenger()
            ipc.send({
              vueServe: {
                url: localUrlForBrowser
              }
            })
          }

          // resolve returned Promise
          // so other commands can do api.service.run('serve').then(...)
          resolve({
            server,
            url: localUrlForBrowser
          })
        } else if (process.env.VUE_CLI_TEST) {
          // signal for test to check HMR
          console.log('App updated')
        }
      })
      // å¯åŠ¨æœåŠ¡ï¼Œå¹¶ç›‘å¬
      server.listen(port, host, err => {
        if (err) {
          reject(err)
        }
      })
    })
  }
```



### **`build` å‘½ä»¤è§£æ**

`vue-cli-service build` å‘½ä»¤ç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œä½¿ç”¨ webpack å¯¹é¡¹ç›®è¿›è¡Œæ„å»ºï¼š

#### **ä½¿ç”¨**

```shell
ç”¨æ³•ï¼švue-cli-service build [options] [entry|pattern]

é€‰é¡¹ï¼š

  --mode        æŒ‡å®šç¯å¢ƒæ¨¡å¼ (é»˜è®¤å€¼ï¼šproduction)
  --dest        æŒ‡å®šè¾“å‡ºç›®å½• (é»˜è®¤å€¼ï¼šdist)
  --modern      é¢å‘ç°ä»£æµè§ˆå™¨å¸¦è‡ªåŠ¨å›é€€åœ°æ„å»ºåº”ç”¨
  --target      app | lib | wc | wc-async (é»˜è®¤å€¼ï¼šapp)
  --name        åº“æˆ– Web Components æ¨¡å¼ä¸‹çš„åå­— (é»˜è®¤å€¼ï¼špackage.json ä¸­çš„ "name" å­—æ®µæˆ–å…¥å£æ–‡ä»¶å)
  --no-clean    åœ¨æ„å»ºé¡¹ç›®ä¹‹å‰ä¸æ¸…é™¤ç›®æ ‡ç›®å½•çš„å†…å®¹
  --report      ç”Ÿæˆ report.html ä»¥å¸®åŠ©åˆ†æåŒ…å†…å®¹
  --report-json ç”Ÿæˆ report.json ä»¥å¸®åŠ©åˆ†æåŒ…å†…å®¹
  --watch       ç›‘å¬æ–‡ä»¶å˜åŒ–
```

`vue-cli-service build` ä¼šåœ¨ `dist/` ç›®å½•äº§ç”Ÿä¸€ä¸ªå¯ç”¨äºç”Ÿäº§ç¯å¢ƒçš„åŒ…ï¼Œå¸¦æœ‰ JS/CSS/HTML çš„å‹ç¼©ï¼Œå’Œä¸ºæ›´å¥½çš„ç¼“å­˜è€Œåšçš„è‡ªåŠ¨çš„ vendor chunk splittingã€‚å®ƒçš„ chunk manifest ä¼šå†…è”åœ¨ HTML é‡Œã€‚

è¿™é‡Œè¿˜æœ‰ä¸€äº›æœ‰ç”¨çš„å‘½ä»¤å‚æ•°ï¼š

- `--modern` ä½¿ç”¨[ç°ä»£æ¨¡å¼](https://cli.vuejs.org/zh/guide/browser-compatibility.html#ç°ä»£æ¨¡å¼)æ„å»ºåº”ç”¨ï¼Œä¸ºç°ä»£æµè§ˆå™¨äº¤ä»˜åŸç”Ÿæ”¯æŒçš„ ES2015 ä»£ç ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªå…¼å®¹è€æµè§ˆå™¨çš„åŒ…ç”¨æ¥è‡ªåŠ¨å›é€€ã€‚
- `--target` å…è®¸ä½ å°†é¡¹ç›®ä¸­çš„ä»»ä½•ç»„ä»¶ä»¥ä¸€ä¸ªåº“æˆ– Web Components ç»„ä»¶çš„æ–¹å¼è¿›è¡Œæ„å»ºã€‚æ›´å¤šç»†èŠ‚è¯·æŸ¥é˜…[æ„å»ºç›®æ ‡](https://cli.vuejs.org/zh/guide/build-targets.html)ã€‚
- `--report` å’Œ `--report-json` ä¼šæ ¹æ®æ„å»ºç»Ÿè®¡ç”ŸæˆæŠ¥å‘Šï¼Œå®ƒä¼šå¸®åŠ©ä½ åˆ†æåŒ…ä¸­åŒ…å«çš„æ¨¡å—ä»¬çš„å¤§å°ã€‚

é€šè¿‡ npm script æ‰§è¡Œè¯¥å‘½ä»¤ï¼š

```js
  "scripts": {
    "build:prod": "git pull && vue-cli-service build && npm run upload prod",
    "build:test": "git pull && vue-cli-service build --mode staging && npm run upload test",
  },
```



#### **æºç åˆ†æ**

`build` å‘½ä»¤æ’ä»¶ä½äº `cli-service/lib/commands/build/index.js`:![image-20240131201435242](../images/vue-cli-buildå‘½ä»¤æ’ä»¶.png)

> è¯¥å‘½ä»¤å…¥å£æ–‡ä»¶ä½¿ç”¨ `api.registerCommand('build',options, callback)` æ³¨å†Œä¸€ä¸ª build å‘½ä»¤ï¼š
>
> - æ³¨å†Œå¹¶å¤„ç†ä¸€ä¸ªåä¸º `build` çš„å‘½ä»¤ã€‚
> - æ ¹æ®å‘½ä»¤çš„å‚æ•°å’Œé€‰é¡¹æ¥è®¾ç½®é»˜è®¤å€¼ã€‚
> - æ ¹æ® `args.modern` çš„å€¼æ¥æ‰§è¡Œä¸åŒçš„æ„å»ºæ“ä½œã€‚
> - åœ¨ Modern æ¨¡å¼ä¸‹ï¼Œé€šè¿‡å­è¿›ç¨‹æ¥æ‰§è¡Œæ„å»ºæ“ä½œã€‚
> - åˆ é™¤æ„å»ºæ“ä½œä¸­äº§ç”Ÿçš„ä¸´æ—¶æ–‡ä»¶ã€‚



åœ¨æ³¨å†Œå®Œæˆ `build` å‘½ä»¤åï¼Œè§£æå‘½ä»¤å‚æ•°ï¼Œæœ€åä¼ å…¥ä¸€ä¸ª `build` æ–¹æ³•è§£æå‘½ä»¤è¡Œå‚æ•°ã€é…ç½® Webpack é…ç½®ã€æ‰§è¡Œ Webpack æ„å»ºæ‰§è¡Œ webpack æ„å»ºï¼š

```js
//è´Ÿè´£è§£æå‘½ä»¤è¡Œå‚æ•°ã€é…ç½® Webpack é…ç½®ã€æ‰§è¡Œ Webpack æ„å»º
async function build(args, api, options) {
  const fs = require('fs-extra')
  const path = require('path')
  const webpack = require('webpack')
  const { chalk } = require('@vue/cli-shared-utils')
  const formatStats = require('./formatStats')
  const validateWebpackConfig = require('../../util/validateWebpackConfig')
  const {
    log,
    done,
    info,
    logWithSpinner,
    stopSpinner
  } = require('@vue/cli-shared-utils')

  log()
  const mode = api.service.mode
  //æ£€æŸ¥å‘½ä»¤è¡Œå‚æ•°ï¼Œå¹¶æ ¹æ®å‚æ•°å†…å®¹ä¿®æ”¹äº†æ„å»ºæ¨¡å¼ï¼ˆå¦‚ --modern å’Œ --no-modernï¼‰
  if (args.target === 'app') {
    const bundleTag = args.modern
      ? args.modernBuild
        ? `modern bundle `
        : `legacy bundle `
      : ``
    logWithSpinner(`Building ${bundleTag}for ${mode}...`)
  } else {
    const buildMode = buildModes[args.target]
    if (buildMode) {
      const additionalParams = buildMode === 'library' ? ` (${args.formats})` : ``
      logWithSpinner(`Building for ${mode} as ${buildMode}${additionalParams}...`)
    } else {
      throw new Error(`Unknown build target: ${args.target}`)
    }
  }

  if (args.dest) {
    // Override outputDir before resolving webpack config as config relies on it (#2327)
    options.outputDir = args.dest
  }

  const targetDir = api.resolve(options.outputDir)
  const isLegacyBuild = args.target === 'app' && args.modern && !args.modernBuild

  // resolve raw webpack config
  //åŠ è½½äº†ç›¸åº”çš„webpacké…ç½®æ–‡ä»¶
  let webpackConfig
  if (args.target === 'lib') {
    webpackConfig = require('./resolveLibConfig')(api, args, options)
  } else if (
    args.target === 'wc' ||
    args.target === 'wc-async'
  ) {
    webpackConfig = require('./resolveWcConfig')(api, args, options)
  } else {
    webpackConfig = require('./resolveAppConfig')(api, args, options)
  }

  // check for common config errors
  //æ£€æŸ¥äº† Webpack é…ç½®æ˜¯å¦åŒ…å«é”™è¯¯ï¼Œå¹¶è¿›è¡Œäº†ä¿®æ­£
  validateWebpackConfig(webpackConfig, api, options, args.target)
  //å¯åŠ¨ä¸€ä¸ªç›‘å¬å™¨æ¥ç›‘å¬æ–‡ä»¶å˜åŒ–å¹¶è‡ªåŠ¨é‡æ–°æ„å»º
  if (args.watch) {
    modifyConfig(webpackConfig, config => {
      config.watch = true
    })
  }

  // åˆ¤æ–­æ˜¯å¦æœ‰æ ‡å‡†è¾“å…¥
  if (args.stdin) {
    // å½“æ ‡å‡†è¾“å…¥ç»“æŸæ—¶ï¼Œé€€å‡ºç¨‹åº
    process.stdin.on('end', () => {
      process.exit(0)
    })
    // æ¢å¤æ ‡å‡†è¾“å…¥
    process.stdin.resume()
  }

  // Expose advanced stats
  // åˆ¤æ–­å‚æ•°dashboardæ˜¯å¦å­˜åœ¨
  if (args.dashboard) {
    // å¼•å…¥DashboardPluginæ’ä»¶
    const DashboardPlugin = require('../../webpack/DashboardPlugin')
    // ä¿®æ”¹webpacké…ç½®
    modifyConfig(webpackConfig, config => {
      // å°†DashboardPluginæ’ä»¶æ·»åŠ åˆ°é…ç½®ä¸­
      config.plugins.push(new DashboardPlugin({
        type: 'build',
        modernBuild: args.modernBuild,
        keepAlive: args.keepAlive
      }))
    })
  }
  // å¦‚æœargs.reportæˆ–è€…args['report-json']å­˜åœ¨ï¼Œåˆ™å¼•å…¥webpack-bundle-analyzeræ’ä»¶
  if (args.report || args['report-json']) {
    const { BundleAnalyzerPlugin } = require('webpack-bundle-analyzer')
    // ä¿®æ”¹webpackConfigé…ç½®
    modifyConfig(webpackConfig, config => {
      // æ ¹æ®targetå‚æ•°ï¼Œè®¾ç½®bundleName
      const bundleName = args.target !== 'app'
        ? config.output.filename.replace(/\.js$/, '-')
        : isLegacyBuild ? 'legacy-' : ''
      // æ·»åŠ BundleAnalyzerPluginæ’ä»¶
      config.plugins.push(new BundleAnalyzerPlugin({
        // è®¾ç½®æ—¥å¿—ç­‰çº§
        logLevel: 'warn',
        // å…³é—­æµè§ˆå™¨
        openAnalyzer: false,
        // æ ¹æ®args.reportå‚æ•°ï¼Œè®¾ç½®analyzerMode
        analyzerMode: args.report ? 'static' : 'disabled',
        // è®¾ç½®æŠ¥å‘Šæ–‡ä»¶å
        reportFilename: `${bundleName}report.html`,
        // è®¾ç½®æŠ¥å‘Šæ–‡ä»¶å
        statsFilename: `${bundleName}report.json`,
        // æ ¹æ®args['report-json']å‚æ•°ï¼Œè®¾ç½®generateStatsFile
        generateStatsFile: !!args['report-json']
      }))
    })
  }

  if (args.clean) {
    // å¦‚æœargs.cleanä¸ºtrueï¼Œåˆ™æ‰§è¡Œfs.removeå‡½æ•°ï¼Œåˆ é™¤targetDirç›®å½•
    await fs.remove(targetDir)
  }

 return new Promise((resolve, reject) => {
    // æ‰§è¡Œwebpackæ„å»º
    webpack(webpackConfig, (err, stats) => {
      // åœæ­¢spinner
      stopSpinner(false)
      // å¦‚æœå‡ºç°é”™è¯¯ï¼Œåˆ™è¿”å›é”™è¯¯
      if (err) {
        return reject(err)
      }

      // å¦‚æœæ„å»ºæœ‰é”™è¯¯ï¼Œåˆ™è¿”å›é”™è¯¯
      if (stats.hasErrors()) {
        return reject(`Build failed with errors.`)
      }

      // å¦‚æœä¸æ˜¯é™é»˜æ¨¡å¼ï¼Œåˆ™è¾“å‡ºæ„å»ºä¿¡æ¯
      if (!args.silent) {
        const targetDirShort = path.relative(
          api.service.context,
          targetDir
        )
        log(formatStats(stats, targetDirShort, api))
        // å¦‚æœæ˜¯appç›®æ ‡ï¼Œä¸”ä¸æ˜¯legacyæ„å»ºï¼Œåˆ™è¾“å‡ºéƒ¨ç½²ä¿¡æ¯
        if (args.target === 'app' && !isLegacyBuild) {
          // å¦‚æœä¸æ˜¯watchæ¨¡å¼ï¼Œåˆ™è¾“å‡ºæ„å»ºå®Œæˆä¿¡æ¯
          if (!args.watch) {
            done(`Build complete. The ${chalk.cyan(targetDirShort)} directory is ready to be deployed.`)
            info(`Check out deployment instructions at ${chalk.cyan(`https://cli.vuejs.org/guide/deployment.html`)}\n`)
          } else {
            done(`Build complete. Watching for changes...`)
          }
        }
      }

      // test-only signal
      // æµ‹è¯•onlyä¿¡å·
      if (process.env.VUE_CLI_TEST) {
        console.log('Build complete.')
      }

      // æ„å»ºæˆåŠŸï¼Œè¿”å›æˆåŠŸ
      resolve()
    })
  })
}
```

> è¯¥æ–¹æ³•ä¸»è¦é€»è¾‘ä¸ºï¼š
>
> 1. ä»£ç æ£€æŸ¥äº†å‘½ä»¤è¡Œå‚æ•°ï¼Œå¹¶æ ¹æ®å‚æ•°å†…å®¹ä¿®æ”¹äº†æ„å»ºæ¨¡å¼ï¼ˆå¦‚ `--modern` å’Œ `--no-modern`ï¼‰ã€‚
> 2. ç„¶åï¼Œä»£ç åŠ è½½äº†ç›¸åº”çš„é…ç½®æ–‡ä»¶ï¼ˆå¦‚ `resolveAppConfig`ã€`resolveLibConfig` ç­‰ï¼‰ï¼Œå¹¶æ ¹æ®å‘½ä»¤è¡Œå‚æ•°è¿›è¡Œäº†ç›¸åº”çš„é…ç½®ä¿®æ”¹ã€‚
> 3. æ¥ç€ï¼Œä»£ç æ£€æŸ¥äº† Webpack é…ç½®æ˜¯å¦åŒ…å«é”™è¯¯ï¼Œå¹¶è¿›è¡Œäº†ä¿®æ­£ã€‚
> 4. æœ€åï¼Œä»£ç æ ¹æ®å‘½ä»¤è¡Œå‚æ•°ï¼ˆå¦‚ `--silent` å’Œ `--report`ï¼‰å†³å®šæ˜¯å¦è¾“å‡ºæ„å»ºç»“æœã€‚
> 5. å¦‚æœéœ€è¦ï¼Œä»£ç è¿˜ä¼šå¯åŠ¨ä¸€ä¸ªç›‘å¬å™¨æ¥ç›‘å¬æ–‡ä»¶å˜åŒ–å¹¶è‡ªåŠ¨é‡æ–°æ„å»ºã€‚
> 6. æ‰§è¡Œ webpack æ„å»ºï¼›
> 7. ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œä»£ç è¿˜å…è®¸åœ¨æµ‹è¯•ç¯å¢ƒä¸­è¾“å‡ºä¸€äº›ä¿¡å·ã€‚



## **WebPack é…ç½®åŸç†**

### **é…ç½®æ–¹å¼**

åœ¨ `vue.config.js` ä¸­çš„ ` ` é€‰é¡¹æä¾›ä¸€ä¸ªå¯¹è±¡ï¼š

```js
// vue.config.js
module.exports = {
  configureWebpack: {
    plugins: [
      new MyAwesomeWebpackPlugin()
    ]
  }
}
```

è¯¥å¯¹è±¡å°†ä¼šè¢« [webpack-merge](https://github.com/survivejs/webpack-merge) åˆå¹¶å…¥æœ€ç»ˆçš„ webpack é…ç½®ã€‚

ä½¿ç”¨ Vue-Cli åˆ›å»ºçš„é¡¹ç›® `vue.config.js` é…ç½®ä¸ºï¼š

```js
'use strict'
const path = require('path')
const defaultSettings = require('./src/settings/projectSettings.js')
const LodashModuleReplacementPlugin = require('lodash-webpack-plugin')
const UpdatePopup = require('@femessage/update-popup') // ç‰ˆæœ¬æ›´æ–°æé†’æ’ä»¶
function resolve(dir) {
  return path.join(__dirname, dir)
}

const name = defaultSettings.title page title

// If your port is set to 80,
// use administrator privileges to execute the command line.
// For example, Mac: sudo npm run
// You can change the port by the following methods:
// port = 8080 npm run dev OR npm run dev --port = 8080
const port = process.env.port || process.env.npm_config_port || 8080 // dev port

// All configuration item explanations can be find in https://cli.vuejs.org/config/
module.exports = {
  /**
   * You will need to set publicPath if you plan to deploy your site under a sub path,
   * for example GitHub Pages. If you plan to deploy your site to https://foo.github.io/bar/,
   * then publicPath should be set to "/bar/".
   * In most cases please use '/' !!!
   * Detail: https://cli.vuejs.org/config/#publicpath
   */
  publicPath: './',
  outputDir: 'dist',
  assetsDir: 'static',
  lintOnSave: process.env.NODE_ENV === 'development',
  productionSourceMap: false,
  devServer: {
    port: port,
    open: true,
    overlay: {
      warnings: false,
      errors: true
    },
    hot: true,
    // websocket é…ç½®ä»£ç†
    proxy: {
      '/socket.io': {
        target: 'http://localhost:3000', // target host
        changeOrigin: true, // needed for virtual hosted sites
        logLevel: 'debug'
      }
    }
  },
  configureWebpack: {
    // provide the app's title in webpack's name field, so that
    // it can be accessed in index.html to inject the correct title.
    name: name,
    resolve: {
      alias: {
        '@': resolve('src')
      }
    }
  },
  chainWebpack(config) {
    // it can improve the speed of the first screen, it is recommended to turn on preload
    config.plugin('preload').tap(() => [
      {
        rel: 'preload',
        // to ignore runtime.js
        // https://github.com/vuejs/vue-cli/blob/dev/packages/@vue/cli-service/lib/config/views/App.js#L171
        fileBlacklist: [/\.map$/, /hot-update\.js$/, /runtime\..*\.js$/],
        include: 'initial'
      }
    ])
    // ç‰ˆæœ¬æ›´æ–°æé†’æ’ä»¶
    config.plugin('femessage-update-popup').use(UpdatePopup, [{
      auto: true
    }])
    // when there are many pages, it will cause too many meaningless requests
    config.plugins.delete('prefetch')

    // set svg-sprite-loader
    config.module
      .rule('svg')
      .exclude.add(resolve('src/icons'))
      .end()
    config.module
      .rule('icons')
      .test(/\.svg$/)
      .include.add(resolve('src/icons'))
      .end()
      .use('svg-sprite-loader')
      .loader('svg-sprite-loader')
      .options({
        symbolId: 'icon-[name]'
      })
      .end()

    config
      .when(process.env.NODE_ENV !== 'development',
        config => {
          config
            .plugin('ScriptExtHtmlWebpackPlugin')
            .after('html')
            .use('script-ext-html-webpack-plugin', [{
            // `runtime` must same as runtimeChunk name. default is `runtime`
              inline: /runtime\..*\.js$/
            }])
            .end()
          config
            .optimization.splitChunks({
              chunks: 'all',
              cacheGroups: {
                libs: {
                  name: 'chunk-libs',
                  test: /[\\/]node_modules[\\/]/,
                  priority: 10,
                  chunks: 'initial' // only package third parties that are initially dependent
                },
                elementUI: {
                  name: 'chunk-elementUI', // split elementUI into a single package
                  priority: 20, // the weight needs to be larger than libs and app or it will be packaged into libs or app
                  test: /[\\/]node_modules[\\/]_?element-ui(.*)/ // in order to adapt to cnpm
                },
                commons: {
                  name: 'chunk-commons',
                  test: resolve('src/components'), // can customize your rules
                  minChunks: 3, //  minimum common number
                  priority: 5,
                  reuseExistingChunk: true
                }
              }
            })
          // https:// webpack.js.org/configuration/optimization/#optimizationruntimechunk
          config.optimization.runtimeChunk('single')
        }
      )

    config.plugin('loadshReplace').use(new LodashModuleReplacementPlugin())
  },
  css: {
    loaderOptions: {
      sass: {
        prependData: `@import "~@/styles/variables.scss";`
      }
    }
  }
}

```

#### **`configureWebpack`  å±æ€§**

> Type: `Object | Function`
>
> webpack é…ç½®å±æ€§ï¼š
>
> * å¦‚æœè¿™ä¸ªå€¼æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œåˆ™ä¼šé€šè¿‡ [webpack-merge](https://github.com/survivejs/webpack-merge) åˆå¹¶åˆ°æœ€ç»ˆçš„é…ç½®ä¸­ã€‚
>
> * å¦‚æœè¿™ä¸ªå€¼æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåˆ™ä¼šæ¥æ”¶è¢«è§£æçš„é…ç½®ä½œä¸ºå‚æ•°ã€‚è¯¥å‡½æ•°æ—¢å¯ä»¥ä¿®æ”¹é…ç½®å¹¶ä¸è¿”å›ä»»ä½•ä¸œè¥¿ï¼Œä¹Ÿå¯ä»¥è¿”å›ä¸€ä¸ªè¢«å…‹éš†æˆ–åˆå¹¶è¿‡çš„é…ç½®ç‰ˆæœ¬ã€‚

**åŸç†**

`configureWebpack` å±æ€§åœ¨ CLI æœåŠ¡å¯¹è±¡ `Service` ç±»åˆå§‹åŒ– `init` æ–¹æ³•ä¸­ï¼Œé€šè¿‡å°†ç”¨æˆ·é…ç½®çš„ webpack é¡¹å­˜å‚¨åˆ° `webpackRawConfigFns`ï¼Œæœ€åé€šè¿‡ [webpack-merge](https://github.com/survivejs/webpack-merge) åˆå¹¶åˆ°æœ€ç»ˆçš„é…ç½®ä¸­ï¼š

![image-20240131135803195](../images/vue-cli-webpacké…ç½®é¡¹.png)

### **é“¾å¼æ“ä½œ (é«˜çº§)**

Vue CLI å†…éƒ¨çš„ webpack é…ç½®æ˜¯é€šè¿‡ [webpack-chain](https://github.com/mozilla-neutrino/webpack-chain) ç»´æŠ¤çš„ã€‚

è¿™ä¸ªåº“æä¾›äº†ä¸€ä¸ª webpack åŸå§‹é…ç½®çš„ä¸Šå±‚æŠ½è±¡ï¼Œä½¿å…¶å¯ä»¥å®šä¹‰å…·åçš„ loader è§„åˆ™å’Œå…·åæ’ä»¶ï¼Œå¹¶æœ‰æœºä¼šåœ¨åæœŸè¿›å…¥è¿™äº›è§„åˆ™å¹¶å¯¹å®ƒä»¬çš„é€‰é¡¹è¿›è¡Œä¿®æ”¹ã€‚
é“¾å¼æ“ä½œé€šè¿‡  `vue.config.js` ä¸­çš„ `chainWebpack` å±æ€§é…ç½®ï¼š

#### **`chainWebpack` å±æ€§**

> Type: `Function`
>
> æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¼šæ¥æ”¶ä¸€ä¸ªåŸºäº [webpack-chain](https://github.com/mozilla-neutrino/webpack-chain) çš„ `ChainableConfig` å®ä¾‹ã€‚
>
> å…è®¸å¯¹å†…éƒ¨çš„ webpack é…ç½®è¿›è¡Œæ›´ç»†ç²’åº¦çš„ä¿®æ”¹ã€‚

 `chainWebpack` å±æ€§ä½¿ç”¨æ–¹å¼å‚è€ƒ [webpack-chain](https://github.com/mozilla-neutrino/webpack-chain) å®˜æ–¹æ–‡æ¡£ä½¿ç”¨æ–¹å¼ã€‚

####  **[webpack-chain](https://github.com/mozilla-neutrino/webpack-chain)** 

**webpack-chain æ˜¯ä»€ä¹ˆï¼Ÿ**

> `webpack-chain` æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œå®ƒé€šè¿‡é“¾å¼ API ç”Ÿæˆå’Œç®€åŒ– webpack 2-4 ç‰ˆæœ¬çš„é…ç½®çš„ä¿®æ”¹

**ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ webpack-chain ï¼Ÿ**

> Webpack-chain çš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³ webpack é…ç½®çš„é—®é¢˜ã€‚
>
> Webpack çš„é…ç½®è¿‡ç¨‹æå…¶å¤æ‚ï¼Œéœ€è¦è¾“å…¥å¤§é‡çš„ä¿¡æ¯æ¥ä¿è¯æ‰“åŒ…ç»“æœç¬¦åˆé¢„æœŸã€‚
>
> Webpack-chain é€šè¿‡æä¾›ä¸€ä¸ªé“¾å¼ API æ¥è§£å†³è¿™ä¸ªé—®é¢˜:
>
> 1. å®ƒå…è®¸ç”¨æˆ·ä»¥é“¾å¼æ–¹å¼åˆ›å»ºå’Œä¿®æ”¹ webpack é…ç½®ï¼Œè¿™ä½¿å¾—é…ç½®è¿‡ç¨‹æ›´åŠ ç›´è§‚å’Œæ˜“äºç®¡ç†ã€‚
> 2. API çš„ Key éƒ¨åˆ†å¯ä»¥ç”±ç”¨æˆ·æŒ‡å®šçš„åç§°å¼•ç”¨ï¼Œè¿™æœ‰åŠ©äºæ ‡å‡†åŒ–è·¨é¡¹ç›®çš„é…ç½®ä¿®æ”¹æ–¹å¼ã€‚



## **[æ¨¡å¼å’Œç¯å¢ƒå˜é‡](https://cli.vuejs.org/zh/guide/mode-and-env.html#æ¨¡å¼å’Œç¯å¢ƒå˜é‡)**

### **æ¨¡å¼**

**æ¨¡å¼**æ˜¯ Vue CLI é¡¹ç›®ä¸­ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ª Vue CLI é¡¹ç›®æœ‰ä¸‰ä¸ªæ¨¡å¼ï¼š

- å¼€å‘æ¨¡å¼ï¼š`development` å­—æ®µè¡¨ç¤ºï¼Œä½¿ç”¨ `vue-cli-service serve` å‘½ä»¤å¯åŠ¨ï¼›
- æµ‹è¯•æ¨¡å¼ï¼š`test` å­—æ®µè¡¨ç¤ºï¼Œä½¿ç”¨ `vue-cli-service test:unit` å‘½ä»¤å¯åŠ¨ï¼›
- ç”Ÿäº§æ¨¡å¼ï¼š`production` å­—æ®µè¡¨ç¤ºï¼Œä½¿ç”¨  `vue-cli-service build` å‘½ä»¤å¯åŠ¨ï¼›

ä½ å¯ä»¥é€šè¿‡ä¼ é€’ `--mode` é€‰é¡¹å‚æ•°ä¸ºå‘½ä»¤è¡Œè¦†å†™é»˜è®¤çš„æ¨¡å¼ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æƒ³è¦åœ¨æ„å»ºå‘½ä»¤ä¸­ä½¿ç”¨å¼€å‘ç¯å¢ƒå˜é‡ï¼š

```
vue-cli-service build --mode development
```

å½“è¿è¡Œ `vue-cli-service` å‘½ä»¤æ—¶ï¼Œæ‰€æœ‰çš„ç¯å¢ƒå˜é‡éƒ½ä»å¯¹åº”çš„[ç¯å¢ƒæ–‡ä»¶](https://cli.vuejs.org/zh/guide/mode-and-env.html#ç¯å¢ƒå˜é‡)ä¸­è½½å…¥ã€‚

é€šè¿‡ä»¥ä¸Š "serve å‘½ä»¤è§£æ" éƒ¨åˆ†å¯çŸ¥ï¼š`vue-cli-service` ä¸­ `serve` å’Œ `build` å‘½ä»¤æœ€ç»ˆå®é™…æ‰§è¡Œ `server.js` å’Œ `build` æ’ä»¶ï¼Œæ’ä»¶ç›®å½•å¦‚ä¸‹ï¼š![image-20240131160413569](../images/vue-cli-service-æ’ä»¶.png)



### **ç¯å¢ƒå˜é‡**

é¡¹ç›®æ ¹ç›®å½•ä¸­æ”¾ç½®ä¸‹åˆ—æ–‡ä»¶æ¥æŒ‡å®šç¯å¢ƒå˜é‡ï¼š

```shell
.env                # åœ¨æ‰€æœ‰çš„ç¯å¢ƒä¸­è¢«è½½å…¥
.env.local          # åœ¨æ‰€æœ‰çš„ç¯å¢ƒä¸­è¢«è½½å…¥ï¼Œä½†ä¼šè¢« git å¿½ç•¥
.env.[mode]         # åªåœ¨æŒ‡å®šçš„æ¨¡å¼ä¸­è¢«è½½å…¥
.env.[mode].local   # åªåœ¨æŒ‡å®šçš„æ¨¡å¼ä¸­è¢«è½½å…¥ï¼Œä½†ä¼šè¢« git å¿½ç•¥
```

ä¸€ä¸ªç¯å¢ƒæ–‡ä»¶åªåŒ…å«ç¯å¢ƒå˜é‡çš„â€œé”®=å€¼â€å¯¹ï¼š

```shell
FOO=bar
VUE_APP_NOT_SECRET_CODE=some_value
```



### **æºç åˆ†æ**

æ¨¡å¼å’Œç¯å¢ƒå˜é‡åˆå§‹åŒ–åœ¨ Service ç±»åˆå§‹åŒ–æ—¶ `init` æ–¹æ³•ä¸­ï¼Œé€šè¿‡ `loadEnv` æ–¹æ³•åˆå§‹åŒ–ï¼š

![image-20240131144841437](../images/vue-cli-service-loadEnv.png)

`loadEnv` æ–¹æ³•å®šä¹‰ï¼š

![image-20240131145425965](../images/loadEnvæ–¹æ³•.png)





## **å‚è€ƒèµ„æ–™**

[vue-cli](https://cli.vuejs.org/zh/guide/)

[å‰–æ Vue CLI å®ç°åŸç†](https://cloud.tencent.com/developer/article/1781202#:~:text=Vue%20CLI%20%E6%98%AF%E4%B8%80%E4%B8%AA%E5%9F%BA%E4%BA%8E%20Vue.js%20%E8%BF%9B%E8%A1%8C%E5%BF%AB%E9%80%9F%E5%BC%80%E5%8F%91%E7%9A%84%E5%AE%8C%E6%95%B4%E7%B3%BB%E7%BB%9F%EF%BC%8C%E6%8F%90%E4%BE%9B%E4%BA%86%E7%BB%88%E7%AB%AF%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7%E3%80%81%E9%9B%B6%E9%85%8D%E7%BD%AE%E8%84%9A%E6%89%8B%E6%9E%B6%E3%80%81%E6%8F%92%E4%BB%B6%E4%BD%93%E7%B3%BB%E3%80%81%E5%9B%BE%E5%BD%A2%E5%8C%96%E7%AE%A1%E7%90%86%E7%95%8C%E9%9D%A2%E7%AD%89%E3%80%82,%E6%9C%AC%E6%96%87%E6%9A%82%E4%B8%94%E5%8F%AA%E5%88%86%E6%9E%90%20%E9%A1%B9%E7%9B%AE%E5%88%9D%E5%A7%8B%E5%8C%96%20%E9%83%A8%E5%88%86%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AF%E7%BB%88%E7%AB%AF%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7%E7%9A%84%E5%AE%9E%E7%8E%B0%E3%80%82%200.%20%E7%94%A8%E6%B3%95)